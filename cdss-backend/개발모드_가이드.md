# 개발 모드 가이드

**CDSS Backend - 보안 설정 토글**

개발 중에는 빠른 테스트를 위해 인증/권한 검증을 우회할 수 있습니다.

---

## 🔓 개발 모드 (보안 비활성화)

### 설정 방법

`.env` 파일:
```env
ENABLE_SECURITY=False
```

또는 환경 변수가 없으면 **기본값이 False**입니다.

### 개발 모드 효과

```
✅ 모든 API 엔드포인트 접근 가능 (인증 불필요)
✅ 권한 검증 우회 (IsDoctor, IsAdmin 등 무시)
✅ 빠른 테스트 및 디버깅 가능
⚠️  감사 로그는 부분적으로 기록 (LOGIN/LOGOUT만)
```

### 사용 예시

**인증 없이 API 호출 가능:**
```bash
# 토큰 없이 호출 가능!
curl http://localhost:8000/api/acct/me/

# 모든 사용자 정보 조회 가능
curl http://localhost:8000/api/acct/users/
```

**권한 검증 우회:**
```python
# acct/views.py
@api_view(['GET'])
@permission_classes([IsAdmin])  # ← 개발 모드에서는 무시됨
def admin_only_view(request):
    # 개발 모드: 누구나 접근 가능
    # 프로덕션 모드: Admin만 접근
    return Response({"message": "Admin only"})
```

---

## 🔒 프로덕션 모드 (보안 활성화)

### 설정 방법

`.env` 파일:
```env
ENABLE_SECURITY=True
```

### 프로덕션 모드 효과

```
🔒 모든 API 엔드포인트 인증 필수
🔒 역할 기반 권한 검증 (RBAC)
🔒 감사 로그 전체 기록
⚠️  프로덕션 배포 시 필수!
```

### 사용 예시

**인증 필수:**
```bash
# ❌ 토큰 없으면 401 Unauthorized
curl http://localhost:8000/api/acct/me/

# ✅ 토큰과 함께 호출
curl -H "Authorization: Token <token>" http://localhost:8000/api/acct/me/
```

**권한 검증 적용:**
```python
@api_view(['GET'])
@permission_classes([IsAdmin])  # ← Admin만 접근 가능
def admin_only_view(request):
    # 프로덕션 모드: Admin이 아니면 403 Forbidden
    return Response({"message": "Admin only"})
```

---

## 📋 모드별 비교

| 기능 | 개발 모드 (False) | 프로덕션 모드 (True) |
|------|------------------|---------------------|
| **인증** | 불필요 ✅ | 필수 🔒 |
| **권한 검증** | 우회 ✅ | 적용 🔒 |
| **감사 로그** | 부분 (LOGIN/LOGOUT) | 전체 🔒 |
| **API 접근** | 자유 ✅ | 제한 🔒 |
| **토큰 만료** | 24시간 | 1시간 |
| **용도** | 개발/테스트 | 프로덕션 배포 |

---

## 🚀 실전 사용법

### Case 1: 처음 개발 시작

```bash
# .env 파일 확인
cat .env
# ENABLE_SECURITY=False  ← 기본값

# Django 실행
python manage.py runserver

# 브라우저에서 확인
# http://localhost:8000/api/acct/me/  ← 바로 접근 가능!
```

### Case 2: API 테스트 (Postman/Curl)

**개발 모드 (빠르게 테스트):**
```bash
# 토큰 없이 바로 테스트
curl http://localhost:8000/api/acct/users/
curl http://localhost:8000/api/emr/patients/
```

**프로덕션 모드 (실제 환경 테스트):**
```bash
# 1. 로그인
TOKEN=$(curl -X POST http://localhost:8000/api/acct/login/ \
  -H "Content-Type: application/json" \
  -d '{"username":"admin1","password":"admin123"}' \
  | jq -r '.token')

# 2. 토큰으로 API 호출
curl -H "Authorization: Token $TOKEN" \
  http://localhost:8000/api/acct/users/
```

### Case 3: React 프론트엔드 개발

**개발 모드:**
```javascript
// axios 설정 간소화
const api = axios.create({
  baseURL: 'http://localhost:8000/api',
  // 토큰 헤더 불필요!
});

// 바로 API 호출
api.get('/acct/me/').then(res => console.log(res.data));
```

**프로덕션 모드:**
```javascript
// 토큰 인증 필수
const api = axios.create({
  baseURL: 'http://localhost:8000/api',
});

api.interceptors.request.use(config => {
  const token = localStorage.getItem('token');
  if (token) {
    config.headers.Authorization = `Token ${token}`;
  }
  return config;
});
```

---

## ⚠️ 주의사항

### 1. 프로덕션 배포 시 필수 확인!

```bash
# ❌ 절대 금지!
# 프로덕션에서 ENABLE_SECURITY=False는 보안 위험!

# ✅ 프로덕션 .env 설정
ENABLE_SECURITY=True
DEBUG=False
```

### 2. Git에 .env 파일 커밋 금지

```bash
# .gitignore에 추가 확인
echo ".env" >> .gitignore
```

### 3. 팀원 간 설정 공유

```bash
# .env.example은 Git에 포함 (템플릿)
git add .env.example

# .env는 각자 로컬에서 복사
cp .env.example .env
```

---

## 🔄 모드 전환 방법

### 개발 → 프로덕션

```bash
# 1. .env 수정
sed -i 's/ENABLE_SECURITY=False/ENABLE_SECURITY=True/' .env

# 2. Django 재시작
python manage.py runserver

# 3. 서버 로그 확인
# 🔒 SECURITY MODE: ENABLED
#    - Authentication: REQUIRED
#    - Permissions: ENFORCED
#    - Audit Log: ENABLED
```

### 프로덕션 → 개발

```bash
# 1. .env 수정
sed -i 's/ENABLE_SECURITY=True/ENABLE_SECURITY=False/' .env

# 2. Django 재시작
python manage.py runserver

# 3. 서버 로그 확인
# ⚠️  SECURITY MODE: DISABLED (DEVELOPMENT)
#    - Authentication: BYPASSED
#    - Permissions: BYPASSED
#    - Audit Log: PARTIAL
```

---

## 📝 코드에서 보안 모드 확인

### views.py에서 조건부 처리

```python
from django.conf import settings

@api_view(['GET'])
def my_view(request):
    if settings.ENABLE_SECURITY:
        # 프로덕션 로직: 권한 엄격 검증
        if not request.user.is_admin:
            return Response({'error': 'Admin only'}, status=403)
    else:
        # 개발 로직: 경고만 출력
        print("⚠️ 개발 모드: 권한 검증 우회")

    return Response({"message": "Success"})
```

### 감사 로그 조건부 기록

```python
from audit.client import AuditClient
from django.conf import settings

@api_view(['POST'])
def critical_action(request):
    # 프로덕션에서만 감사 로그
    if settings.ENABLE_SECURITY:
        AuditClient.log_event(...)

    # 실제 로직
    return Response({"status": "ok"})
```

---

## 🧪 테스트 시나리오

### 시나리오 1: 빠른 API 개발

```python
# 개발자가 새로운 API 작성
@api_view(['GET'])
@permission_classes([IsDoctor])  # 나중에 적용할 권한
def new_api(request):
    return Response({"data": "test"})

# .env: ENABLE_SECURITY=False
# → 권한 무시, 바로 테스트 가능!
# curl http://localhost:8000/api/new-api/
```

### 시나리오 2: 권한 로직 테스트

```bash
# 1. 개발 모드에서 API 작성
# ENABLE_SECURITY=False

# 2. 기능 완성 후 보안 테스트
# ENABLE_SECURITY=True로 변경

# 3. 역할별 접근 테스트
curl -H "Authorization: Token <doctor_token>" /api/new-api/  # ✅
curl -H "Authorization: Token <patient_token>" /api/new-api/  # ❌ 403
```

---

## 📚 관련 파일

- `cdss_backend/settings.py` - 보안 토글 로직
- `cdss_backend/settings_security.py` - 보안 헬퍼 함수
- `.env` - 환경 변수 (로컬 설정)
- `.env.example` - 환경 변수 템플릿

---

## ❓ FAQ

### Q1. 개발 모드에서도 로그인 API는 동작하나요?
**A:** 네, 로그인/로그아웃 API는 정상 동작합니다. 단, 토큰 없이도 다른 API를 호출할 수 있습니다.

### Q2. 감사 로그는 개발 모드에서 기록되나요?
**A:** LOGIN/LOGOUT만 기록됩니다. CREATE/READ/UPDATE/DELETE는 기록되지 않습니다.

### Q3. 프로덕션 모드로 전환 시 재배포가 필요한가요?
**A:** 아니요, `.env` 파일만 수정하고 Django를 재시작하면 됩니다.

### Q4. Docker 환경에서는 어떻게 설정하나요?
**A:** `docker-compose.yml`의 `environment` 섹션에 `ENABLE_SECURITY=true` 추가.

---

**개발 중에는 편리하게, 배포 시에는 안전하게!** 🚀🔒
