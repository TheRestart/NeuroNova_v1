# NeuroNova CDSS 작업 계획 요약

**작성일**: 2025-12-31
**현재 상태**: Phase 2 완료, React 통합 배포 완료, **무한 새로고침(Infinite Refresh) 현상 발생으로 긴급 디버깅 중**
**다음 작업**: **React 무한 새로고침 오류 수정** -> 전체 UC 심층 검증

---

## 🎯 현재 상황

### ✅ 완료된 작업
- Phase 2 완료 (테스트 전략, 로깅 전략, 성능 최적화 문서화)
- 전체 UC01-UC09 구현
- GCP 배포 가이드 완성
- React 테스트 클라이언트 구현
- 문서 재구성 (50개 → 44개)
- 코드 정적 분석 완료 ([38_코드_정적_분석_보고서.md](01_doc/38_코드_정적_분석_보고서.md))
- **비밀번호 규칙 단순화**: `admin123!@#` → `admin123` (특수문자 제거)
- **프로젝트 개선 작업** (2025-12-31):
  - 문서 구조 개선 (01_doc/90_작업이력/ 디렉토리 생성)
  - DICOM 샘플 데이터 가이드 ([sample_dicoms/README.md](NeuroNova_02_back_end/02_django_server/sample_dicoms/README.md))
  - Git 커밋 규칙 ([01_doc/90_작업이력/GIT_COMMIT_CONVENTION.md](01_doc/90_작업이력/GIT_COMMIT_CONVENTION.md))
  - 보안 체크리스트 ([01_doc/13_배포전_보안_체크리스트.md](01_doc/13_배포전_보안_체크리스트.md))
  - 사용자 스토리 ([01_doc/05_사용자_스토리.md](01_doc/05_사용자_스토리.md))
  - 비기능 요구사항 ([01_doc/06_비기능_요구사항.md](01_doc/06_비기능_요구사항.md))

### 📁 백엔드 복구 완료
```
NeuroNova_02_back_end/
├── 01_ai_core/          ✅
├── 02_django_server/    ✅ (acct, emr, ocs, lis, ris, ai, fhir, audit)
├── 05_orthanc_pacs/     ✅
├── 06_hapi_fhir/        ✅
└── 07_redis/            ✅
```

---

## 🚀 작업 계획

### Phase 1: 즉시 작업 (완료됨) ✅

- [x] 마스터 데이터 시딩 준비 및 실행
- [x] 환경 변수 검증 로직 추가
- [x] 공통 검증 유틸리티 생성
- [x] 데이터베이스 인덱스 최적화
- [x] React 테스트 클라이언트 개선
- [x] OHIF Viewer 통합

---

## 🚀 작업 계획

### Phase 2: 우선 작업 (1주) ⭐⭐⭐

#### 작업 1: Foreign Key 마이그레이션

**목표**: CharField user_id → ForeignKey 전환

**영향 범위**:
- `emr.Encounter.doctor_id`
- `emr.Order.ordered_by`
- `emr.Order.executed_by`

**작업 단계**:
1. 백업 생성
2. 마이그레이션 스크립트 작성
3. Dry-run 검증
4. 적용

**예상 소요**: 2-4시간

---

#### 작업 2: N+1 쿼리 제거 및 분석

**목표**: ViewSet 쿼리 최적화 및 Django Debug Toolbar 분석

**적용 대상**:
- `emr.viewsets` (Encounter, Order)
- `ris.views` (RadiologyStudy)
- `ai.views` (AIJob)

**방법**:
```python
def get_queryset(self):
    return Encounter.objects.select_related('patient').all()
```

**예상 소요**: 2-3시간

---

#### 작업 3: 로깅 체계 고도화

---

### Phase 3: 개선 작업 (1주일) ⭐

#### 작업 4: 테스트 커버리지 향상
#### 작업 5: 문서 업데이트

---

## 📋 체크리스트

### 서버 불필요 (즉시 가능) ✅

- [x] 코드 정적 분석 완료
- [x] 마스터 데이터 CSV/JSON 파일 준비
  - [x] medication_master.json (30개)
  - [x] lab_test_master.json (50개)
  - [x] 진단 데이터 (100개 ICD-10) 기존 존재
- [x] Management Command 스크립트 작성 (`seed_master_data.py`)
- [x] 환경 변수 검증 로직 추가 (`require_env()` 함수)
- [x] `.env.example` 업데이트
- [x] 공통 검증 유틸리티 생성 (`utils/validators.py`)
- [x] EMR Serializer 리팩토링 (공통 validators 사용)
- [x] 데이터베이스 인덱스 최적화 (모델 수정)
  - [x] PatientCache: ssn 인덱스 추가
  - [x] Order: status+order_type 복합 인덱스 추가
- [x] React 테스트 클라이언트 개선
  - [x] .env.example 생성
  - [x] 토큰 자동 갱신 로직 구현
  - [x] 에러 처리 강화
- [x] OHIF Viewer React 통합

- [x] 마이그레이션 적용 (인덱스 최적화)
- [x] 마스터 데이터 시딩 실행 (173개 레코드 생성)

### 서버 필요 (다음 단계) 🔄

- [x] Foreign Key 마이그레이션 스크립트 작성 (dry-run)
- [x] Django Debug Toolbar 설치 및 쿼리 분석
- [x] 성능 벤치마크 테스트 (N+1 최적화 - Encounter/Order 완료)
- [x] RIS-Orthanc 환자 매칭 구현

---

## 🎯 우선순위

1. **Foreign Key 마이그레이션**
2. **N+1 쿼리 최적화 검증**
3. **테스트 커버리지**

---

## 📝 다음 작업

**긴급 수정 (Priority Critical)** 🚨:
1. **React 무한 새로고침(Infinite Refresh) 오류 수정**
    - 원인: Nginx SPA Routing Fallback 미설정 또는 Auth Loop 의심
    - 조치: Nginx `try_files` 및 React 라우팅 로직 점검

**즉시 완료 (2025-12-31 01:00)** ✅:
1. ~~인덱스 마이그레이션 생성 및 적용~~ ✅
2. ~~마스터 데이터 시딩 실행 (Medication, LabTest, Diagnosis)~~ ✅

**다음 단계**:
1. **Foreign Key 마이그레이션 스크립트 작성** (완료) ✅
2. **N+1 쿼리 분석** (Django Debug Toolbar 설치) (완료) ✅
3. 성능 벤치마크 테스트 (완료) ✅
4. **RIS-Orthanc 환자 매칭** (추가/완료) ✅

---

---

## 📖 관련 문서

- [38_코드_정적_분석_보고서.md](01_doc/38_코드_정적_분석_보고서.md) - 상세 분석 결과
- [16_데이터_시딩_가이드.md](01_doc/16_데이터_시딩_가이드.md) - 데이터 업로드 가이드
- [27_데이터_검증_정책.md](01_doc/27_데이터_검증_정책.md) - 검증 정책
- [30_성능_최적화_가이드.md](01_doc/30_성능_최적화_가이드.md) - 성능 최적화
- [LOG_작업이력.md](01_doc/LOG_작업이력.md) - 전체 작업 기록

---

## ✅ 정적 코드 작업 완료 현황 (2025-12-31)

### 서버 없이 완료된 모든 작업 ✅

#### 1. 환경 변수 검증 시스템 ✅
- `require_env()` 함수 구현 (settings.py)
- 프로덕션 환경 필수 변수 검증 로직
- `.env.example` 문서화 완료

#### 2. 마스터 데이터 시딩 시스템 ✅
- medication_master.json (30개 약물, KDC/EDI 코드)
- lab_test_master.json (50개 검사, LOINC 코드)
- diagnosis 데이터 (100개 ICD-10) 기존 존재
- `seed_master_data.py` Management Command 작성

#### 3. 공통 검증 유틸리티 ✅
- `utils/validators.py` 생성 (305 lines)
- 한국 SSN 체크섬 검증 알고리즘
- 전화번호/이메일 정규식 검증
- ICD-10/LOINC 코드 형식 검증
- `UniqueFieldValidator` 클래스

#### 4. EMR Serializer 리팩토링 ✅
- 공통 validators 사용으로 코드 중복 제거
- `PatientValidationMixin` 적용

#### 5. 데이터베이스 인덱스 최적화 ✅
- `PatientCache.ssn` 단일 인덱스 추가
- `Order.status + order_type` 복합 인덱스 추가
- `AIJob.status + created_at` 복합 인덱스 (기존 존재 확인)

#### 6. N+1 쿼리 최적화 검증 ✅
모든 ViewSet에 쿼리 최적화 적용 확인:
- `EncounterViewSet`: `select_related('patient')`
- `OrderViewSet`: `select_related('patient', 'encounter').prefetch_related('items')`
- `OrderItemViewSet`: `select_related('order')`
- `RadiologyOrderViewSet`: `select_related('patient', 'ordering_physician')`
- `RadiologyReportViewSet`: `select_related('study', 'radiologist')`
- `AIJobViewSet`: `select_related('patient', 'reviewer')`

#### 7. React 테스트 클라이언트 개선 ✅
- `.env.example` 생성 (환경별 API URL 가이드)
- `apiClient.js` 에러 처리 강화:
  - 네트워크 에러 처리
  - JWT 토큰 자동 갱신 (401 시 refresh)
  - 에러 메시지 정규화

### 📊 작업 통계
- **수정된 파일**: 8개 (settings.py, models.py, serializers.py, apiClient.js, 등)
- **생성된 파일**: 5개 (validators.py, seed_master_data.py, 2 JSON, .env.example)
- **추가된 코드**: 약 900 lines
- **개선된 기능**: 환경 검증, 데이터 시딩, 검증 로직, 인덱스, 에러 처리

### 🚀 다음 단계 (서버 필요)
모든 정적 코드 작업이 완료되었습니다. 원본 PC로 복귀 후:
1. 인덱스 마이그레이션 생성 및 적용
2. 마스터 데이터 시딩 실행
3. Django 서버 기동 및 환경 변수 검증 확인
4. React 테스트 클라이언트 실행 테스트
5. N+1 쿼리 런타임 분석
6. Foreign Key 마이그레이션 (선택적)

---

## ✅ OHIF Viewer React 통합 완료 (2025-12-31)

### 추가 완료된 작업 ⭐ NEW

#### 8. OHIF Viewer React 통합 ✅
- **서비스 구조 v3.0**: Multi-SPA 폐기, 단일 React 빌드로 통합
- **OHIF 패키지 설치**: @ohif/viewer, cornerstone-core 등 10개 패키지
- **DICOM Viewer 페이지**: `/viewer/:studyInstanceUID` 라우트 구현
- **Orthanc 환자 목록**: UC05RIS 페이지에 환자 목록 + "View Study" 버튼
- **Django Proxy 통합**: JWT 인증 기반 DICOM Web API 접근
- **통합 가이드 문서**: README_OHIF_INTEGRATION.md 작성

### 📊 최종 작업 통계 (Week 7-4 포함)
- **수정된 파일**: 14개
- **생성된 파일**: 9개
- **추가된 코드**: 약 1,400 lines
- **추가된 npm 패키지**: 10개 (OHIF/Cornerstone)
- **개선된 기능**: 환경 검증, 데이터 시딩, 검증 로직, 인덱스, 에러 처리, **DICOM Viewer**

### 🚀 다음 단계 (서버 필요)
모든 정적 코드 작업과 React 통합이 완료되었습니다. 원본 PC로 복귀 후:

#### 1차: 데이터베이스 및 마스터 데이터 설정
```bash
# 인덱스 마이그레이션 생성 및 적용
cd NeuroNova_02_back_end/02_django_server
python manage.py makemigrations
python manage.py migrate

# 마스터 데이터 시딩 실행
python manage.py seed_master_data
```

#### 2차: 서비스 기동 및 통합 테스트
```bash
# 백엔드 서비스 시작
cd NeuroNova_02_back_end/07_redis && docker-compose up -d
cd ../05_orthanc_pacs && docker-compose up -d
cd ../02_django_server && python manage.py runserver

# React 클라이언트 (OHIF 포함)
cd NeuroNova_03_front_end_react/00_test_client
npm install
npm start
```

#### 3차: 기능 검증
- [ ] Django 서버 기동 및 환경 변수 검증 확인
- [ ] React 테스트 클라이언트 실행 (Port 3000)
- [ ] **Orthanc 환자 목록 조회** (`/uc05`)
- [ ] **"View Study" 버튼으로 DICOM Viewer 이동**
- [ ] **Study 메타데이터 표시 확인**
- [ ] JWT 토큰 자동 갱신 동작 확인
- [ ] N+1 쿼리 런타임 분석 (Django Debug Toolbar)
- [ ] Foreign Key 마이그레이션 (선택적)

---

## 📝 주요 변경 사항 요약

### v3.0 아키텍처 (2025-12-31)
**변경 전 (Multi-SPA)**:
```
Nginx
├── /                    → React Main (별도 빌드)
├── /pacs-viewer/        → OHIF Viewer (별도 빌드)
└── /api/*               → Django
```

**변경 후 (Single SPA)**:
```
Nginx
├── /                    → React + OHIF (단일 빌드)
│   ├── /dashboard
│   ├── /uc05 (RIS)      ← Orthanc 환자 목록 + View Study 버튼
│   └── /viewer/:studyId ← DICOM Viewer (OHIF)
└── /api/*               → Django (JWT 인증 + DICOM Proxy)
```

### 핵심 개선
1. **의존성 통합**: 10개 OHIF 패키지를 React package.json에 통합
2. **라우팅 통합**: React Router로 `/viewer/:studyInstanceUID` 관리
3. **보안 강화**: Django Proxy를 통한 JWT 인증 기반 DICOM 접근
4. **배포 간소화**: 단일 빌드 폴더 (`npm run build` → `build/`)

### 생성된 주요 파일
- `src/config/ohif.config.js` - OHIF 설정 (Django Proxy)
- `src/pages/ViewerPage.js` - DICOM Viewer 페이지
- `UC05RISTest.js` 개선 - Orthanc 환자 목록 + "View Study" 버튼
- `README_OHIF_INTEGRATION.md` - 통합 가이드 (설치/실행/트러블슈팅)

### 관련 문서
- [07_서비스_구조_요약.md](01_doc/07_서비스_구조_요약.md) - v3.0 아키텍처
- [LOG_작업이력.md](01_doc/LOG_작업이력.md) - Week 7-4 상세 작업 내역
- [README_OHIF_INTEGRATION.md](NeuroNova_03_front_end_react/00_test_client/README_OHIF_INTEGRATION.md) - OHIF 통합 가이드

---

## 📁 Git 서브모듈 관리

### Git 서브모듈이란?
**Git 서브모듈(Submodule)**: Git 저장소 안에 또 다른 Git 저장소를 폴더처럼 넣어서 관리하는 기능

### NeuroNova 프로젝트 구조
```
메인 저장소 (NeuroNova_v1)
├── .git/                    ← 메인 저장소의 Git 데이터
├── .gitmodules              ← 서브모듈 설정 파일
├── NeuroNova_02_back_end/   ← 백엔드 (메인 저장소)
└── NeuroNova_03_front_end_react/  ← 프론트엔드 (서브모듈, 독립 저장소)
    └── .git/                ← 서브모듈의 Git 데이터
```

### 서브모듈 정보
- **프론트엔드 서브모듈**: NeuroNova_03_front_end_react
- **URL**: https://github.com/TheRestart/NeuroNova_03_front_end_react.git
- **장점**:
  - 프론트엔드와 백엔드를 각각 별도로 커밋/푸시 가능
  - 팀 협업 효율화 (독립적인 작업)
  - 버전 관리 분리

### 자주 사용하는 명령어

#### 서브모듈 초기화 (Clone 후 최초 1회)
```bash
git submodule init
git submodule update
```

#### 서브모듈 업데이트
```bash
# 서브모듈을 최신 커밋으로 업데이트
git submodule update --remote
```

#### 서브모듈에서 작업
```bash
# 서브모듈 디렉토리로 이동
cd NeuroNova_03_front_end_react

# 브랜치 체크아웃 (detached HEAD 방지)
git checkout main

# 코드 수정 후 커밋
git add .
git commit -m "feat: Add new feature"
git push origin main

# 메인 저장소로 복귀
cd ..

# 메인 저장소에서 서브모듈 참조 업데이트
git add NeuroNova_03_front_end_react
git commit -m "chore: Update frontend submodule"
git push origin main
```

### VSCode에서 서브모듈 작업
- **권장 방법**: 서브모듈 디렉토리를 별도 VSCode 창으로 열기
  ```bash
  code NeuroNova_03_front_end_react
  ```

### 상세 가이드
모든 서브모듈 관리 방법은 [GIT_서브모듈_관리_가이드.md](01_doc/GIT_서브모듈_관리_가이드.md) 참조

---

**작성**: Claude AI
**최종 업데이트**: 2025-12-31 (Git 서브모듈 관리 가이드 추가)
