# ê°ì²´ ìƒì„± ë²•ì¹™ ë° ë ˆì´ì–´ ì•„í‚¤í…ì²˜ ê°€ì´ë“œ (v7.0)

ì´ ë¬¸ì„œëŠ” CDSS ë° ê´€ë ¨ ì„œë¹„ìŠ¤ ê°œë°œ ì‹œ ì¤€ìˆ˜í•´ì•¼ í•  ê°ì²´ ë ˆì´ì–´ êµ¬ì„± ê·œì¹™ì„ ì •ì˜í•©ë‹ˆë‹¤.
ëª¨ë“  ì½”ë“œëŠ” ì•„ëž˜ ì •ì˜ëœ ë ˆì´ì–´ì˜ **ì—­í• (Do)**ê³¼ **ê·œì œì‚¬í•­(Don't)**ì„ ì—„ê²©ížˆ ë”°ë¦…ë‹ˆë‹¤.

---

## 1. Controller (API ì§„ìž…ì )
HTTP ìš”ì²­ì„ ìˆ˜ì‹ í•˜ê³  ì‘ë‹µì„ ë°˜í™˜í•˜ëŠ” ìœ ì¼í•œ ì°½êµ¬ìž…ë‹ˆë‹¤.

### âœ… ê¸°ëŠ¥ (Responsibilities)
* **ì¸ì¦/ê¶Œí•œ í™•ì¸:** ìš”ì²­ìžì— ëŒ€í•œ ì ‘ê·¼ ê¶Œí•œì„ ê²€ì¦í•©ë‹ˆë‹¤.
* **DTO ë³€í™˜:** ìš”ì²­ JSONì„ `Request DTO`ë¡œ ë³€í™˜í•˜ê³  ìœ íš¨ì„±ì„ ê²€ì¦í•©ë‹ˆë‹¤.
* **Service í˜¸ì¶œ:** ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ìˆ˜í–‰ì„ ìœ„í•´ Service ë ˆì´ì–´ë¥¼ í˜¸ì¶œí•©ë‹ˆë‹¤.
* **ì‘ë‹µ ë°˜í™˜:** Serviceì˜ ê²°ê³¼ë¥¼ `Response DTO`ë¡œ ë³€í™˜í•˜ì—¬ JSON í˜•íƒœë¡œ ì‘ë‹µí•©ë‹ˆë‹¤.

### ðŸš« ê·œì œì‚¬í•­ (Don't)
* **Microì„œë²„ ì§ì ‘ í˜¸ì¶œ ê¸ˆì§€:** OpenEMR, Orthanc, HAPI ë“± ì™¸ë¶€ ì„œë²„ í†µì‹ ì€ ì ˆëŒ€ ìˆ˜í–‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Client ë ˆì´ì–´ ìœ„ìž„)
* **DB ì§ì ‘ ì ‘ê·¼ ê¸ˆì§€:** ë°ì´í„° ì¡°íšŒ ë° ì €ìž¥ì„ ì§ì ‘ ìˆ˜í–‰í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Repo ë ˆì´ì–´ ìœ„ìž„)
* **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ êµ¬í˜„ ê¸ˆì§€:** ë§¤í•‘, ì •ì±… ê²°ì •, ê·œì¹™ ì²˜ë¦¬ëŠ” ì´ê³³ì—ì„œ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Service ë ˆì´ì–´ ìœ„ìž„)

---

## 2. DTO (Data Transfer Object)
ë ˆì´ì–´ ê°„ ë°ì´í„° êµí™˜ì„ ìœ„í•œ ê³„ì•½(Contract) ê°ì²´ìž…ë‹ˆë‹¤.

### âœ… ê¸°ëŠ¥ ë° ìž¥ì 
* **ìž…/ì¶œë ¥ í”„ë¡œí† ì½œ ì¼ë°˜í™”:** ë ˆì´ì–´ ê°„ ì£¼ê³ ë°›ëŠ” ë°ì´í„°ì˜ í‘œì¤€ í˜•ì‹ì„ ì •ì˜í•©ë‹ˆë‹¤.
* **í”„ë ˆìž„ì›Œí¬ ë…ë¦½ì„±:** Service ë ˆì´ì–´ê°€ Django/DRF ë“± ì›¹ í”„ë ˆìž„ì›Œí¬ì— ì¢…ì†ë˜ì§€ ì•Šë„ë¡ ê²©ë¦¬í•©ë‹ˆë‹¤.
* **í…ŒìŠ¤íŠ¸ ìš©ì´ì„±:** Service ë¡œì§ì„ ì›¹ ì„œë²„ êµ¬ë™ ì—†ì´ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìžˆê²Œ í•©ë‹ˆë‹¤.
* **ë³€ê²½ í¡ìˆ˜:** ì™¸ë¶€ ì‹œìŠ¤í…œ(OpenEMR, Orthanc ë“±)ì˜ ì‘ë‹µ í¬ë§·ì´ ë³€ê²½ë˜ì–´ë„ DTO/Mapperì—ì„œ ë³€ê²½ ì‚¬í•­ì„ í¡ìˆ˜í•˜ì—¬ ë‚´ë¶€ ë¡œì§ì„ ë³´í˜¸í•©ë‹ˆë‹¤.

---

## 3. Service (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì˜ ì¤‘ì‹¬)
ì‹¤ì§ˆì ì¸ ì—…ë¬´ë¥¼ ì²˜ë¦¬í•˜ëŠ” ê³³ìœ¼ë¡œ, ë‹¤ìŒ 3ê°€ì§€ ì—­í• (ë˜ëŠ” ì¡°í•©)ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤.

### âœ… ì—­í•  ìœ í˜•
1.  **Proxy Service**
    * ë‹¨ìˆœížˆ ì™¸ë¶€ ì„œë²„ APIë¥¼ ëŒ€ì‹  í˜¸ì¶œí•˜ì—¬ ê²°ê³¼ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤.
    * ìºì‹± ì—†ì´ ë°ì´í„°ë¥¼ í†µê³¼(Pass-through)ì‹œí‚¤ëŠ” í˜•íƒœë„ ê°€ëŠ¥í•©ë‹ˆë‹¤.
2.  **Sync Service**
    * ì™¸ë¶€ ë°ì´í„°(OpenEMR, Orthanc, HAPI)ë¥¼ ì¡°íšŒí•˜ì—¬ CDSS Cache DB(Repo)ì— ë™ê¸°í™”í•©ë‹ˆë‹¤.
    * ì´í›„ ë™ì¼ ë°ì´í„° ìš”ì²­ ì‹œ ì™¸ë¶€ í˜¸ì¶œ ì—†ì´ Repo(Cache)ì—ì„œ ë¹ ë¥´ê²Œ ì œê³µí•©ë‹ˆë‹¤.
3.  **Mapping Service**
    * ì™¸ë¶€ì˜ ë³µìž¡í•œ í¬ë§·(FHIR ë“±)ì„ CDSS ë‚´ë¶€ ë„ë©”ì¸/DTOë¡œ ë³€í™˜í•©ë‹ˆë‹¤.

### ðŸš« ê·œì œì‚¬í•­ (Don't)
* **HTTP ìƒì„¸ êµ¬í˜„ ê¸ˆì§€:** URL, Header, Timeout ì²˜ë¦¬ ë“±ì€ ì§ì ‘ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. (Client ì‚¬ìš©)
* **SQL/Query ì§ì ‘ ìž‘ì„± ê¸ˆì§€:** DB ì ‘ê·¼ì€ ë°˜ë“œì‹œ Repoë¥¼ í†µí•´ì„œë§Œ ìˆ˜í–‰í•©ë‹ˆë‹¤.

---

## 4. Client (Microì„œë²„ API ì–´ëŒ‘í„°)
ì™¸ë¶€ ì‹œìŠ¤í…œê³¼ì˜ í†µì‹ ì„ ì „ë‹´í•˜ëŠ” ì–´ëŒ‘í„°ìž…ë‹ˆë‹¤.

### âœ… ê¸°ëŠ¥ (Responsibilities)
* **ì™¸ë¶€ API í˜¸ì¶œ:** OpenEMR, Orthanc, HAPI ë“± Microì„œë²„ë¡œ REST API ìš”ì²­ì„ ë³´ëƒ…ë‹ˆë‹¤.
* **í†µì‹  ìƒì„¸ ì²˜ë¦¬:** ìž¬ì‹œë„(Retry), íƒ€ìž„ì•„ì›ƒ(Timeout), ì¸ì¦ í† í° ê´€ë¦¬, ì—ëŸ¬ ì½”ë“œ ë³€í™˜ ë“±ì„ ì²˜ë¦¬í•©ë‹ˆë‹¤.
* **ì¶”ìƒí™” ì œê³µ:** Serviceê°€ HTTP í†µì‹ ì˜ êµ¬ì²´ì ì¸ ë‚´ìš©(Details)ì„ ëª°ë¼ë„ ë˜ë„ë¡ ê¸°ëŠ¥ì„ ìº¡ìŠí™”í•©ë‹ˆë‹¤.

---

## 5. Repo (Repository / Cache ì €ìž¥ì†Œ)
ë‚´ë¶€ ë°ì´í„°ë² ì´ìŠ¤(CDSS DB)ì— ëŒ€í•œ ì €ìž¥ ë° ì¡°íšŒë¥¼ ë‹´ë‹¹í•©ë‹ˆë‹¤.

### âœ… ê¸°ëŠ¥ (Responsibilities)
* **Cache ê´€ë¦¬:** ì™¸ë¶€ì—ì„œ ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ ë‚´ë¶€ DBì— ì €ìž¥(Caching)í•˜ê±°ë‚˜ ì¡°íšŒí•©ë‹ˆë‹¤.
* **ë°ì´í„° í™•ìž¥:** ì™¸ë¶€ ë°ì´í„°ì— ìš°ë¦¬ ì„œë¹„ìŠ¤ë§Œì˜ ë°ì´í„°ë¥¼ ë§ë¶™ì—¬(Extension) ê´€ë¦¬í•©ë‹ˆë‹¤.
* **Interface êµ¬ì„±:** DB ì ‘ê·¼ì„ ìœ„í•œ ì¸í„°íŽ˜ì´ìŠ¤ ë ˆì´ì–´ë¥¼ êµ¬ì„±í•˜ì—¬ ìž‘ì—…í•©ë‹ˆë‹¤.

### ðŸš« ê·œì œì‚¬í•­ (Don't)
* **ì™¸ë¶€ DB ì§ì ‘ ì ‘ê·¼ ê¸ˆì§€:** ì™¸ë¶€ ì„œë²„(OpenEMR ë“±)ì˜ DBì— ì§ì ‘ ì»¤ë„¥ì…˜ì„ ë§ºê±°ë‚˜ ì¿¼ë¦¬ë¥¼ ë‚ ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.

---

## ðŸ“Š ë ˆì´ì–´ ê°„ ë°ì´í„° íë¦„ (Architecture Flow)

```mermaid
flowchart TD
    Request[HTTP Request] --> Controller
    
    subgraph "Application Layer"
        Controller --> |DTO| Service
        Service --> |Mapping/Logic| Service
    end
    
    subgraph "Infrastructure Layer"
        Service --> |Data Access| Repo
        Service --> |API Call| Client
    end
    
    Repo <--> |CRUD| InternalDB[(CDSS Cache DB)]
    Client <--> |REST| External[(OpenEMR/Orthanc/HAPI)]
    
    Controller --> |JSON| Response[HTTP Response]