# 개발 가이드: 낙관적 락 및 멱등성 구현 지침

낙관적 락(`version`)과 멱등성(`X-Idempotency-Key`) 구현을 위해 백엔드와 프론트엔드 개발자가 각각 수행해야 할 핵심 업무 리스트입니다.

---

### 1. 백엔드 개발자 (Backend)

**A. 데이터베이스 및 모델링**

* **스키마 변경:** 대상 테이블에 `version` (정수형, Default=1) 필드를 추가하고 마이그레이션을 수행합니다.
* **API 명세 업데이트:**
* **Response:** 조회(GET) 및 수정 완료 응답에 `version` 필드를 포함시킵니다.
* **Request:** 수정(PUT/PATCH) 요청 시 `version` 필드를 필수 값으로 설정합니다.
* **Header:** 생성/수정/삭제 요청 시 `X-Idempotency-Key` 헤더를 받도록 명세를 정의합니다.

**B. 낙관적 락 로직 구현 (동시성 제어)**

* **업데이트 쿼리 수정:** 데이터 수정 시 `WHERE id = ? AND version = ?` 조건을 걸어 업데이트를 시도합니다.
* **버전 증가:** 업데이트 성공 시 `version` 값을 `+1` 증가시킵니다.
* **충돌 처리:** 업데이트된 행(Row)이 0개라면(버전 불일치), 즉시 `409 Conflict` 에러를 반환합니다.

**C. 멱등성 로직 구현 (중복 방지)**

* **저장소 구축:** 멱등성 키와 응답 데이터를 저장할 단기 저장소(Redis 등)를 구성합니다.
* **검증 로직 (미들웨어 권장):**
1. 요청 헤더의 `X-Idempotency-Key`를 확인합니다.
2. 저장소에 해당 키가 있으면, 로직을 수행하지 않고 **저장된 응답을 그대로 반환**합니다.
3. 키가 없으면 로직을 수행하고, 결과(응답 코드, 바디)를 키와 함께 저장소에 저장합니다.

---

### 2. 프론트엔드 개발자 (Frontend)

**A. 데이터 관리 (State Management)**

* **버전 보관:** 서버에서 데이터 조회(GET) 시 받은 `version` 값을 수정 화면의 상태(State)에 함께 저장해 둡니다. (사용자에게 보여줄 필요는 없음)

**B. API 요청 구현**

* **헤더 생성:** 저장/수정/삭제 버튼 클릭 시 고유한 `UUID`를 생성하여 `X-Idempotency-Key` 헤더에 담습니다.
* **버전 전송:** 수정 요청 시, 조회할 때 받아두었던 `version` 값을 Request Body에 포함하여 전송합니다.

**C. 에러 핸들링 및 UX**

* **409 Conflict 처리:** "다른 사용자가 이미 정보를 수정했습니다"라는 알림을 띄우고, **최신 데이터를 다시 조회(Re-fetch)**하여 화면을 갱신합니다.
* **재시도 로직:** 네트워크 타임아웃 등의 모호한 실패 시, 멱등성이 보장되므로 안심하고 **재시도(Retry) 로직**을 수행하거나 사용자에게 "다시 시도" 버튼을 제공합니다.
