# CDSS ì‹œìŠ¤í…œ ì„¸ë¶€ ê³„íšì„œ (Infrastructure & DevOps)

**ì‘ì„±ì¼**: 2025-12-19
**í”„ë¡œì íŠ¸ëª…**: Clinical Decision Support System (CDSS)
**ë¬¸ì„œ ëª©ì **: ì¸í”„ë¼ êµ¬ì„±, ë°°í¬ ì „ëµ, ëª¨ë‹ˆí„°ë§ ì²´ê³„ ìƒì„¸ ì„¤ê³„

---

## ëª©ì°¨
1. [ì¸í”„ë¼ ì•„í‚¤í…ì²˜](#1-ì¸í”„ë¼-ì•„í‚¤í…ì²˜)
2. [Docker ì»¨í…Œì´ë„ˆ êµ¬ì„±](#2-docker-ì»¨í…Œì´ë„ˆ-êµ¬ì„±)
3. [ë¹„ë™ê¸° ë©”ì‹œì§• ì‹œìŠ¤í…œ](#3-ë¹„ë™ê¸°-ë©”ì‹œì§•-ì‹œìŠ¤í…œ-rabbitmq)
4. [ë³´ì•ˆ ë° ë„¤íŠ¸ì›Œí¬](#4-ë³´ì•ˆ-ë°-ë„¤íŠ¸ì›Œí¬)
5. [ì™¸ë¶€ ì‹œìŠ¤í…œ ì—°ë™](#5-ì™¸ë¶€-ì‹œìŠ¤í…œ-ì—°ë™)
6. [ëª¨ë‹ˆí„°ë§ ë° ê´€ì¸¡ì„±](#6-ëª¨ë‹ˆí„°ë§-ë°-ê´€ì¸¡ì„±-observability)
7. [ë°°í¬ ì „ëµ](#7-ë°°í¬-ì „ëµ)
8. [ë°±ì—… ë° ì¬í•´ ë³µêµ¬](#8-ë°±ì—…-ë°-ì¬í•´-ë³µêµ¬)

---

## 1. ì¸í”„ë¼ ì•„í‚¤í…ì²˜

### 1.1 ì „ì²´ ì‹œìŠ¤í…œ êµ¬ì„±ë„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Cloudflare (CDN + HTTPS)                    â”‚
â”‚                         - DDoS Protection                           â”‚
â”‚                         - SSL/TLS Termination                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚ HTTPS (443)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Nginx (Reverse Proxy)                       â”‚
â”‚                         - Load Balancing                            â”‚
â”‚                         - Rate Limiting                             â”‚
â”‚                         - Static File Serving                       â”‚
â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚                  â”‚                  â”‚
   â”‚ /api/*           â”‚ /ws/*            â”‚ /static/*
   â”‚                  â”‚                  â”‚
â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚  Django     â”‚  â”‚  Django   â”‚  â”‚   React     â”‚
â”‚  REST API   â”‚  â”‚  Channels â”‚  â”‚   Build     â”‚
â”‚  (Gunicorn) â”‚  â”‚  (Daphne) â”‚  â”‚   (Nginx)   â”‚
â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚                 â”‚
   â”‚                 â”‚    âš ï¸ ë³´ì•ˆ: ì™¸ë¶€ ì‹œìŠ¤í…œ ì ‘ê·¼ì€ Djangoë¥¼ í†µí•´ì„œë§Œ!
   â”‚                 â”‚    - OpenEMR, Orthanc, HAPI FHIRëŠ” ì§ì ‘ ë…¸ì¶œ ê¸ˆì§€
   â”‚                 â”‚    - ëª¨ë“  ìš”ì²­ì€ Django ì¸ì¦/ê¶Œí•œ ê²€ì¦ í•„ìˆ˜
   â”‚                 â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                 â”‚
â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RabbitMQ (Message Broker)                     â”‚
â”‚                    - AI Job Queue                                  â”‚
â”‚                    - FHIR Sync Queue                               â”‚
â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚                                          â”‚
â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AI Server      â”‚                     â”‚  FHIR Worker      â”‚
â”‚  (Flask + GPU)  â”‚                     â”‚  (Celery)         â”‚
â”‚  - MRI ë¶„ì„      â”‚                     â”‚  - FHIR Sync      â”‚
â”‚  - Omics ë¶„ì„    â”‚                     â”‚  - Retry Logic    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â”‚
â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Persistent Storage Layer                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  MySQL/      â”‚  â”‚  Redis       â”‚  â”‚  MinIO (S3 Compatible)  â”‚ â”‚
â”‚  â”‚  MariaDB     â”‚  â”‚  - Cache     â”‚  â”‚  - AI Artifacts         â”‚ â”‚
â”‚  â”‚  - CDSS DB   â”‚  â”‚  - Sessions  â”‚  â”‚  - DICOM Thumbnails     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚                 â”‚                    â”‚
   â”‚                 â”‚                    â”‚
â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              External Systems (ìƒìš© ì„œë²„)                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  OpenEMR     â”‚  â”‚  Orthanc     â”‚  â”‚  HAPI FHIR             â”‚ â”‚
â”‚  â”‚  (EMR)       â”‚  â”‚  (PACS)      â”‚  â”‚  (HL7 FHIR)            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â”‚
   â”‚
â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Observability (ëª¨ë‹ˆí„°ë§)                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Prometheus  â”‚  â”‚  Grafana     â”‚  â”‚  Alertmanager           â”‚ â”‚
â”‚  â”‚  (Metrics)   â”‚  â”‚  (Dashboard) â”‚  â”‚  (Alerts)               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 ë„¤íŠ¸ì›Œí¬ êµ¬ì„±

**ì™¸ë¶€ ì ‘ê·¼ í¬íŠ¸**
- `443`: HTTPS (Cloudflare â†’ Nginx)
- `80`: HTTP (Redirect to 443)

**ë‚´ë¶€ í¬íŠ¸ (Docker Network)**
- `8000`: Django API (Gunicorn)
- `8001`: Django Channels (Daphne, WebSocket)
- `3306`: MySQL/MariaDB
- `6379`: Redis
- `5672`: RabbitMQ (AMQP)
- `15672`: RabbitMQ Management UI
- `5000`: AI Server (Flask)
- `9000`: MinIO (S3 API)
- `9090`: Prometheus
- `3000`: Grafana
- `8042`: Orthanc (DICOMweb API)
- `8080`: HAPI FHIR Server

---

## 2. Docker ì»¨í…Œì´ë„ˆ êµ¬ì„±

### 2.1 Docker Compose êµ¬ì¡°

```yaml
# docker-compose.yml
version: '3.9'

services:
  # ========== Frontend ==========
  nginx:
    image: nginx:alpine
    container_name: cdss-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./react/build:/usr/share/nginx/html/static
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - django-api
      - django-channels
    networks:
      - cdss-network
    restart: unless-stopped

  react-build:
    build: ./react
    container_name: cdss-react-build
    volumes:
      - ./react/build:/app/build
    command: npm run build
    networks:
      - cdss-network

  # ========== Backend ==========
  django-api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: cdss-django-api
    command: gunicorn cdss.wsgi:application --bind 0.0.0.0:8000 --workers 4
    volumes:
      - ./backend:/app
      - static_volume:/app/staticfiles
      - media_volume:/app/media
    environment:
      - DJANGO_SETTINGS_MODULE=cdss.settings.production
      - DATABASE_URL=mysql://cdss_user:${DB_PASSWORD}@mysql:3306/cdss_db
      - REDIS_URL=redis://redis:6379/0
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
    depends_on:
      - mysql
      - redis
      - rabbitmq
    networks:
      - cdss-network
    restart: unless-stopped

  django-channels:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: cdss-django-channels
    command: daphne -b 0.0.0.0 -p 8001 cdss.asgi:application
    volumes:
      - ./backend:/app
    environment:
      - DJANGO_SETTINGS_MODULE=cdss.settings.production
      - REDIS_URL=redis://redis:6379/1
    depends_on:
      - redis
    networks:
      - cdss-network
    restart: unless-stopped

  celery-worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: cdss-celery-worker
    command: celery -A cdss worker -l info -Q default,fhir,ai
    volumes:
      - ./backend:/app
    environment:
      - DJANGO_SETTINGS_MODULE=cdss.settings.production
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
    depends_on:
      - rabbitmq
      - mysql
    networks:
      - cdss-network
    restart: unless-stopped

  celery-beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: cdss-celery-beat
    command: celery -A cdss beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    volumes:
      - ./backend:/app
    environment:
      - DJANGO_SETTINGS_MODULE=cdss.settings.production
    depends_on:
      - rabbitmq
      - mysql
    networks:
      - cdss-network
    restart: unless-stopped

  # ========== AI Server ==========
  ai-server:
    build:
      context: ./ai-server
      dockerfile: Dockerfile
    container_name: cdss-ai-server
    command: python app.py
    volumes:
      - ./ai-server:/app
      - ai_models:/app/models
    environment:
      - FLASK_ENV=production
      - RABBITMQ_URL=amqp://guest:guest@rabbitmq:5672/
      - GPU_MEMORY_LIMIT=8GB
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    depends_on:
      - rabbitmq
    networks:
      - cdss-network
    restart: unless-stopped

  # ========== Message Broker ==========
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: cdss-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      - RABBITMQ_DEFAULT_USER=guest
      - RABBITMQ_DEFAULT_PASS=guest
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - cdss-network
    restart: unless-stopped

  # ========== Database ==========
  mysql:
    image: mysql:8.0
    container_name: cdss-mysql
    command: --default-authentication-plugin=mysql_native_password --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=cdss_db
      - MYSQL_USER=cdss_user
      - MYSQL_PASSWORD=${DB_PASSWORD}
    volumes:
      - mysql_data:/var/lib/mysql
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3306:3306"
    networks:
      - cdss-network
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: cdss-redis
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    ports:
      - "6379:6379"
    networks:
      - cdss-network
    restart: unless-stopped

  # ========== Object Storage ==========
  minio:
    image: minio/minio:latest
    container_name: cdss-minio
    command: server /data --console-address ":9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=${MINIO_PASSWORD}
    volumes:
      - minio_data:/data
    ports:
      - "9000:9000"
      - "9001:9001"
    networks:
      - cdss-network
    restart: unless-stopped

  # ========== Monitoring ==========
  prometheus:
    image: prom/prometheus:latest
    container_name: cdss-prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml
      - prometheus_data:/prometheus
    ports:
      - "9090:9090"
    networks:
      - cdss-network
    restart: unless-stopped

  grafana:
    image: grafana/grafana:latest
    container_name: cdss-grafana
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD}
      - GF_INSTALL_PLUGINS=grafana-piechart-panel
    volumes:
      - grafana_data:/var/lib/grafana
      - ./monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./monitoring/grafana/datasources:/etc/grafana/provisioning/datasources
    ports:
      - "3000:3000"
    depends_on:
      - prometheus
    networks:
      - cdss-network
    restart: unless-stopped

  alertmanager:
    image: prom/alertmanager:latest
    container_name: cdss-alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
    volumes:
      - ./monitoring/alertmanager.yml:/etc/alertmanager/alertmanager.yml
      - alertmanager_data:/alertmanager
    ports:
      - "9093:9093"
    networks:
      - cdss-network
    restart: unless-stopped

networks:
  cdss-network:
    driver: bridge

volumes:
  mysql_data:
  redis_data:
  rabbitmq_data:
  minio_data:
  ai_models:
  static_volume:
  media_volume:
  prometheus_data:
  grafana_data:
  alertmanager_data:
```

### 2.2 Dockerfile ì˜ˆì‹œ

**Django Backend**
```dockerfile
# backend/Dockerfile
FROM python:3.11-slim

WORKDIR /app

# ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    gcc \
    default-libmysqlclient-dev \
    pkg-config \
    && rm -rf /var/lib/apt/lists/*

# Python ì˜ì¡´ì„± ì„¤ì¹˜
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY . .

# ì •ì  íŒŒì¼ ìˆ˜ì§‘
RUN python manage.py collectstatic --noinput

EXPOSE 8000

CMD ["gunicorn", "cdss.wsgi:application", "--bind", "0.0.0.0:8000", "--workers", "4"]
```

**AI Server (Flask + GPU)**
```dockerfile
# ai-server/Dockerfile
FROM nvidia/cuda:11.8.0-cudnn8-runtime-ubuntu22.04

WORKDIR /app

# Python ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    python3.10 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# AI ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY . .

EXPOSE 5000

CMD ["python3", "app.py"]
```

---

## 3. ë¹„ë™ê¸° ë©”ì‹œì§• ì‹œìŠ¤í…œ (RabbitMQ)

### 3.1 Queue êµ¬ì¡°

**RabbitMQ Exchange & Queue ì„¤ê³„**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    RabbitMQ Exchanges                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                   â”‚
â”‚  â”‚  cdss.topic         â”‚  (Topic Exchange)                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                   â”‚
â”‚           â”‚                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚                  â”‚               â”‚              â”‚      â”‚
â”‚  â–¼                  â–¼               â–¼              â–¼      â”‚
â”‚  ai.job.create    ai.job.poll    fhir.sync    alert.send â”‚
â”‚  â”‚                  â”‚               â”‚              â”‚      â”‚
â”‚  â–¼                  â–¼               â–¼              â–¼      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ AI     â”‚  â”‚ AI     â”‚  â”‚ FHIR   â”‚  â”‚ Alert    â”‚       â”‚
â”‚  â”‚ Queue  â”‚  â”‚ Poller â”‚  â”‚ Queue  â”‚  â”‚ Queue    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 ì‚¬ìš© ì‚¬ë¡€

**1. AI ì¶”ë¡  ìš”ì²­ (ë¹„ë™ê¸°)**

```python
# Django Service â†’ RabbitMQ
from celery import shared_task
import pika

@shared_task(queue='ai')
def submit_ai_job(study_id, model_type):
    """AI ë¶„ì„ ì‘ì—…ì„ RabbitMQì— ë°œí–‰"""
    connection = pika.BlockingConnection(pika.URLParameters(settings.RABBITMQ_URL))
    channel = connection.channel()

    channel.basic_publish(
        exchange='cdss.topic',
        routing_key='ai.job.create',
        body=json.dumps({
            'study_id': study_id,
            'model_type': model_type,  # 'mri_tumor', 'omics_analysis'
            'submitted_at': datetime.now().isoformat()
        })
    )

    connection.close()
    return {'status': 'submitted', 'study_id': study_id}
```

```python
# AI Server (Flask) â†’ RabbitMQ Consumer
import pika
import tensorflow as tf

def callback(ch, method, properties, body):
    """AI ì¶”ë¡  ì‘ì—… ì²˜ë¦¬"""
    data = json.loads(body)
    study_id = data['study_id']
    model_type = data['model_type']

    # 1. DICOM ì´ë¯¸ì§€ ë¡œë“œ (Orthancì—ì„œ)
    images = load_dicom_from_orthanc(study_id)

    # 2. AI ëª¨ë¸ ì¶”ë¡ 
    model = load_model(model_type)
    results = model.predict(images)

    # 3. ê²°ê³¼ ì €ì¥ (MinIO + Django DB)
    save_ai_results(study_id, results)

    # 4. ACK
    ch.basic_ack(delivery_tag=method.delivery_tag)

# RabbitMQ ì—°ê²°
connection = pika.BlockingConnection(pika.URLParameters(RABBITMQ_URL))
channel = connection.channel()
channel.queue_declare(queue='ai_jobs', durable=True)
channel.basic_consume(queue='ai_jobs', on_message_callback=callback)
channel.start_consuming()
```

**2. FHIR ë™ê¸°í™” (ë¹„ë™ê¸°)**

```python
# Django Service â†’ RabbitMQ
@shared_task(queue='fhir')
def sync_to_fhir(resource_type, cdss_id):
    """FHIR ë™ê¸°í™” ì‘ì—… ë°œí–‰"""
    connection = pika.BlockingConnection(pika.URLParameters(settings.RABBITMQ_URL))
    channel = connection.channel()

    channel.basic_publish(
        exchange='cdss.topic',
        routing_key='fhir.sync',
        body=json.dumps({
            'resource_type': resource_type,  # 'Patient', 'ImagingStudy'
            'cdss_id': cdss_id,
            'retry_count': 0
        })
    )

    connection.close()
```

```python
# FHIR Worker (Celery) â†’ HAPI FHIR Server
def sync_fhir_resource(ch, method, properties, body):
    """FHIR ë¦¬ì†ŒìŠ¤ ë™ê¸°í™”"""
    data = json.loads(body)
    resource_type = data['resource_type']
    cdss_id = data['cdss_id']
    retry_count = data.get('retry_count', 0)

    try:
        # 1. CDSS DBì—ì„œ ë°ì´í„° ì¡°íšŒ
        entity = get_cdss_entity(resource_type, cdss_id)

        # 2. FHIR ë¦¬ì†ŒìŠ¤ë¡œ ë³€í™˜
        fhir_resource = transform_to_fhir(entity, resource_type)

        # 3. HAPI FHIR ì„œë²„ë¡œ ì „ì†¡
        response = requests.post(
            f'{HAPI_FHIR_URL}/{resource_type}',
            json=fhir_resource,
            headers={'Authorization': f'Bearer {FHIR_TOKEN}'}
        )

        if response.status_code == 201:
            # ì„±ê³µ ì‹œ ë§¤í•‘ í…Œì´ë¸” ì €ì¥
            save_fhir_mapping(cdss_id, response.json()['id'])
            ch.basic_ack(delivery_tag=method.delivery_tag)
        else:
            raise Exception(f'FHIR Sync Failed: {response.status_code}')

    except Exception as e:
        if retry_count < 3:
            # ì¬ì‹œë„
            channel.basic_publish(
                exchange='cdss.topic',
                routing_key='fhir.sync',
                body=json.dumps({**data, 'retry_count': retry_count + 1})
            )
        else:
            # Dead Letter Queueë¡œ ì´ë™
            save_to_dlq(data, str(e))

        ch.basic_nack(delivery_tag=method.delivery_tag, requeue=False)
```

### 3.3 RabbitMQ ì„¤ì •

```python
# backend/cdss/celery.py
from celery import Celery
import os

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'cdss.settings')

app = Celery('cdss')
app.config_from_object('django.conf:settings', namespace='CELERY')

# RabbitMQ ë¸Œë¡œì»¤ ì„¤ì •
app.conf.broker_url = 'amqp://guest:guest@rabbitmq:5672/'
app.conf.result_backend = 'redis://redis:6379/2'

# Queue ì •ì˜
app.conf.task_routes = {
    'ai.*': {'queue': 'ai'},
    'fhir.*': {'queue': 'fhir'},
    'alert.*': {'queue': 'alert'},
}

# Task ìš°ì„ ìˆœìœ„
app.conf.task_acks_late = True
app.conf.worker_prefetch_multiplier = 1

app.autodiscover_tasks()
```

---

## 4. ë³´ì•ˆ ë° ë„¤íŠ¸ì›Œí¬

### 4.1 Cloudflare ì„¤ì •

**Cloudflare ì—­í• **
- **SSL/TLS ì•”í˜¸í™”**: Let's Encrypt ìë™ ê°±ì‹ 
- **DDoS ë³´í˜¸**: Layer 3/4/7 ê³µê²© ì°¨ë‹¨
- **CDN**: ì •ì  íŒŒì¼ ìºì‹± (React Build)
- **WAF (Web Application Firewall)**: SQL Injection, XSS ì°¨ë‹¨
- **Rate Limiting**: IPë‹¹ ìš”ì²­ ì œí•œ (100req/min)

**Cloudflare DNS ì„¤ì •**
```
Type    Name          Content
A       cdss.hospital.com    <NGINX_SERVER_IP>
CNAME   www.cdss.hospital.com   cdss.hospital.com
```

**Cloudflare SSL ëª¨ë“œ**: Full (Strict)
- Cloudflare â†’ Nginx: HTTPS (Let's Encrypt)
- ì‚¬ìš©ì â†’ Cloudflare: HTTPS (Cloudflare Universal SSL)

### 4.2 Nginx ì„¤ì •

```nginx
# nginx/nginx.conf
upstream django_api {
    server django-api:8000;
}

upstream django_ws {
    server django-channels:8001;
}

# Rate Limiting
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=ws_limit:10m rate=5r/s;

server {
    listen 80;
    server_name cdss.hospital.com;
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name cdss.hospital.com;

    # SSL ì¸ì¦ì„œ (Cloudflare Origin Certificate)
    ssl_certificate /etc/nginx/ssl/cloudflare_origin.crt;
    ssl_certificate_key /etc/nginx/ssl/cloudflare_origin.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    # React ì •ì  íŒŒì¼
    location /static/ {
        alias /usr/share/nginx/html/static/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Django REST API
    location /api/ {
        limit_req zone=api_limit burst=20 nodelay;

        proxy_pass http://django_api;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # CORS í—¤ë”
        add_header Access-Control-Allow-Origin $http_origin always;
        add_header Access-Control-Allow-Credentials true always;
    }

    # WebSocket
    location /ws/ {
        limit_req zone=ws_limit burst=10 nodelay;

        proxy_pass http://django_ws;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    # Health Check
    location /health {
        access_log off;
        return 200 "OK";
        add_header Content-Type text/plain;
    }

    # âš ï¸ ë³´ì•ˆ ì •ì±…: ì™¸ë¶€ ì‹œìŠ¤í…œ ì§ì ‘ ì ‘ê·¼ ì°¨ë‹¨
    # HAPI FHIR, OpenEMR, OrthancëŠ” Nginxì—ì„œ ì§ì ‘ ë…¸ì¶œí•˜ì§€ ì•ŠìŒ
    # ëª¨ë“  ìš”ì²­ì€ Django APIë¥¼ í†µí•´ ì¸ì¦/ê¶Œí•œ ê²€ì¦ í›„ ì ‘ê·¼

    # âŒ ì˜ëª»ëœ ì„¤ì • ì˜ˆì‹œ (ì‚¬ìš© ê¸ˆì§€):
    # location /fhir/ {
    #     proxy_pass http://hapi-fhir:8080/fhir/;  # ì§ì ‘ ë…¸ì¶œ ê¸ˆì§€!
    # }
    # location /emr/ {
    #     proxy_pass http://openemr:8080/;  # ì§ì ‘ ë…¸ì¶œ ê¸ˆì§€!
    # }

    # âœ… ì˜¬ë°”ë¥¸ ë°©ë²•:
    # Client â†’ /api/fhir/* â†’ Django (ì¸ì¦) â†’ HAPI FHIR
    # Client â†’ /api/emr/* â†’ Django (ì¸ì¦) â†’ OpenEMR
    # Client â†’ /api/radiology/* â†’ Django (ì¸ì¦) â†’ Orthanc
}
```

### 4.3 Django ì¤‘ì•™ ì¸ì¦ ì •ì±… (ë³´ì•ˆ í•µì‹¬)

**âš ï¸ ì¤‘ìš”: ëª¨ë“  ì™¸ë¶€ ì‹œìŠ¤í…œ ì ‘ê·¼ì€ Djangoë¥¼ ê²½ìœ í•´ì•¼ í•©ë‹ˆë‹¤**

**ë³´ì•ˆ ì›ì¹™:**
1. **NginxëŠ” Django APIë§Œ ë…¸ì¶œ** - ì™¸ë¶€ ì‹œìŠ¤í…œ(OpenEMR, Orthanc, HAPI FHIR)ì€ ì§ì ‘ ë…¸ì¶œ ê¸ˆì§€
2. **Djangoì—ì„œ ì¸ì¦/ê¶Œí•œ ê²€ì¦** - Token ì¸ì¦ + ì—­í•  ê¸°ë°˜ ê¶Œí•œ(RBAC)
3. **ê°ì‚¬ ë¡œê·¸ í•„ìˆ˜** - ëª¨ë“  ì™¸ë¶€ ì‹œìŠ¤í…œ ì ‘ê·¼ ê¸°ë¡
4. **Client í´ë˜ìŠ¤ ì‚¬ìš©** - Django ë‚´ë¶€ì—ì„œë§Œ ì™¸ë¶€ ì‹œìŠ¤í…œ í˜¸ì¶œ

**ì˜¬ë°”ë¥¸ ìš”ì²­ íë¦„:**
```
Client (React)
  â†“ Authorization: Token <user_token>
Nginx (Reverse Proxy)
  â†“ /api/*
Django REST API
  â”œâ”€ 1. Token ì¸ì¦ í™•ì¸ âœ“
  â”œâ”€ 2. ì—­í•  ê¶Œí•œ í™•ì¸ (IsDoctor, IsRIB ë“±) âœ“
  â”œâ”€ 3. ê°ì‚¬ ë¡œê·¸ ê¸°ë¡ âœ“
  â””â”€ 4. ì™¸ë¶€ ì‹œìŠ¤í…œ Client í˜¸ì¶œ
     â†“
External System (OpenEMR / Orthanc / HAPI FHIR)
  â† Djangoê°€ ì¤‘ê°œì ì—­í• 
Response
  â† Django â†’ Nginx â†’ Client
```

**Django API êµ¬í˜„ ì˜ˆì‹œ:**
```python
# radiology/views.py
from rest_framework.decorators import api_view, permission_classes
from acct.permissions import IsDoctorOrRIB
from audit.client import AuditClient
from .clients.orthanc_client import OrthancClient

@api_view(['POST'])
@permission_classes([IsDoctorOrRIB])  # â† 1. ê¶Œí•œ ê²€ì¦
def upload_dicom(request):
    """
    DICOM ì—…ë¡œë“œ API
    Orthanc ì„œë²„ë¡œ ì§ì ‘ ì ‘ê·¼í•˜ì§€ ì•Šê³  Djangoë¥¼ í†µí•´ ì ‘ê·¼
    """
    # 2. ê°ì‚¬ ë¡œê·¸
    AuditClient.log_event(
        user=request.user,
        action='CREATE',
        resource_type='DICOM_Study',
        request=request
    )

    # 3. Orthanc Clientë¥¼ í†µí•´ ì ‘ê·¼ (Django ë‚´ë¶€ì—ì„œë§Œ)
    client = OrthancClient()
    result = client.upload_dicom(request.FILES['dicom'])

    return Response(result)

# fhir/views.py
@api_view(['GET'])
@permission_classes([IsStaffRole])  # â† ì˜ë£Œì§„ë§Œ ì ‘ê·¼
def get_patient_fhir(request, patient_id):
    """FHIR Patient ë¦¬ì†ŒìŠ¤ ì¡°íšŒ"""
    # 1. Django ê¶Œí•œ ê²€ì¦
    # 2. ê°ì‚¬ ë¡œê·¸
    AuditClient.log_event(...)

    # 3. HAPI FHIR Client í˜¸ì¶œ (ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬)
    client = HAPIClient()
    patient = client.get_patient(patient_id)

    return Response(patient)
```

**Docker Network ê²©ë¦¬:**
```yaml
# docker-compose.yml
services:
  django-api:
    networks:
      - cdss-network  # Djangoë§Œ ì™¸ë¶€ ì‹œìŠ¤í…œ ì ‘ê·¼ ê°€ëŠ¥

  hapi-fhir:
    networks:
      - cdss-network  # ì™¸ë¶€ ë…¸ì¶œ ì—†ìŒ
    # ports:  # â† í¬íŠ¸ë¥¼ ì™¸ë¶€ì— ë…¸ì¶œí•˜ì§€ ì•ŠìŒ!
    #   - "8080:8080"  # ê¸ˆì§€!

  orthanc:
    networks:
      - cdss-network
    # ports:  # â† ì™¸ë¶€ ë…¸ì¶œ ê¸ˆì§€
    #   - "8042:8042"  # ê¸ˆì§€!
```

### 4.4 ë°©í™”ë²½ ê·œì¹™

**ì™¸ë¶€ ì ‘ê·¼ í—ˆìš©**
- `443/tcp`: HTTPS (Cloudflareë§Œ)
- `80/tcp`: HTTP Redirect

**ë‚´ë¶€ ì „ìš©**
- `3306/tcp`: MySQL (Docker Networkë§Œ)
- `6379/tcp`: Redis (Docker Networkë§Œ)
- `5672/tcp`: RabbitMQ (Docker Networkë§Œ)
- `9090/tcp`: Prometheus (VPN ë˜ëŠ” localhostë§Œ)
- `3000/tcp`: Grafana (VPN ë˜ëŠ” localhostë§Œ)

**âš ï¸ ë³´ì•ˆ ì£¼ì˜:**
- ì™¸ë¶€ ì‹œìŠ¤í…œ í¬íŠ¸ë¥¼ í˜¸ìŠ¤íŠ¸ì— ë…¸ì¶œí•˜ì§€ ì•ŠìŒ
- Djangoë§Œ ë‚´ë¶€ Docker Networkë¥¼ í†µí•´ ì ‘ê·¼
- OpenEMR: `http://openemr:8080` (ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ë§Œ)
- Orthanc: `http://orthanc:8042` (ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ë§Œ)
- HAPI FHIR: `http://hapi-fhir:8080` (ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ë§Œ)

---

## 5. ì™¸ë¶€ ì‹œìŠ¤í…œ ì—°ë™

**ğŸ”’ ë³´ì•ˆ ì›ì¹™:**
- ëª¨ë“  ì™¸ë¶€ ì‹œìŠ¤í…œì€ Django Client í´ë˜ìŠ¤ë¥¼ í†µí•´ì„œë§Œ ì ‘ê·¼
- Django APIì—ì„œ ì¸ì¦/ê¶Œí•œ ê²€ì¦ í•„ìˆ˜
- ê°ì‚¬ ë¡œê·¸ ìë™ ê¸°ë¡
- Nginxì—ì„œ ì§ì ‘ ë…¸ì¶œ ê¸ˆì§€

### 5.1 Orthanc (PACS Server)

**ì—­í• **: DICOM ì˜ë£Œ ì˜ìƒ ì €ì¥ ë° ì „ì†¡

**ë°ì´í„° êµ¬ì¡°**
```
Patient (í™˜ì)
  â””â”€â”€ Study (ê²€ì‚¬)
       â””â”€â”€ Series (ì‹œë¦¬ì¦ˆ)
            â””â”€â”€ Instance (ê°œë³„ DICOM íŒŒì¼)
```

**Django ì—°ë™**
```python
# backend/radiology/clients/orthanc_client.py
import requests

class OrthancClient:
    def __init__(self):
        self.base_url = settings.ORTHANC_URL
        self.auth = (settings.ORTHANC_USER, settings.ORTHANC_PASSWORD)

    def upload_dicom(self, dicom_file):
        """DICOM íŒŒì¼ ì—…ë¡œë“œ (C-STORE)"""
        response = requests.post(
            f'{self.base_url}/instances',
            files={'file': dicom_file},
            auth=self.auth
        )
        return response.json()['ID']

    def get_study(self, study_uid):
        """Study ë©”íƒ€ë°ì´í„° ì¡°íšŒ (QIDO-RS)"""
        response = requests.get(
            f'{self.base_url}/studies/{study_uid}',
            auth=self.auth
        )
        return response.json()

    def get_dicom_image(self, instance_id):
        """DICOM ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ (WADO-RS)"""
        response = requests.get(
            f'{self.base_url}/instances/{instance_id}/file',
            auth=self.auth
        )
        return response.content
```

### 5.2 HAPI FHIR Server

**ì—­í• **: HL7 FHIR í‘œì¤€ ê¸°ë°˜ ì„ìƒ ë°ì´í„° ìƒí˜¸ìš´ìš©ì„±

**FHIR ë¦¬ì†ŒìŠ¤ ë§¤í•‘**
```
CDSS Entity          â†’ FHIR Resource
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
EMR_PATIENT_CACHE    â†’ Patient
RADIOLOGY_ORDERS     â†’ ServiceRequest
RADIOLOGY_STUDIES    â†’ ImagingStudy
AI_RESULTS           â†’ DiagnosticReport
TIMELINE_EVENTS      â†’ AuditEvent
```

**Django ì—°ë™**
```python
# backend/fhir/clients/hapi_client.py
import requests
from fhirclient import client

class HAPIClient:
    def __init__(self):
        self.base_url = settings.HAPI_FHIR_URL
        self.token = self.get_oauth_token()

    def get_oauth_token(self):
        """OAuth 2.0 í† í° ë°œê¸‰"""
        response = requests.post(
            f'{settings.FHIR_AUTH_URL}/token',
            data={
                'grant_type': 'client_credentials',
                'client_id': settings.FHIR_CLIENT_ID,
                'client_secret': settings.FHIR_CLIENT_SECRET,
                'scope': 'system/*.read system/*.write'
            }
        )
        return response.json()['access_token']

    def create_patient(self, patient_dto):
        """Patient ë¦¬ì†ŒìŠ¤ ìƒì„±"""
        fhir_patient = {
            'resourceType': 'Patient',
            'identifier': [{'system': 'CDSS', 'value': str(patient_dto.patient_id)}],
            'name': [{'family': patient_dto.family_name, 'given': [patient_dto.given_name]}],
            'birthDate': patient_dto.birth_date.isoformat()
        }

        response = requests.post(
            f'{self.base_url}/Patient',
            json=fhir_patient,
            headers={'Authorization': f'Bearer {self.token}'}
        )

        return response.json()['id']
```

### 5.3 OpenEMR

**ì—­í• **: ë ˆê±°ì‹œ ë³‘ì› ì‹œìŠ¤í…œ (ì²˜ë°©, ì§„ë£Œê¸°ë¡) ì‹œë®¬ë ˆì´ì…˜

**Django ì—°ë™**
```python
# backend/emr/clients/openemr_client.py
class OpenEMRClient:
    def __init__(self):
        self.base_url = settings.OPENEMR_URL
        self.api_token = self.authenticate()

    def authenticate(self):
        """OpenEMR API ì¸ì¦"""
        response = requests.post(
            f'{self.base_url}/oauth2/default/token',
            data={
                'grant_type': 'password',
                'username': settings.OPENEMR_USER,
                'password': settings.OPENEMR_PASSWORD,
                'scope': 'openid api:oemr'
            }
        )
        return response.json()['access_token']

    def get_patient(self, patient_id):
        """í™˜ì ì •ë³´ ì¡°íšŒ (ì½ê¸° ì „ìš©)"""
        response = requests.get(
            f'{self.base_url}/apis/default/api/patient/{patient_id}',
            headers={'Authorization': f'Bearer {self.api_token}'}
        )
        return response.json()
```

---

## 6. ëª¨ë‹ˆí„°ë§ ë° ê´€ì¸¡ì„± (Observability)

### 6.1 Prometheus ì„¤ì •

```yaml
# monitoring/prometheus.yml
global:
  scrape_interval: 15s
  evaluation_interval: 15s

alerting:
  alertmanagers:
    - static_configs:
        - targets: ['alertmanager:9093']

scrape_configs:
  # Django Metrics
  - job_name: 'django'
    static_configs:
      - targets: ['django-api:8000']
    metrics_path: '/metrics'

  # RabbitMQ Metrics
  - job_name: 'rabbitmq'
    static_configs:
      - targets: ['rabbitmq:15692']

  # AI Server Metrics
  - job_name: 'ai-server'
    static_configs:
      - targets: ['ai-server:5000']
    metrics_path: '/metrics'

  # MySQL Metrics
  - job_name: 'mysql'
    static_configs:
      - targets: ['mysql-exporter:9104']

  # Node Exporter (ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤)
  - job_name: 'node'
    static_configs:
      - targets: ['node-exporter:9100']
```

### 6.2 Grafana ëŒ€ì‹œë³´ë“œ

**ì£¼ìš” ë©”íŠ¸ë¦­**
1. **API ì„±ëŠ¥**
   - RPS (Requests Per Second)
   - ì‘ë‹µ ì‹œê°„ (p50, p95, p99)
   - ì—ëŸ¬ìœ¨ (4xx, 5xx)

2. **AI ì¶”ë¡ **
   - GPU ì‚¬ìš©ëŸ‰ (%)
   - GPU ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ (GB)
   - AI Job ì²˜ë¦¬ ì‹œê°„ (ì´ˆ)
   - Queue ëŒ€ê¸° ì‹œê°„

3. **ë°ì´í„°ë² ì´ìŠ¤**
   - ì¿¼ë¦¬ ì‹¤í–‰ ì‹œê°„
   - ì—°ê²° ìˆ˜
   - Slow Query íšŸìˆ˜

4. **RabbitMQ**
   - Queue ê¹Šì´ (Message Count)
   - Consumer ì²˜ë¦¬ëŸ‰
   - Unacked Messages

**Grafana Dashboard JSON**
```json
{
  "dashboard": {
    "title": "CDSS System Overview",
    "panels": [
      {
        "title": "API Requests Per Second",
        "targets": [
          {
            "expr": "rate(django_http_requests_total[1m])",
            "legendFormat": "{{method}} {{endpoint}}"
          }
        ]
      },
      {
        "title": "GPU Usage",
        "targets": [
          {
            "expr": "nvidia_gpu_utilization",
            "legendFormat": "GPU {{gpu}}"
          }
        ]
      }
    ]
  }
}
```

### 6.3 Alertmanager (Code Blue ì•Œë¦¼)

```yaml
# monitoring/alertmanager.yml
global:
  resolve_timeout: 5m

route:
  group_by: ['alertname', 'severity']
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 12h
  receiver: 'code-blue-team'

receivers:
  - name: 'code-blue-team'
    email_configs:
      - to: 'devops@hospital.com'
        from: 'alertmanager@hospital.com'
        smarthost: 'smtp.gmail.com:587'
    slack_configs:
      - api_url: 'https://hooks.slack.com/services/XXX/YYY/ZZZ'
        channel: '#code-blue-alerts'
        title: 'CDSS Alert: {{ .GroupLabels.alertname }}'
        text: '{{ range .Alerts }}{{ .Annotations.description }}{{ end }}'
    pagerduty_configs:
      - service_key: '<PAGERDUTY_SERVICE_KEY>'
```

**Alert ê·œì¹™**
```yaml
# monitoring/alert_rules.yml
groups:
  - name: cdss_critical
    interval: 30s
    rules:
      - alert: HighErrorRate
        expr: rate(django_http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High 5xx error rate on {{ $labels.instance }}"
          description: "Error rate is {{ $value }} req/s"

      - alert: AIJobQueueBacklog
        expr: rabbitmq_queue_messages{queue="ai_jobs"} > 100
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "AI job queue backlog detected"
          description: "{{ $value }} jobs pending in queue"

      - alert: DatabaseConnectionsHigh
        expr: mysql_global_status_threads_connected / mysql_global_variables_max_connections > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Database connection pool nearly exhausted"
          description: "{{ $value | humanizePercentage }} connections used"
```

---

## 7. ë°°í¬ ì „ëµ

### 7.1 CI/CD íŒŒì´í”„ë¼ì¸

**GitHub Actions**
```yaml
# .github/workflows/deploy.yml
name: Deploy CDSS to Production

on:
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run Django Tests
        run: |
          docker-compose -f docker-compose.test.yml up --abort-on-container-exit
      - name: Run Frontend Tests
        run: |
          cd react && npm test

  build:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Build Docker Images
        run: |
          docker-compose build
      - name: Push to Registry
        run: |
          docker tag cdss-django-api:latest registry.hospital.com/cdss-django-api:${{ github.sha }}
          docker push registry.hospital.com/cdss-django-api:${{ github.sha }}

  deploy:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to Production
        run: |
          ssh deploy@production-server "cd /opt/cdss && docker-compose pull && docker-compose up -d"
```

### 7.2 Blue-Green ë°°í¬

```bash
# 1. Green í™˜ê²½ ë°°í¬
docker-compose -f docker-compose.green.yml up -d

# 2. Health Check
curl -f http://localhost:8001/health || exit 1

# 3. Nginx íŠ¸ë˜í”½ ì „í™˜
sed -i 's/blue/green/g' nginx/nginx.conf
nginx -s reload

# 4. Blue í™˜ê²½ ì¢…ë£Œ (24ì‹œê°„ í›„)
docker-compose -f docker-compose.blue.yml down
```

### 7.3 ë¡¤ë°± ì ˆì°¨

```bash
# 1. Nginx íŠ¸ë˜í”½ ë³µêµ¬
sed -i 's/green/blue/g' nginx/nginx.conf
nginx -s reload

# 2. Green í™˜ê²½ ì¢…ë£Œ
docker-compose -f docker-compose.green.yml down

# 3. DB ë¡¤ë°± (Django Migration)
docker-compose exec django-api python manage.py migrate <app_name> <previous_migration>
```

---

## 8. ë°±ì—… ë° ì¬í•´ ë³µêµ¬

### 8.1 ë°±ì—… ì „ëµ

**MySQL ë°±ì—… (ì¼ì¼)**
```bash
# backup/mysql_backup.sh
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backups/mysql"

docker exec cdss-mysql mysqldump \
  -u cdss_user -p${DB_PASSWORD} \
  --single-transaction \
  --routines \
  --triggers \
  cdss_db > ${BACKUP_DIR}/cdss_db_${DATE}.sql

# ì••ì¶•
gzip ${BACKUP_DIR}/cdss_db_${DATE}.sql

# S3 ì—…ë¡œë“œ (ì„ íƒ)
aws s3 cp ${BACKUP_DIR}/cdss_db_${DATE}.sql.gz s3://hospital-backups/mysql/

# 7ì¼ ì´ìƒ ëœ ë°±ì—… ì‚­ì œ
find ${BACKUP_DIR} -name "*.sql.gz" -mtime +7 -delete
```

**MinIO ë°±ì—… (ì£¼ê°„)**
```bash
# MinIO ë°ì´í„° rsync
rsync -avz /var/lib/docker/volumes/cdss_minio_data/ /backups/minio/
```

### 8.2 ì¬í•´ ë³µêµ¬ (DR)

**RTO (Recovery Time Objective)**: 4ì‹œê°„
**RPO (Recovery Point Objective)**: 24ì‹œê°„

**ë³µêµ¬ ì ˆì°¨**
```bash
# 1. Docker í™˜ê²½ ë³µêµ¬
docker-compose up -d mysql redis rabbitmq

# 2. MySQL ë³µêµ¬
gunzip < /backups/mysql/cdss_db_20251219.sql.gz | \
  docker exec -i cdss-mysql mysql -u cdss_user -p${DB_PASSWORD} cdss_db

# 3. MinIO ë³µêµ¬
rsync -avz /backups/minio/ /var/lib/docker/volumes/cdss_minio_data/

# 4. ì• í”Œë¦¬ì¼€ì´ì…˜ ì¬ì‹œì‘
docker-compose up -d
```

---

## ë¶€ë¡ A: í™˜ê²½ ë³€ìˆ˜ í…œí”Œë¦¿

```bash
# .env.production
# Database
MYSQL_ROOT_PASSWORD=<REDACTED>
DB_PASSWORD=<REDACTED>

# Django
DJANGO_SECRET_KEY=<REDACTED>
DJANGO_DEBUG=False
ALLOWED_HOSTS=cdss.hospital.com

# RabbitMQ
RABBITMQ_DEFAULT_USER=guest
RABBITMQ_DEFAULT_PASS=<REDACTED>

# MinIO
MINIO_ROOT_USER=minioadmin
MINIO_ROOT_PASSWORD=<REDACTED>

# Grafana
GRAFANA_PASSWORD=<REDACTED>

# External Systems
OPENEMR_URL=https://emr.hospital.com
OPENEMR_USER=cdss_api
OPENEMR_PASSWORD=<REDACTED>

ORTHANC_URL=https://pacs.hospital.com
ORTHANC_USER=cdss
ORTHANC_PASSWORD=<REDACTED>

HAPI_FHIR_URL=https://fhir.hospital.com/fhir
FHIR_CLIENT_ID=cdss_client
FHIR_CLIENT_SECRET=<REDACTED>

# AI Server
GPU_MEMORY_LIMIT=8GB
```

---

## ë¶€ë¡ B: ê°œë°œì ì²´í¬ë¦¬ìŠ¤íŠ¸

**DevOps ì—”ì§€ë‹ˆì–´**
- [ ] Docker Compose íŒŒì¼ ì‘ì„±
- [ ] Nginx ì„¤ì • ì‘ì„±
- [ ] Cloudflare DNS ì„¤ì •
- [ ] SSL ì¸ì¦ì„œ ë°œê¸‰ (Cloudflare Origin)
- [ ] RabbitMQ Queue ì •ì˜
- [ ] Prometheus ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì„¤ì •
- [ ] Grafana ëŒ€ì‹œë³´ë“œ ìƒì„±
- [ ] Alertmanager ì•Œë¦¼ ê·œì¹™ ì„¤ì •
- [ ] CI/CD íŒŒì´í”„ë¼ì¸ êµ¬ì¶•
- [ ] ë°±ì—… ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± ë° cron ë“±ë¡

**Backend ê°œë°œì**
- [ ] Celery Worker êµ¬í˜„ (AI, FHIR Queue)
- [ ] RabbitMQ Producer/Consumer ì½”ë“œ ì‘ì„±
- [ ] Prometheus Metrics Exporter ì¶”ê°€
- [ ] Health Check ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„ (/health)
- [ ] Django Channels ASGI ì„¤ì •

**AI ì—”ì§€ë‹ˆì–´**
- [ ] Flask AI ì„œë²„ êµ¬í˜„
- [ ] GPU ë©”ëª¨ë¦¬ ê´€ë¦¬ ìµœì í™”
- [ ] RabbitMQ Consumer (AI Job)
- [ ] ëª¨ë¸ ì¶”ë¡  ì„±ëŠ¥ ìµœì í™”

---

**ë¬¸ì„œ ì‘ì„±**: Claude AI
**ì‘ì„±ì¼**: 2025-12-19
**ë²„ì „**: 1.0
