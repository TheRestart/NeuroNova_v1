# 기술 문서: Django CRUD 강화 및 데이터 정합성 보장 전략

이 문서는 NeuroNova CDSS 백엔드에서 데이터 충동을 방지하고 요청의 멱등성을 보장하기 위해 적용된 기술적 상세 내용을 설명합니다.

## 1. 낙관적 락 (Optimistic Locking)

### 개념
데이터를 수정할 때 충돌이 발생하지 않을 것이라고 가정하고, 마지막에 데이터가 변경되었는지 확인하는 방식입니다. 주로 `version` 필드를 사용하여 구현합니다.

### 작동 방식
1. 데이터를 읽을 때 현재 `version`을 함께 가져옵니다. (ex: version=1)
2. 데이터를 수정할 때 조건을 추가합니다: `WHERE id=1 AND version=1`
3. 업데이트 시 `version`을 1 증가시킵니다.
4. 만약 그 사이 다른 사용자가 데이터를 수정했다면 `version`이 이미 변경되었으므로 업데이트에 실패하며, 이를 통해 데이터 유실을 방지합니다.

### 장점
- 데이터베이스 로우(row)를 직접 잠그지 않아 성능상 이점이 큼
- 데드락(Deadlock) 위험이 없음

---

## 2. 비관적 락 (Pessimistic Locking)

### 개념
데이터 수정 시 충돌이 발생할 가능성이 높다고 가정하고, 데이터를 읽는 시점에 로우를 선점하여 잠그는 방식입니다.

### 작동 방식
1. Django ORM의 `select_for_update()`를 사용하여 데이터를 조회합니다.
2. 데이터베이스 엔진 수준에서 해당 로우에 쓰기 잠금(Write Lock)을 겁니다.
3. 해당 트랜잭션이 종료(Commit/Rollback)될 때까지 다른 트랜잭션은 해당 로우를 수정하거나 읽을 수 없습니다.

### 장점
- 높은 수준의 데이터 정합성 보장
- 금융 업무나 재고 관리 등 충돌 시 큰 문제가 발생하는 경우 필수적

---

## 3. 멱등성 (Idempotency)

### 개념
동일한 요청을 여러 번 수행해도 결과가 항상 같아야 한다는 성질입니다. 네트워크 오류 등으로 인해 클라이언트가 중복 요청을 보낼 때 시스템이 중복 처리를 하지 않도록 방지합니다.

### 작동 방식
1. 클라이언트는 각 요청마다 고유한 `X-Idempotency-Key`를 헤더에 포함하여 전송합니다.
2. 서버는 해당 키가 이미 처리되었는지 확인합니다.
3. 이미 처리된 키라면 실제 로직을 실행하지 않고 기존에 저장된 응답을 반환합니다.
4. 새로운 키라면 로직 실행 후 결과를 저장하고 반환합니다.

---

## 4. 트랜잭션 격리 수준 (Transaction Isolation Level)

### 개념
여러 트랜잭션이 동시에 실행될 때, 서로 간의 데이터 가시성을 결정하는 규칙입니다.

### NeuroNova 설정
- **기본 수준**: `READ COMMITTED`
- 커밋된 데이터만 읽을 수 있도록 설정하여 Dirty Read를 방지하고 데이터 정합성을 유지합니다.
