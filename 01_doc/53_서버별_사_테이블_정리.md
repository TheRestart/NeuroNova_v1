# 서버별 데이터베이스 테이블 매핑 현황

**작성일**: 2026-01-05
**버전**: v1.0 (Direct DB Access + Outbox Pattern 적용 기준)

본 문서는 NeuroNova CDSS 시스템의 각 서버(Django, OpenEMR)에서 사용하는 주요 데이터베이스 테이블과 그 매핑 관계를 정리합니다.

---

## 1. Django Server DB (MySQL: `cdss_db`)

Django 백엔드가 직접 관리하는 데이터베이스입니다. `managed = True` (Django Migration 사용) 모델들입니다.

### EMR (Electronic Medical Record)
| 테이블명 | Django 모델 | 설명 | 동기화 |
|---|---|---|---|
| `emr_patient_cache` | `emr.PatientCache` | 환자 기본 정보 캐시 (리스트 조회용) | OpenEMR, FHIR |
| `emr_encounters` | `emr.Encounter` | 진료 기록 (기본 정보) | OpenEMR(예정) |
| `emr_encounter_diagnoses` | `emr.EncounterDiagnosis` | 진료 진단 내역 | - |
| `emr_sync_outbox` | `emr.SyncOutbox` | **비동기 동기화 이벤트 저장소** (Outbox Pattern) | - |

### OCS (Order Communication System)
| 테이블명 | Django 모델 | 설명 | 동기화 |
|---|---|---|---|
| `ocs_orders` | `emr.Order` | 처방 주문 (Review/Status 관리) | OpenEMR(예정) |
| `ocs_order_items` | `emr.OrderItem` | 처방 상세 품목 (약물, 검사 등) | - |

### LIS (Laboratory Information System)
| 테이블명 | Django 모델 | 설명 | 동기화 |
|---|---|---|---|
| `lis_lab_results` | `lis.LabResult` | 진단 검사 결과 (유전 정보 포함) | - |
| `lis_lab_test_master` | `lis.LabTestMaster` | 검사 마스터 코드 | - |

### RIS (Radiology Information System)
| 테이블명 | Django 모델 | 설명 | 동기화 |
|---|---|---|---|
| `ris_radiology_studies` | `ris.RadiologyStudy` | DICOM Study 메타데이터 | Orthanc |
| `ris_radiology_reports` | `ris.RadiologyReport` | 판독 결과 리포트 | - |

### AI (Artificial Intelligence)
| 테이블명 | Django 모델 | 설명 | 동기화 |
|---|---|---|---|
| `ai_aijob` | `ai.AIJob` | AI 추론 작업 및 결과 (JSON) | - |

---

## 2. OpenEMR Server DB (MariaDB: `openemr`)

레거시 EMR 시스템의 데이터베이스입니다. Django에서 `OpenEMRRouter`를 통해 직접 접근하며, 스키마 변경을 하지 않습니다 (`managed = False`).

### 주요 테이블
| 테이블명 | Django 모델 (`emr/openemr_models.py`) | 설명 | 접근 방식 |
|---|---|---|---|
| `patient_data` | `emr.PatientData` | **환자 상세 정보** (개인정보, 보험 등) | Direct SQL (ORM) |
| `encounters` | `emr.Encounter` | 진료 상세 정보 | Direct SQL (ORM) |
| `forms` | `emr.Form` | 진료 서식/폼 메타데이터 | Direct SQL (ORM) |
| `prescriptions` | `emr.Prescription` | 약품 처방 내역 | Direct SQL (ORM) |

> **참고**: OpenEMR에는 이 외에도 200개 이상의 테이블이 존재하지만, NeuroNova CDSS는 위 4개 테이블을 핵심적으로 사용합니다.

---

## 3. HAPI FHIR Server DB (H2/PostgreSQL)

FHIR 표준 리소스를 저장하는 데이터베이스입니다. HAPI JPA Server가 내부적으로 관리하므로 직접 테이블에 접근하지 않는 것을 권장합니다.

*   **접근 방식**: `HAPI FHIR REST API` (표준 프로토콜)
*   **보조 접근**: 필요 시 Django에서 Read-Only로 설정 가능하나 현재는 Outbox Pattern을 통한 API/DB 동기화를 사용.

---

## 4. 데이터 매핑 로직

### 환자 데이터 (Patient)
```
[Django] emr_patient_cache (pid: P202501)
       ↕ (Outbox Sync)
[OpenEMR] patient_data (pid: 12345, pubpid: P202501)
```

### 진료 데이터 (Encounter)
```
[Django] emr_encounters (id: E202501)
       ↓ (단방향 동기화 예정)
[OpenEMR] encounters (id: 987, encounter: 987)
```
