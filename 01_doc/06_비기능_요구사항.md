# 비기능 요구사항 (Non-Functional Requirements - NFR)

**목적**: NeuroNova CDSS 시스템의 성능, 보안, 가용성, 확장성 요구사항 정의
**대상**: 아키텍트, 개발자, 인프라 엔지니어
**최종 수정일**: 2025-12-31

---

## 📋 개요

비기능 요구사항(NFR)은 시스템이 "무엇을 하는가"(기능 요구사항)가 아닌 **"어떻게 동작해야 하는가"**를 정의합니다.

### NFR 카테고리
1. **Performance** - 성능
2. **Availability** - 가용성
3. **Security** - 보안
4. **Scalability** - 확장성
5. **Usability** - 사용성
6. **Maintainability** - 유지보수성
7. **Compliance** - 규정 준수

---

## ⚡ 1. Performance (성능)

### 1.1 응답 시간 (Response Time)

| API 유형 | 평균 응답 시간 | 최대 응답 시간 | 측정 조건 |
|---------|--------------|--------------|----------|
| 환자 검색 (UC02) | 200ms | 1000ms | 동시 사용자 100명 |
| 처방 생성 (UC03) | 300ms | 1500ms | 약물 상호작용 체크 포함 |
| 검사 결과 조회 (UC04) | 150ms | 800ms | 최근 3개월 데이터 |
| DICOM 이미지 로딩 (UC05) | 5000ms | 10000ms | 1 Study (100 슬라이스) |
| AI 추론 (UC06) | 15000ms | 30000ms | 뇌출혈 분류 모델 |
| 대시보드 로딩 (UC08) | 500ms | 2000ms | 위젯 5개 동시 렌더링 |

**측정 방법**:
- Prometheus + Grafana로 P50, P95, P99 백분위수 모니터링
- 매주 성능 테스트 실행 (JMeter 또는 Locust)

**개선 조치**:
- P95 > 최대 응답 시간 시 경고 알림
- P99 > 최대 응답 시간 × 1.5 시 긴급 조치

---

### 1.2 처리량 (Throughput)

| 작업 유형 | 목표 TPS | 측정 조건 |
|---------|---------|----------|
| 환자 등록 | 10 TPS | 동시 등록 시나리오 |
| 처방 생성 | 20 TPS | 피크 타임 (오전 10-12시) |
| 검사 결과 입력 | 30 TPS | 검사실 피크 타임 |
| DICOM 업로드 | 5 TPS | 1개 Study = 100MB |

**TPS (Transactions Per Second)**: 초당 처리 가능한 트랜잭션 수

---

### 1.3 데이터베이스 쿼리 성능

| 쿼리 유형 | 최대 실행 시간 | 인덱스 요구사항 |
|---------|--------------|---------------|
| 환자 이름 검색 | 100ms | `idx_patient_name` |
| 처방 이력 조회 | 200ms | `idx_prescription_patient_created` |
| 검사 결과 범위 검색 | 150ms | `idx_lab_result_patient_date` |
| DICOM Study 검색 | 300ms | `idx_ris_study_patient_date` |

**Slow Query 정의**: 500ms 이상 소요 쿼리
**조치**: Slow Query Log 분석 및 주간 리뷰

---

## 🛡️ 2. Availability (가용성)

### 2.1 Uptime 목표

| 환경 | 목표 Uptime | 허용 다운타임 (월) | 허용 다운타임 (연) |
|------|------------|------------------|------------------|
| **Production** | **99.0%** | 7.2시간 | 3.65일 |
| Staging | 95.0% | 36시간 | 18.25일 |
| Development | 90.0% | 72시간 | 36.5일 |

**계산식**:
```
99.0% Uptime = 365일 × 24시간 × 0.01 = 87.6시간/년 = 3.65일/년
```

**예외 사항**:
- 계획된 유지보수 시간은 다운타임에서 제외
- 유지보수는 매주 일요일 오전 2-4시 (2시간) 수행

---

### 2.2 백업 및 복구

| 항목 | 요구사항 | 수행 방식 |
|------|---------|----------|
| **RPO (Recovery Point Objective)** | **24시간** | 매일 전체 백업 |
| **RTO (Recovery Time Objective)** | **4시간** | 자동 복구 스크립트 |
| 백업 주기 | 매일 오전 3시 | Cron 작업 |
| 백업 보관 기간 | 30일 (일일), 12개월 (월말) | AWS S3 Glacier |
| 백업 테스트 | 월 1회 | Staging 환경 복원 테스트 |

**RPO**: 데이터 손실 허용 범위 (최대 24시간 데이터 손실 가능)
**RTO**: 서비스 복구 목표 시간 (장애 발생 후 4시간 이내 복구)

---

### 2.3 Failover 및 중복성

| 구성 요소 | 중복성 전략 | Failover 시간 |
|---------|-----------|-------------|
| Django API 서버 | 최소 2대 (Load Balancer) | 30초 |
| MySQL 데이터베이스 | Master-Slave Replication | 60초 |
| Redis 캐시 | Redis Sentinel (3노드) | 15초 |
| Orthanc PACS | 단일 인스턴스 (허용) | N/A |

**Health Check**:
- `/api/health/` 엔드포인트 제공
- 15초마다 Health Check 실행
- 연속 3회 실패 시 서버 제외

---

## 🔐 3. Security (보안)

### 3.1 인증 및 권한

| 항목 | 요구사항 | 구현 방식 |
|------|---------|----------|
| **비밀번호 정책** | 최소 12자, 영문+숫자+특수문자 | Django Password Validators |
| **JWT 토큰 만료** | Access: 1시간, Refresh: 7일 | django-rest-framework-simplejwt |
| **세션 타임아웃** | 30분 비활동 시 자동 로그아웃 | 프론트엔드 타이머 |
| **Multi-Factor Auth** | 관리자 계정 필수 | TOTP (Google Authenticator) |
| **권한 검증** | 모든 API 엔드포인트 | IsAuthenticated + 역할 기반 |

**비밀번호 해싱**:
- 알고리즘: `pbkdf2_sha256`
- Iteration: 320,000회 (Django 4.2 기본값)

---

### 3.2 데이터 암호화

| 데이터 유형 | 암호화 방식 | 적용 시점 |
|-----------|-----------|----------|
| **민감 정보 (주민번호, 신용카드)** | AES-256 | DB 저장 시 |
| **전송 데이터** | TLS 1.3 | HTTPS |
| **백업 파일** | AES-256 + GPG | S3 업로드 전 |
| **로그 파일** | 민감 정보 마스킹 | 로그 기록 시 |

**예시**:
```python
# 주민번호 마스킹
"901234-1******" (뒤 6자리 마스킹)

# 로그에서 비밀번호 마스킹
"password": "***"
"Authorization": "Bearer ***"
```

---

### 3.3 접근 제어

| 리소스 | 허용 역할 | 제한 사항 |
|--------|---------|----------|
| 환자 개인정보 (UC02) | doctor, nurse | 담당 환자만 조회 |
| 처방 생성 (UC03) | doctor | 본인 처방만 수정 |
| 검사 결과 입력 (UC04) | labtech | 본인이 접수한 검사만 |
| AI 모델 관리 (UC06) | admin | 일반 사용자 조회만 |
| 시스템 설정 | admin | 타 역할 접근 불가 |

**RBAC (Role-Based Access Control)** 적용

---

### 3.4 보안 로그 및 감사

| 이벤트 | 로그 보관 기간 | 알림 조건 |
|--------|--------------|----------|
| 로그인 시도 (성공/실패) | 3년 | 5회 연속 실패 시 계정 잠금 |
| 환자 정보 조회 | 3년 | 비정상적 대량 조회 시 알림 |
| 데이터 수정/삭제 | 3년 | 관리자에게 일일 리포트 |
| 권한 변경 | 영구 보관 | 즉시 슬랙 알림 |

**로그 무결성**: 로그 위변조 방지를 위한 Hash Chain 적용

---

## 📈 4. Scalability (확장성)

### 4.1 동시 사용자

| 단계 | 동시 사용자 | 인프라 구성 |
|------|-----------|------------|
| **Phase 1 (MVP)** | **100명** | Django 2대, MySQL 1대 |
| Phase 2 (운영 1년) | 500명 | Django 4대, MySQL Master-Slave |
| Phase 3 (확장) | 1000명 | Django Auto-Scaling, MySQL Cluster |

**부하 테스트**:
- 매월 목표 사용자 × 1.5배 부하 테스트 실행
- 병목 지점 파악 및 개선

---

### 4.2 데이터 증가율

| 데이터 유형 | 일일 증가량 | 연간 증가량 | 보관 기간 |
|-----------|-----------|-----------|----------|
| 환자 레코드 | 50건 | 18,000건 | 영구 |
| 처방 내역 | 200건 | 73,000건 | 10년 |
| 검사 결과 | 300건 | 109,500건 | 10년 |
| DICOM 이미지 | 10 Studies (1GB) | 365GB | 7년 |
| 로그 파일 | 500MB | 182GB | 3년 |

**스토리지 계획**:
- Year 1: 500GB
- Year 3: 1.5TB
- Year 5: 3TB

---

### 4.3 수평 확장 (Horizontal Scaling)

| 구성 요소 | 확장 방식 | 한계 |
|---------|----------|------|
| Django API 서버 | Stateless, Load Balancer | 무제한 (비용 제약만) |
| Celery Worker | Celery Beat 분리, Worker 증설 | 무제한 |
| MySQL | Read Replica 추가 | Master 1대 한계 |
| Redis | Cluster 모드 (Sharding) | 최대 1000 노드 |

---

## 🖥️ 5. Usability (사용성)

### 5.1 사용자 인터페이스

| 항목 | 요구사항 | 측정 방법 |
|------|---------|----------|
| **페이지 로딩 시간** | **3초 이내** | Google Lighthouse |
| **모바일 대응** | 반응형 디자인 (Responsive) | 테블릿/모바일 테스트 |
| **접근성** | WCAG 2.1 Level AA | axe DevTools |
| **브라우저 지원** | Chrome, Edge, Safari (최신 2버전) | BrowserStack |
| **다국어 지원** | 한국어, 영어 | i18n (선택적 구현) |

**Lighthouse 점수 목표**:
- Performance: 90점 이상
- Accessibility: 90점 이상
- Best Practices: 90점 이상

---

### 5.2 오류 처리

| 오류 유형 | 사용자 메시지 | 개발자 로그 |
|---------|-------------|-----------|
| 네트워크 오류 | "서버 연결에 실패했습니다. 다시 시도해주세요." | `ConnectionError: ...` |
| 권한 오류 | "접근 권한이 없습니다." | `PermissionDenied: User X tried to access Y` |
| 데이터 유효성 오류 | "입력한 정보를 확인해주세요. (필드명: 오류 내용)" | `ValidationError: ...` |
| 서버 오류 | "일시적인 오류가 발생했습니다. 잠시 후 다시 시도해주세요." | `Exception: ..., Trace: ...` |

**원칙**:
- 사용자에게는 친절한 메시지
- 개발자에게는 상세한 디버깅 정보

---

## 🔧 6. Maintainability (유지보수성)

### 6.1 코드 품질

| 지표 | 목표 | 도구 |
|------|------|------|
| **테스트 커버리지** | **80% 이상** | pytest-cov |
| 코드 복잡도 | Cyclomatic Complexity < 10 | flake8, radon |
| 정적 분석 | 0 Critical Issue | SonarQube |
| 타입 검사 | 100% 타입 힌트 (신규 코드) | mypy |

**Code Review**:
- 모든 PR은 1명 이상 승인 필요
- 자동화 테스트 통과 필수

---

### 6.2 배포 및 롤백

| 항목 | 요구사항 | 도구 |
|------|---------|------|
| **배포 시간** | **10분 이내** | GitHub Actions + Docker |
| **롤백 시간** | **5분 이내** | 이전 Docker 이미지 재배포 |
| 무중단 배포 | Blue-Green Deployment | Nginx + Docker Compose |
| 배포 빈도 | 주 1회 (매주 목요일 오후 6시) | 정기 배포 |

---

### 6.3 모니터링 및 알림

| 지표 | 알림 조건 | 알림 채널 |
|------|---------|----------|
| CPU 사용률 | > 80% (5분 지속) | Slack #alerts |
| 메모리 사용률 | > 90% | Slack #alerts |
| 디스크 사용률 | > 85% | Slack #alerts |
| API 에러율 | > 5% (10분간) | Slack #critical |
| 데이터베이스 연결 실패 | 1회 발생 시 | Slack #critical, Email |

**모니터링 도구**:
- Prometheus + Grafana
- Sentry (에러 추적)
- ELK Stack (로그 분석)

---

## 📜 7. Compliance (규정 준수)

### 7.1 의료 정보 보호

| 규정 | 요구사항 | 준수 방법 |
|------|---------|----------|
| **개인정보보호법** | 환자 동의 없이 정보 제공 불가 | 환자 동의서 DB 저장 |
| **의료법 제21조** | 전자의무기록 위변조 방지 | Audit Log + Hash Chain |
| **의료법 제22조** | 의무기록 보존 기간 10년 | S3 Glacier 장기 보관 |
| HIPAA (미국, 선택) | PHI 암호화 및 접근 제어 | AES-256 암호화 |

**Audit Trail**:
- 모든 환자 정보 접근 로그 기록
- 수정 전/후 데이터 비교 (JSON Diff)

---

### 7.2 데이터 보존 정책

| 데이터 유형 | 보존 기간 | 삭제 방법 |
|-----------|---------|----------|
| 환자 의무기록 | 10년 | 익명화 (개인정보 제거) |
| 처방 내역 | 10년 | 익명화 |
| DICOM 이미지 | 7년 | 완전 삭제 (S3 Lifecycle) |
| 접근 로그 | 3년 | 압축 후 S3 Glacier |
| 백업 파일 | 30일 (일일), 12개월 (월말) | 자동 삭제 |

---

## 📊 NFR 우선순위

### High Priority (즉시 구현 필수)
- ✅ API 응답 시간 < 1000ms
- ✅ 비밀번호 정책 (최소 12자)
- ✅ HTTPS 적용
- ✅ 백업 자동화 (RPO 24시간)
- ✅ 테스트 커버리지 80%

### Medium Priority (3개월 이내)
- ⚠️ 동시 사용자 500명 지원
- ⚠️ Read Replica 구성
- ⚠️ Prometheus + Grafana 모니터링
- ⚠️ Blue-Green Deployment
- ⚠️ WCAG 2.1 AA 준수

### Low Priority (6개월 이내)
- 🔵 Multi-Factor Authentication
- 🔵 Auto-Scaling
- 🔵 ELK Stack 로그 분석
- 🔵 SonarQube 정적 분석
- 🔵 국제화 (i18n) 지원

---

## 🧪 NFR 검증 계획

### 성능 테스트
```bash
# Locust 부하 테스트 (100명 동시 사용자)
locust -f tests/load_test.py --users 100 --spawn-rate 10 --host http://localhost:8000

# 목표: P95 < 1000ms
```

### 보안 테스트
```bash
# OWASP ZAP 취약점 스캔
docker run -t owasp/zap2docker-stable zap-baseline.py -t http://localhost:8000

# 목표: High/Medium 취약점 0건
```

### 가용성 테스트
```bash
# Chaos Engineering (랜덤 컨테이너 종료)
docker kill neuronova-django-dev

# 목표: Health Check 실패 후 30초 이내 Failover
```

---

## 📝 변경 이력

- **2025-12-31**: 초안 작성 (성능, 보안, 가용성, 확장성 NFR 정의)
- **버전**: 1.0

---

**작성**: Claude AI
**검토 필요**: 인프라 팀과 목표 수치 협의 필요 (특히 Uptime, RTO, RPO)
**다음 단계**: NFR을 기반으로 성능 테스트 스크립트 작성
