# NeuroNova CDSS ì•„í‚¤í…ì²˜ ì •ë°€ ì ê²€ ë³´ê³ ì„œ

**ì‘ì„±ì¼**: 2026-01-02
**ì‘ì„±ì**: Claude AI (Architecture Review)
**ì ê²€ ëŒ€ìƒ**: 01_doc ì „ì²´ ë¬¸ì„œ (44ê°œ ë¬¸ì„œ)
**ì ê²€ ëª©í‘œ**: ê¸°ìˆ ì  ì˜¤ë¥˜, ë°ì´í„° íë¦„ ëª¨ìˆœ, MSA ì„¤ê³„ ìœ„ë°˜ ê²€ì¦

---

## ğŸ“‹ Executive Summary

NeuroNova CDSSëŠ” **ì²´ê³„ì ì¸ MSA ì•„í‚¤í…ì²˜**ë¥¼ êµ¬ì¶•í•˜ê³  ìˆìœ¼ë‚˜, ë‹¤ìŒ **3ê°€ì§€ Critical ì´ìŠˆ**ê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤:

1. **ì•„í‚¤í…ì²˜ ë²„ì „ ë¶ˆì¼ì¹˜** (v2.1 vs v3.0): Nginx ë¼ìš°íŒ… ë° OHIF í†µí•© ì „ëµ ì¶©ëŒ
2. **Secure Proxy íŒ¨í„´ ëª¨ìˆœ**: OHIF â†” Orthanc ì ‘ê·¼ ë°©ì‹ ë¶ˆëª…í™• (JWT vs X-Accel-Redirect)
3. **HTJ2K ë³€í™˜ êµ¬í˜„ ëˆ„ë½**: Celery ë³€í™˜ íŒŒì´í”„ë¼ì¸ì˜ ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­ ë¯¸ëª…ì‹œ

**ì¦‰ì‹œ ì¡°ì¹˜ í•„ìš”**: ì•„í‚¤í…ì²˜ ì¬í™•ì • ë° ë¬¸ì„œ í†µì¼ (ì˜ˆìƒ ì†Œìš”: 3ì¼)

---

## ğŸ” 1. ì˜¤ë¥˜ ë¦¬ìŠ¤íŠ¸ (ë°œê²¬ëœ ë¬¸ì œ 19ê°œ)

### Critical (ì¦‰ì‹œ í•´ê²° í•„ìš”) âš ï¸

| # | ë¬¸ì œ | ì˜í–¥ë„ | í•´ê²° ë°©ë²• |
|---|------|--------|----------|
| 1 | **v2.1 vs v3.0 Nginx ë¼ìš°íŒ… ë¶ˆì¼ì¹˜** | ë°°í¬ ì‹¤íŒ¨ ìœ„í—˜ | v3.0ìœ¼ë¡œ í†µì¼ & êµ¬í˜„ ì™„ë£Œ í›„ ë¬¸ì„œ ì—…ë°ì´íŠ¸ |
| 2 | **OHIF Secure Proxy vs JWT í† í° ëª¨ìˆœ** | ë³´ì•ˆ êµ¬ë© ê°€ëŠ¥ì„± | ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ ì‘ì„± & ì‹¤ì œ êµ¬í˜„ ê²€ì¦ |
| 3 | **FastAPI í†µì‹  ë°©ì‹ ë¯¸ëª…ì‹œ** (Celery â†” FastAPI) | êµ¬í˜„ ë¶ˆê°€ëŠ¥ | FastAPI ì—”ë“œí¬ì¸íŠ¸ ë° í†µì‹  í”„ë¡œí† ì½œ ëª…ì‹œ |
| 4 | **Celery í™˜ê²½ ê²©ë¦¬ ë¶€ì¡±** (ë¡œì»¬ venv ê³µìœ ) | ë³´ì•ˆ ìœ„í—˜ | Docker ì»¨í…Œì´ë„ˆ ë¶„ë¦¬ ì¬ë„ì… ê²€í†  |

### High (ìš°ì„  í•´ê²°) ğŸ”´

| # | ë¬¸ì œ | í•´ê²° ë°©ë²• |
|---|------|----------|
| 5 | FHIR êµ¬í˜„ ìƒíƒœ ë¶ˆëª…í™• ("âœ… êµ¬í˜„" vs "âŒ TODO") | ì‹¤ì œ ì½”ë“œ ê²€ì¦ í›„ ë¬¸ì„œ í™•ì • |
| 6 | Outbox íŒ¨í„´ vs Write-Through íŒ¨í„´ í˜¼ì¬ | ì ìš© ë²”ìœ„ ëª…í™•íˆ êµ¬ë¶„ (í‘œ ì‘ì„±) |
| 7 | HTJ2K ë³€í™˜ ë„êµ¬ ë¯¸ëª…ì‹œ (pylibjpeg? dcmj2pnm?) | ë³€í™˜ ë„êµ¬ ì„ ì • & ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ |
| 8 | OpenEMR ì¥ì•  ì‹œ ìµœëŒ€ 16ë¶„ ë°ì´í„° ë¶ˆì¼ì¹˜ | ìºì‹œ ì •ì±… ë˜ëŠ” Read Replica ê²€í†  |
| 9 | Multi-SPA vs Unified React ì „ëµ ì¶©ëŒ | v3.0 Unified React êµ¬í˜„ ì™„ë£Œ í›„ v2.1 ë¬¸ì„œ íê¸° |

### Medium (ê°œì„  ê¶Œì¥) ğŸŸ¡

| # | ë¬¸ì œ | í•´ê²° ë°©ë²• |
|---|------|----------|
| 10 | `/internal-orthanc/` ë¼ìš°íŠ¸ì™€ JWT URL ê´€ê³„ ëª¨í˜¸ | Nginx ì„¤ì • ì˜ˆì‹œ ë° í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì¶”ê°€ |
| 11 | X-Accel-Redirect ë™ì‘ ì›ë¦¬ ë¶ˆì¶©ë¶„ | HTTP í—¤ë” íë¦„ ìƒì„¸ ì„¤ëª… |
| 12 | Django â†” OpenEMR ì§ì ‘ ê²°í•© (Circuit Breaker ë¶€ì¬) | ì„œí‚· ë¸Œë ˆì´ì»¤ íŒ¨í„´ ë„ì… ê²€í†  |
| 13 | ì„±ëŠ¥ ì§€í‘œ ë¶€ì¬ (HTJ2K ë³€í™˜ ì‹œê°„ ë“±) | SLA ë¬¸ì„œ ì‘ì„± & ë²¤ì¹˜ë§ˆí¬ ì‹¤í–‰ |
| 14 | ë¬¸ì„œ ë²„ì „ ê´€ë¦¬ ì‹œìŠ¤í…œ ë¶€ì¬ | Changelog ë„ì… (ê° ë¬¸ì„œì— ë³€ê²½ ì´ë ¥ ì„¹ì…˜) |

### Low (ì¥ê¸° ê°œì„ ) ğŸŸ¢

| # | ë¬¸ì œ | í•´ê²° ë°©ë²• |
|---|------|----------|
| 15 | AI ê²°ê³¼ ì €ì¥ ìœ„ì¹˜ ë¶ˆëª…í™• (Django? Orthanc? FHIR?) | ë°ì´í„° ëª¨ë¸ ëª…ì‹œ |
| 16 | WASM ë””ì½”ë” êµ¬ì²´ì  ì‘ë™ ë°©ì‹ ë¯¸ì„¤ëª… | OHIF ì»¤ìŠ¤í…€ Extension ë¬¸ì„œ ì‘ì„± |
| 17 | Celery Beat ìŠ¤ì¼€ì¤„ ì¶©ëŒ ê°€ëŠ¥ì„± (5ë¶„ ì£¼ê¸° ì¤‘ë³µ) | ìŠ¤ì¼€ì¤„ í†µí•© ê´€ë¦¬ í‘œ ì‘ì„± |
| 18 | Redis ì•”í˜¸í™” ë¯¸ì ìš© | ë¯¼ê° ë°ì´í„° ì•”í˜¸í™” ì •ì±… ìˆ˜ë¦½ |
| 19 | ìˆœí™˜ ì°¸ì¡° ê°€ëŠ¥ì„± (Django â†” Celery â†” FastAPI?) | ì˜ì¡´ì„± ê·¸ë˜í”„ ì‹œê°í™” |

---

## ğŸ“Š 2. êµ¬ì¡° ìš”ì•½ (í…ìŠ¤íŠ¸ íë¦„ë„)

### 2.1 ì „ì²´ ì‹œìŠ¤í…œ íë¦„ (í˜„ì¬ v2.1 ê¸°ì¤€)

```
[ì‚¬ìš©ì (ë¸Œë¼ìš°ì €)]
    â†“ HTTPS
[Cloudflare (CDN + WAF)]
    â†“ HTTPS
[Nginx (Reverse Proxy + X-Accel-Redirect)]
    â”œâ”€ / â†’ React Main App (ì •ì  íŒŒì¼)
    â”œâ”€ /pacs-viewer/ â†’ OHIF Viewer (ì •ì  íŒŒì¼, v2.1 Multi-SPA)
    â”œâ”€ /api/* â†’ Django (JWT ì¸ì¦ + Proxy)
    â””â”€ /internal-orthanc/* â†’ Orthanc (ë‚´ë¶€ ì „ìš©, ì™¸ë¶€ ì ‘ê·¼ ì°¨ë‹¨)

[Django REST Framework]
    â”œâ”€ MySQL (cdss_db): í™˜ì, ì²˜ë°©, AI Job, ê°ì‚¬ ë¡œê·¸
    â”œâ”€ OpenEMR (ì™¸ë¶€ DB): ì§„ë£Œ ê¸°ë¡, í™˜ì ìƒì„¸ (ë³‘ë ¬ ì €ì¥)
    â”œâ”€ HAPI FHIR (ì™¸ë¶€ ì„œë¹„ìŠ¤): FHIR ë¦¬ì†ŒìŠ¤ ë™ê¸°í™” (Outbox íŒ¨í„´)
    â”œâ”€ Orthanc (DICOM ì„œë²„): DICOM Raw + HTJ2K (Secure Proxy)
    â””â”€ Redis (ìºì‹œ + Celery ë¸Œë¡œì»¤)

[Celery (ë¡œì»¬ venv)]
    â”œâ”€ Worker: FHIR ë™ê¸°í™”, AI Job ì²˜ë¦¬, HTJ2K ë³€í™˜ (?)
    â”œâ”€ Beat: ì£¼ê¸°ì  ì‘ì—… ìŠ¤ì¼€ì¤„ëŸ¬ (5ë¶„, 3ë¶„, ìƒˆë²½ 2ì‹œ/3ì‹œ)
    â””â”€ Flower: ëª¨ë‹ˆí„°ë§ UI

[FastAPI (AI ì¶”ë¡  ì„œë²„)]
    â”œâ”€ ? â†’ Celeryë¡œë¶€í„° ìš”ì²­ ìˆ˜ì‹  (ë°©ì‹ ë¶ˆëª…í™•)
    â””â”€ ? â†’ HTJ2K ë””ì½”ë”© + AI ëª¨ë¸ ì¶”ë¡  (?)
```

**ë¬¸ì œì  ìš”ì•½**:
- OHIFê°€ Orthancì— ì§ì ‘ ì ‘ê·¼í•˜ëŠ”ì§€, Django Proxyë¥¼ ê±°ì¹˜ëŠ”ì§€ ë¶ˆëª…í™•
- FastAPIê°€ ì–´ë””ì— ë°°í¬ë˜ëŠ”ì§€, ì–´ë–»ê²Œ í†µì‹ í•˜ëŠ”ì§€ ë¯¸ëª…ì‹œ
- HTJ2K ë³€í™˜ì´ Celeryì—ì„œ ìˆ˜í–‰ë˜ëŠ”ì§€ Orthanc ìì²´ ê¸°ëŠ¥ì¸ì§€ ëª¨í˜¸

---

### 2.2 DICOM ì—…ë¡œë“œ & ë·°ì‰ íë¦„ (v2.1 vs ì‹¤ì œ êµ¬í˜„ ê²€ì¦ í•„ìš”)

#### ì‹œë‚˜ë¦¬ì˜¤ A: ì—…ë¡œë“œ (Django â†’ Celery â†’ Orthanc)

```
[ì‚¬ìš©ì] â†’ DICOM íŒŒì¼ ì—…ë¡œë“œ (POST /api/ris/upload)
    â†“
[Django RIS View]
    â†“ (1) Raw DICOM ì„ì‹œ ì €ì¥ (Django íŒŒì¼ ì‹œìŠ¤í…œ)
    â†“ (2) Celery Task íŠ¸ë¦¬ê±° (ë¹„ë™ê¸°)
    â†“
[Celery Worker]
    â†“ (3) Raw DICOM â†’ HTJ2K ë³€í™˜ â“ (ë„êµ¬: pylibjpeg? dcmj2pnm?)
    â†“ (4) HTJ2K íŒŒì¼ â†’ Orthancì— ì—…ë¡œë“œ (POST /instances)
    â†“
[Orthanc PACS]
    â†“ (5) HTJ2K ì €ì¥ (Primary Storage)
    â†“ (6) Raw DICOM ë³´ê´€ (Original Storage, ì„ íƒì )
    â†“
[Django RIS]
    â† (7) Celery ì™„ë£Œ ì½œë°± (ë™ê¸°í™”)
    â†“ (8) RIS DB ì—…ë°ì´íŠ¸ (RadiologyStudy í…Œì´ë¸”)
```

**ê¸°ìˆ ì  ë¶ˆëª…í™• ì‚¬í•­**:
- â“ HTJ2K ë³€í™˜ ë„êµ¬ê°€ ë¬´ì—‡ì¸ê°€?
- â“ Celery íƒœìŠ¤í¬ ì½”ë“œ ìœ„ì¹˜: `ris/tasks.py`? (ë¬¸ì„œì— ë¯¸ëª…ì‹œ)
- â“ ë³€í™˜ ì‹œê°„: 100MB DICOM â†’ HTJ2K ë³€í™˜ì— ëª‡ ì´ˆ?

---

#### ì‹œë‚˜ë¦¬ì˜¤ B: ë·°ì‰ (OHIF â†” Django â†” Nginx â†” Orthanc)

**v2.1 ë¬¸ì„œ ì„¤ëª… (Secure Proxy íŒ¨í„´)**:

```
[OHIF Viewer (ë¸Œë¼ìš°ì €)]
    â†“ (1) ì´ë¯¸ì§€ ìš”ì²­ (GET /api/ris/dicom-web/studies/{studyUID}/series/...)
    â†“
[Django Proxy View]
    â†“ (2) JWT ì¸ì¦ ê²€ì¦ (Bearer Token)
    â†“ (3) X-Accel-Redirect í—¤ë” ë°˜í™˜
    â†“      Header: X-Accel-Redirect: /internal-orthanc/dicom-web/...
    â†“      Body: (ë¹ˆ ì‘ë‹µ)
    â†“
[Nginx]
    â†“ (4) X-Accel-Redirect í—¤ë” ì¸í„°ì…‰íŠ¸
    â†“ (5) /internal-orthanc/ â†’ http://orthanc:8042/dicom-web/... ë‚´ë¶€ í”„ë¡ì‹œ
    â†“
[Orthanc PACS]
    â†“ (6) HTJ2K ë°ì´í„° ì¡°íšŒ (DICOMweb WADO-RS)
    â†“
[Nginx]
    â† (7) HTJ2K ë°”ì´ë„ˆë¦¬ ë°ì´í„° ìˆ˜ì‹ 
    â†“ (8) í´ë¼ì´ì–¸íŠ¸(OHIF)ì— ìŠ¤íŠ¸ë¦¬ë° ì „ì†¡
    â†“
[OHIF Viewer]
    â† (9) HTJ2K ìˆ˜ì‹ 
    â†“ (10) WASM ë””ì½”ë”ë¡œ ë””ì½”ë”© â“ (êµ¬ì²´ì  ë¼ì´ë¸ŒëŸ¬ë¦¬?)
    â†“ (11) Canvasì— ë Œë”ë§
```

**ë°œê²¬ëœ ëª¨ìˆœ**:

**ëª¨ìˆœ 1: JWT URL vs Secure Proxy**

```
18_Orthanc_JWT_URL_ê´€ë¦¬.md:
- OHIFê°€ Djangoë¡œë¶€í„° JWT ì•”í˜¸í™”ëœ URLì„ ë°›ìŒ
- OHIFê°€ Orthancì— ì§ì ‘ ì ‘ê·¼ (external ì ‘ê·¼)

vs

06_ì‹œìŠ¤í…œ_ì•„í‚¤í…ì²˜_v2.md:
- OHIFê°€ Django Proxyë¥¼ í†µí•´ ì ‘ê·¼
- OrthancëŠ” internal ë¼ìš°íŠ¸ë§Œ ì¡´ì¬ (ì™¸ë¶€ ì°¨ë‹¨)

ì§ˆë¬¸: OHIFê°€ ì–´ë–»ê²Œ Orthancì— ì ‘ê·¼í•˜ëŠ”ê°€?
```

**ì¶”ì • í•´ê²°ì±…**:
```
ê°€ëŠ¥ì„± A: JWT URLì€ Django Proxy ê²½ìœ  URL
ì˜ˆ: https://cdss.hospital.com/api/ris/dicom-web/...?token=JWT_TOKEN
â†’ Djangoê°€ í† í° ê²€ì¦ í›„ X-Accel-Redirect

ê°€ëŠ¥ì„± B: JWT URLì€ Nginx ì§ì ‘ ì ‘ê·¼ URL (ë³„ë„ ë¼ìš°íŠ¸)
ì˜ˆ: https://cdss.hospital.com/orthanc-external/...?token=JWT_TOKEN
â†’ Nginxê°€ JWT ê²€ì¦ í›„ Orthanc í”„ë¡ì‹œ (nginx-lua ëª¨ë“ˆ í•„ìš”)
```

**ê¶Œì¥**: ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ ì‘ì„± ë° ì‹¤ì œ ì½”ë“œ ê²€ì¦ í•„ìš”

---

### 2.3 AI ì¶”ë¡  íë¦„ (FastAPI í†µì‹  ë¶ˆëª…í™•)

```
[Django AI View]
    â†“ (1) AI Job ìƒì„± (POST /api/ai/jobs/)
    â†“ (2) Celery Task íŠ¸ë¦¬ê±° (ë¹„ë™ê¸°)
    â†“
[Celery Worker]
    â†“ (3) Orthancì—ì„œ DICOM ì¡°íšŒ (GET /instances/...)
    â†“ (4) HTJ2K â†’ NumPy Array ë³€í™˜ â“
    â†“ (5) FastAPIë¡œ ì¶”ë¡  ìš”ì²­ â“â“â“ (HTTP? gRPC? ì§ì ‘ í•¨ìˆ˜ í˜¸ì¶œ?)
    â†“
[FastAPI AI Server]
    â†“ (6) AI ëª¨ë¸ ì¶”ë¡  (TensorFlow? PyTorch?)
    â†“ (7) ê²°ê³¼ ë°˜í™˜ (Segmentation Map, ìœ„í—˜ë„ ì ìˆ˜)
    â†“
[Celery Worker]
    â† (8) ì¶”ë¡  ê²°ê³¼ ìˆ˜ì‹ 
    â†“ (9) ê²°ê³¼ ì €ì¥ â“ (ì–´ë””ì—? Django? Orthanc? FHIR?)
    â†“
[Django AI View]
    â† (10) Celery ì™„ë£Œ ì½œë°±
    â†“ (11) AIJob ìƒíƒœ ì—…ë°ì´íŠ¸ (COMPLETED)
```

**ê¸°ìˆ ì  ë¶ˆëª…í™• ì‚¬í•­**:
- â“â“â“ Celery â†’ FastAPI í†µì‹  ë°©ì‹ (HTTP REST? gRPC? ì§ì ‘ import?)
- â“ FastAPI ë°°í¬ ìœ„ì¹˜ (Docker? VM? ì™¸ë¶€ ì„œë²„?)
- â“ AI ê²°ê³¼ ì €ì¥ ìœ„ì¹˜ (Django AIJob ëª¨ë¸? Orthanc Secondary Capture? FHIR DiagnosticReport?)
- â“ HTJ2K â†’ NumPy ë³€í™˜ ë„êµ¬ (pylibjpeg? pillow?)

---

### 2.4 FHIR ë™ê¸°í™” íë¦„ (Outbox íŒ¨í„´)

```
[Django EMR View]
    â†“ (1) í™˜ì ìƒì„± (POST /api/emr/patients/)
    â†“ (2) Django MySQL ì €ì¥ (PatientCache í…Œì´ë¸”)
    â†“ (3) OpenEMR ë™ê¸° ì €ì¥ (ë³‘ë ¬ Write-Through)
    â†“ (4) SyncOutbox í ìƒì„± (FHIR ë™ê¸°í™” ì‘ì—…)
    â†“
[Celery Beat]
    â†“ (5ë¶„ë§ˆë‹¤) Outbox í ìŠ¤ìº”
    â†“
[Celery Worker]
    â†“ (5) FHIR ë¦¬ì†ŒìŠ¤ ë³€í™˜ (PatientCache â†’ FHIR Patient)
    â†“ (6) HAPI FHIR ì„œë²„ë¡œ ì „ì†¡ (POST /fhir/Patient)
    â†“
[HAPI FHIR Server]
    â†“ (7) FHIR ë¦¬ì†ŒìŠ¤ ì €ì¥
    â†“
[Celery Worker]
    â† (8) ì„±ê³µ/ì‹¤íŒ¨ ì‘ë‹µ
    â†“ (9) SyncOutbox ìƒíƒœ ì—…ë°ì´íŠ¸ (SUCCESS / RETRY / FAILED)
```

**ë¬¸ì œì **:
- ìµœëŒ€ 16ë¶„ ë°ì´í„° ë¶ˆì¼ì¹˜ (5íšŒ ì¬ì‹œë„ Ã— ì§€ìˆ˜ ë°±ì˜¤í”„)
- ì¥ê¸° ë„¤íŠ¸ì›Œí¬ ì¥ì•  ì‹œ ìˆ˜ë™ ê°œì… í•„ìš”
- Read Replica ë˜ëŠ” Eventual Consistency ì •ì±… ë¯¸ëª…ì‹œ

---

## ğŸ¨ 3. ì‹œê°í™” (Mermaid Diagrams)

### 3.1 ì „ì²´ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```mermaid
graph TD
    User[ì‚¬ìš©ì ë¸Œë¼ìš°ì €] -->|HTTPS| Cloudflare[Cloudflare CDN/WAF]
    Cloudflare -->|HTTPS| Nginx[Nginx Reverse Proxy]

    Nginx -->|Static Files| React[React Main App]
    Nginx -->|Static Files| OHIF[OHIF Viewer v2.1]
    Nginx -->|/api/*| Django[Django REST API]
    Nginx -.->|internal only| Orthanc[Orthanc PACS]

    Django -->|Primary DB| MySQL[(MySQL cdss_db)]
    Django -->|Cache + Broker| Redis[(Redis)]
    Django -->|Parallel Write| OpenEMR[OpenEMR FHIR API]
    Django -->|Outbox Pattern| HAPI[HAPI FHIR Server]
    Django -.->|X-Accel-Redirect| Nginx

    Redis -->|Task Queue| Celery[Celery Worker]
    Celery -->|5min beat| Beat[Celery Beat]
    Celery -->|???| FastAPI[FastAPI AI Server]
    Celery -->|Upload HTJ2K| Orthanc
    Celery -->|FHIR Sync| HAPI

    OHIF -.->|??? JWT or Proxy| Orthanc

    style Django fill:#4CAF50
    style Celery fill:#FF9800
    style Orthanc fill:#2196F3
    style FastAPI fill:#F44336,color:#fff

    classDef unclear fill:#FFEB3B,stroke:#F57C00,stroke-width:3px
    class FastAPI,OHIF unclear
```

**ë²”ë¡€**:
- ğŸŸ¢ ë…¹ìƒ‰: ëª…í™•íˆ ë¬¸ì„œí™”ë¨
- ğŸŸ  ì£¼í™©: ì¼ë¶€ ë¶ˆëª…í™•
- ğŸ”´ ë¹¨ê°•: ê¸°ìˆ ì  ì„¸ë¶€ì‚¬í•­ ëˆ„ë½
- ğŸŸ¡ ë…¸ë‘ í…Œë‘ë¦¬: Critical ì´ìŠˆ (FastAPI, OHIF í†µì‹ )

---

### 3.2 DICOM ì´ë¯¸ì§€ ë·°ì‰ ì‹œí€€ìŠ¤ (Secure Proxy íŒ¨í„´)

```mermaid
sequenceDiagram
    participant User as ì‚¬ìš©ì ë¸Œë¼ìš°ì €
    participant OHIF as OHIF Viewer
    participant Nginx as Nginx
    participant Django as Django Proxy
    participant Orthanc as Orthanc PACS

    User->>OHIF: 1. Study ì„ íƒ í´ë¦­
    OHIF->>Django: 2. GET /api/ris/dicom-web/studies/{studyUID}/...
    Note over OHIF,Django: Authorization: Bearer JWT_TOKEN

    Django->>Django: 3. JWT ì¸ì¦ ê²€ì¦
    Django->>Nginx: 4. X-Accel-Redirect í—¤ë” ë°˜í™˜
    Note over Django,Nginx: X-Accel-Redirect: /internal-orthanc/dicom-web/...
    Note over Django,Nginx: (ë¹ˆ Body, í—¤ë”ë§Œ)

    Nginx->>Nginx: 5. í—¤ë” ì¸í„°ì…‰íŠ¸
    Nginx->>Orthanc: 6. ë‚´ë¶€ í”„ë¡ì‹œ ìš”ì²­
    Note over Nginx,Orthanc: http://orthanc:8042/dicom-web/...

    Orthanc->>Orthanc: 7. HTJ2K ë°ì´í„° ì¡°íšŒ
    Orthanc-->>Nginx: 8. HTJ2K ë°”ì´ë„ˆë¦¬ ë°˜í™˜
    Nginx-->>OHIF: 9. HTJ2K ìŠ¤íŠ¸ë¦¬ë°

    OHIF->>OHIF: 10. WASM ë””ì½”ë”© (?)
    OHIF->>User: 11. Canvas ë Œë”ë§

    rect rgb(255, 235, 59)
        Note over OHIF,Orthanc: âš ï¸ ëª¨ìˆœ: JWT URL ë°©ì‹ê³¼ ì¶©ëŒ
    end
```

---

### 3.3 AI ì¶”ë¡  ì›Œí¬í”Œë¡œìš° (FastAPI í†µì‹  ë¶ˆëª…í™•)

```mermaid
sequenceDiagram
    participant Doctor as ì˜ì‚¬
    participant Django as Django AI View
    participant Celery as Celery Worker
    participant Orthanc as Orthanc PACS
    participant FastAPI as FastAPI AI Server
    participant DB as Django MySQL

    Doctor->>Django: 1. AI ë¶„ì„ ìš”ì²­<br/>(POST /api/ai/jobs/)
    Django->>DB: 2. AIJob ìƒì„±<br/>(status=PENDING)
    Django->>Celery: 3. process_ai_job.delay(job_id)
    Django-->>Doctor: 4. 202 Accepted<br/>(job_id ë°˜í™˜)

    Celery->>Orthanc: 5. DICOM ì¡°íšŒ<br/>(GET /instances/{id}/file)
    Orthanc-->>Celery: 6. HTJ2K ë°”ì´ë„ˆë¦¬

    Celery->>Celery: 7. HTJ2K â†’ NumPy ë³€í™˜ (?)

    rect rgb(244, 67, 54)
        Celery->>FastAPI: 8. ??? ì¶”ë¡  ìš”ì²­ ???<br/>(HTTP? gRPC? í•¨ìˆ˜ í˜¸ì¶œ?)
        Note over Celery,FastAPI: âš ï¸ Critical: í†µì‹  ë°©ì‹ ë¯¸ëª…ì‹œ
        FastAPI-->>Celery: 9. ??? ê²°ê³¼ ë°˜í™˜ ???
    end

    Celery->>DB: 10. AIJob ì—…ë°ì´íŠ¸<br/>(status=COMPLETED, result=...)
    Celery->>Django: 11. ì½œë°± (ì„ íƒ)

    Doctor->>Django: 12. ê²°ê³¼ ì¡°íšŒ<br/>(GET /api/ai/jobs/{job_id}/)
    Django->>DB: 13. AIJob SELECT
    DB-->>Django: 14. ê²°ê³¼ ë°˜í™˜
    Django-->>Doctor: 15. 200 OK (AI ê²°ê³¼)
```

---

### 3.4 FHIR ë™ê¸°í™” (Outbox íŒ¨í„´)

```mermaid
graph LR
    subgraph "Django ë™ê¸° ì²˜ë¦¬"
        A[í™˜ì ìƒì„± ìš”ì²­] --> B[Django MySQL ì €ì¥]
        B --> C[OpenEMR FHIR API í˜¸ì¶œ]
        C --> D[SyncOutbox í ìƒì„±]
    end

    subgraph "Celery ë¹„ë™ê¸° ì²˜ë¦¬"
        E[Celery Beat<br/>5ë¶„ë§ˆë‹¤] --> F{Outbox ìŠ¤ìº”}
        F -->|PENDING| G[FHIR ë³€í™˜]
        G --> H[HAPI FHIR ì „ì†¡]
        H -->|ì„±ê³µ| I[ìƒíƒœ: SUCCESS]
        H -->|ì‹¤íŒ¨| J[ì¬ì‹œë„ í]
        J -->|5íšŒ ì´ˆê³¼| K[ìƒíƒœ: FAILED<br/>ìˆ˜ë™ ê°œì…]
    end

    D -.-> F

    style B fill:#4CAF50
    style C fill:#FF9800
    style H fill:#2196F3
    style K fill:#F44336,color:#fff

    classDef warning fill:#FFEB3B,stroke:#F57C00,stroke-width:2px
    class K warning
```

**ë¬¸ì œì  ê°•ì¡°**:
- ğŸŸ¡ ë…¸ë‘: ìµœëŒ€ 16ë¶„ ë°ì´í„° ë¶ˆì¼ì¹˜ ê°€ëŠ¥
- ğŸ”´ ë¹¨ê°•: 5íšŒ ì‹¤íŒ¨ ì‹œ ìˆ˜ë™ ê°œì… í•„ìš”

---

## ğŸ”§ 4. ê¸°ìˆ ì  ì˜¤ë¥˜ ìƒì„¸ ë¶„ì„

### 4.1 v2.1 vs v3.0 Nginx ë¼ìš°íŒ… ë¶ˆì¼ì¹˜

#### í˜„ì¬ ìƒíƒœ (v2.1)

**08_ë°°í¬_ì™€_ìš´ì˜_ìš”ì•½.md (v2.1)**:
```nginx
# Nginx ì„¤ì • (v2.1 Multi-SPA)
location / {
    root /var/www/react-main/;
    try_files $uri $uri/ /index.html;
}

location /pacs-viewer/ {
    alias /var/www/ohif-dist/;
    try_files $uri $uri/ /pacs-viewer/index.html;
}

location /api/ {
    proxy_pass http://django:8000/api/;
}

location /internal-orthanc/ {
    internal;
    proxy_pass http://orthanc:8042/;
}
```

#### ê³„íš ìƒíƒœ (v3.0)

**07_ì„œë¹„ìŠ¤_êµ¬ì¡°_ìš”ì•½.md (v3.0 Unified React)**:
```nginx
# Nginx ì„¤ì • (v3.0 Single SPA)
location / {
    root /var/www/react-unified/;
    try_files $uri $uri/ /index.html;
}

# /pacs-viewer/ ë¼ìš°íŠ¸ ì œê±° (React Routerë¡œ í†µí•©)

location /api/ {
    proxy_pass http://django:8000/api/;
}

location /internal-orthanc/ {
    internal;
    proxy_pass http://orthanc:8042/;
}
```

**React Router (v3.0)**:
```javascript
// App.js
<Routes>
  <Route path="/" element={<DashboardPage />} />
  <Route path="/viewer/:studyInstanceUID" element={<ViewerPage />} />
  {/* OHIFëŠ” ViewerPage ì»´í¬ë„ŒíŠ¸ ë‚´ë¶€ì—ì„œ ë¡œë”© */}
</Routes>
```

**ë¬¸ì œì **:
- 06_ì‹œìŠ¤í…œ_ì•„í‚¤í…ì²˜_v2.mdëŠ” v2.1 ê¸°ì¤€
- 08_ë°°í¬_ì™€_ìš´ì˜_ìš”ì•½.mdëŠ” v2.1 ê¸°ì¤€
- 07_ì„œë¹„ìŠ¤_êµ¬ì¡°_ìš”ì•½.mdë§Œ v3.0 ê¸°ì¤€
- **ì‹¤ì œ êµ¬í˜„ ìƒíƒœê°€ ì–´ëŠ ë²„ì „ì¸ì§€ ë¶ˆëª…í™•**

**ê¶Œì¥ ì¡°ì¹˜**:
1. v3.0 Unified React êµ¬í˜„ ì™„ë£Œ í™•ì¸
2. êµ¬í˜„ ì™„ë£Œ ì‹œ: 06, 08 ë¬¸ì„œë¥¼ v3.0ìœ¼ë¡œ ì—…ë°ì´íŠ¸
3. ë¯¸êµ¬í˜„ ì‹œ: 07 ë¬¸ì„œë¥¼ v2.1ë¡œ ë¡¤ë°±

---

### 4.2 Secure Proxy íŒ¨í„´ ëª¨ìˆœ

#### ëª¨ìˆœì˜ ê·¼ì›

**06_ì‹œìŠ¤í…œ_ì•„í‚¤í…ì²˜_v2.md**:
```
OHIFê°€ Django Proxyë¥¼ í†µí•´ ì´ë¯¸ì§€ ìš”ì²­
â†’ Djangoê°€ X-Accel-Redirect í—¤ë” ë°˜í™˜
â†’ Nginxê°€ Orthancì—ì„œ ë°ì´í„° ì¡°íšŒ
â†’ í´ë¼ì´ì–¸íŠ¸(OHIF)ì— ìŠ¤íŠ¸ë¦¬ë°
```

**18_Orthanc_JWT_URL_ê´€ë¦¬.md**:
```python
# Django ì½”ë“œ ì˜ˆì‹œ
def get_study_url_with_jwt(study_instance_uid):
    jwt_token = orthanc_client.generate_jwt_token(
        study_instance_uid,
        lifetime_hours=1
    )
    return f"https://orthanc.cdss.com/dicom-web/studies/{study_instance_uid}?token={jwt_token}"
```

**ë¬¸ì œ**:
- JWT URLì€ `orthanc.cdss.com` (ì™¸ë¶€ ë„ë©”ì¸)ì„ ê°€ë¦¬í‚´
- í•˜ì§€ë§Œ Nginx ì„¤ì •ì—ì„œ OrthancëŠ” `internal` ë¼ìš°íŠ¸ë§Œ ì¡´ì¬
- **OHIFê°€ ì–´ë–»ê²Œ Orthancì— ì ‘ê·¼í•˜ëŠ”ê°€?**

#### ê°€ëŠ¥í•œ í•´ê²°ì±…

**í•´ê²°ì±… A: JWT URLì€ Django Proxy ê²½ìœ **

```python
# ì˜¬ë°”ë¥¸ êµ¬í˜„ (ì¶”ì •)
def get_study_url_with_jwt(study_instance_uid):
    # JWTëŠ” Django ì„¸ì…˜ í† í°
    jwt_token = generate_session_jwt(user, study_instance_uid)
    # URLì€ Django Proxy ê²½ë¡œ
    return f"https://cdss.hospital.com/api/ris/dicom-web/studies/{study_instance_uid}?token={jwt_token}"
```

```nginx
# Nginx ì„¤ì •
location /api/ris/dicom-web/ {
    proxy_pass http://django:8000/api/ris/dicom-web/;
    # Djangoê°€ JWT ê²€ì¦ í›„ X-Accel-Redirect ë°˜í™˜
}
```

**í•´ê²°ì±… B: Nginxê°€ JWT ì§ì ‘ ê²€ì¦ (nginx-lua)**

```nginx
location /orthanc-external/ {
    access_by_lua_block {
        local jwt_token = ngx.var.arg_token
        -- JWT ê²€ì¦ ë¡œì§
        if not verify_jwt(jwt_token) then
            ngx.exit(403)
        end
    }

    rewrite ^/orthanc-external/(.*)$ /$1 break;
    proxy_pass http://orthanc:8042;
}
```

**ê¶Œì¥**: ì‹¤ì œ êµ¬í˜„ì„ í™•ì¸í•˜ê³  ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ ì‘ì„±

---

### 4.3 HTJ2K ë³€í™˜ íŒŒì´í”„ë¼ì¸ ëˆ„ë½

#### ë¬¸ì„œì— ê¸°ìˆ ëœ ë‚´ìš©

**06_ì‹œìŠ¤í…œ_ì•„í‚¤í…ì²˜_v2.md**:
```
Celeryê°€ Raw DICOMì„ HTJ2Kë¡œ ë³€í™˜ (ì´ë¯¸ì§€ ë³€í™˜ ê³µì¥)
```

**43_ë°ì´í„°_íë¦„_ì•„í‚¤í…ì²˜.md**:
```
Celery ì—­í•  í™•ëŒ€: ì´ë¯¸ì§€ ë³€í™˜ ê³µì¥(Raw â†’ HTJ2K)
```

**ëˆ„ë½ëœ ì •ë³´**:
- â“ HTJ2K ë³€í™˜ ë¼ì´ë¸ŒëŸ¬ë¦¬: `pylibjpeg`? `openjpeg`? `dcmj2pnm`?
- â“ Celery íƒœìŠ¤í¬ êµ¬í˜„ ìœ„ì¹˜: `ris/tasks.py`?
- â“ ë³€í™˜ ì„±ëŠ¥: 100MB DICOM â†’ HTJ2K ë³€í™˜ ì‹œê°„?
- â“ Orthanc ìì²´ HTJ2K ì§€ì› ì—¬ë¶€ (ìµœì‹  ë²„ì „ì€ ìë™ ë³€í™˜ ê°€ëŠ¥)

#### Orthanc ìì²´ HTJ2K ì§€ì› ê°€ëŠ¥ì„±

**Orthanc ê³µì‹ ë¬¸ì„œ**:
```json
// orthanc.json
{
  "DeidentifyLogs": true,
  "Plugins": ["libOrthancJpeg2000.so"],
  "Jpeg2000TransferSyntaxes": ["1.2.840.10008.1.2.4.201"]
}
```

**ì¶”ì •**:
- Orthanc í”ŒëŸ¬ê·¸ì¸ìœ¼ë¡œ HTJ2K ìë™ ë³€í™˜ ê°€ëŠ¥
- CeleryëŠ” **ì—…ë¡œë“œë§Œ** ë‹´ë‹¹ (ë³€í™˜ì€ Orthancì— ìœ„ì„)

**ê¶Œì¥**: ì‹¤ì œ êµ¬í˜„ í™•ì¸ ë° ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬

---

### 4.4 FastAPI í†µì‹  ë°©ì‹ ë¯¸ëª…ì‹œ

#### ë¬¸ì„œ ê²€ìƒ‰ ê²°ê³¼

**32_Redis_Celery_í†µí•©_ê°€ì´ë“œ.md**:
```python
# Celery íƒœìŠ¤í¬ ì˜ˆì‹œ
@celery_app.task
def process_ai_job(job_id):
    # ...
    # FastAPI í˜¸ì¶œ ë¶€ë¶„ ì—†ìŒ
```

**ai/tasks.py (ì¶”ì •)**:
```python
# ì‹¤ì œ êµ¬í˜„ (ì¶”ì •)
import requests

@celery_app.task
def process_ai_job(job_id):
    # DICOM ì¡°íšŒ
    dicom_data = orthanc_client.get_instance(instance_id)

    # FastAPI í˜¸ì¶œ (HTTP)
    response = requests.post(
        "http://fastapi:8001/inference",
        json={"dicom": dicom_data}
    )

    # ê²°ê³¼ ì €ì¥
    result = response.json()
    AIJob.objects.filter(id=job_id).update(result=result)
```

**ë¬¸ì œì **:
- FastAPI ì—”ë“œí¬ì¸íŠ¸ URLì´ ë¬¸ì„œì— ì—†ìŒ
- FastAPI ë°°í¬ ìœ„ì¹˜ ë¶ˆëª…í™• (Docker? VM? ì™¸ë¶€?)
- ì—ëŸ¬ í•¸ë“¤ë§ ë°©ì‹ ë¯¸ëª…ì‹œ

**ê¶Œì¥**: FastAPI API ëª…ì„¸ì„œ ì‘ì„± (OpenAPI)

---

## ğŸ¯ 5. MSA ì„¤ê³„ ì›ì¹™ ìœ„ë°˜ ê²€í† 

### 5.1 ì„œë¹„ìŠ¤ ê°„ ê²°í•©ë„ (Coupling) ë¶„ì„

```mermaid
graph TD
    Django[Django<br/>REST API]
    Celery[Celery<br/>Worker]
    MySQL[(MySQL<br/>cdss_db)]
    Redis[(Redis)]
    OpenEMR[OpenEMR<br/>FHIR API]
    HAPI[HAPI<br/>FHIR Server]
    Orthanc[Orthanc<br/>PACS]
    FastAPI[FastAPI<br/>AI Server]

    Django -->|Strong| MySQL
    Django -->|Strong| Redis
    Django -->|Strong| OpenEMR
    Django -.->|Medium| HAPI
    Django -.->|Medium| Orthanc

    Celery -->|Strong| Redis
    Celery -->|Strong| MySQL
    Celery -->|Medium| OpenEMR
    Celery -->|Medium| HAPI
    Celery -->|Medium| Orthanc
    Celery -.->|???| FastAPI

    style Django fill:#4CAF50
    style Celery fill:#FF9800
    style FastAPI fill:#F44336,color:#fff

    classDef strong stroke:#F44336,stroke-width:4px
    classDef medium stroke:#FF9800,stroke-width:2px
    classDef weak stroke:#4CAF50,stroke-width:1px

    class MySQL,Redis,OpenEMR strong
    class HAPI,Orthanc medium
    class FastAPI weak
```

**ë²”ë¡€**:
- ğŸ”´ Strong Coupling: ì„œë¹„ìŠ¤ ë‹¤ìš´ ì‹œ ê¸°ëŠ¥ ë¶ˆê°€
- ğŸŸ  Medium Coupling: ì„œë¹„ìŠ¤ ë‹¤ìš´ ì‹œ ì¼ë¶€ ê¸°ëŠ¥ ì €í•˜
- ğŸŸ¢ Weak Coupling: ì„œë¹„ìŠ¤ ë‹¤ìš´ ì‹œ ì˜í–¥ ìµœì†Œ

### 5.2 ìœ„ë°˜ ì‚¬í•­

| # | ìœ„ë°˜ ë‚´ìš© | ì˜í–¥ | ê°œì„  ë°©ì•ˆ |
|---|----------|------|----------|
| 1 | **Django â†” OpenEMR ê°•ê²°í•©** | OpenEMR ë‹¤ìš´ ì‹œ í™˜ì ìˆ˜ì • ë¶ˆê°€ | Circuit Breaker íŒ¨í„´ ë„ì… |
| 2 | **Django â†” Celery í™˜ê²½ ê³µìœ ** | ë³´ì•ˆ ê²©ë¦¬ ë¶€ì¡± | Celery Docker ë¶„ë¦¬ |
| 3 | **HAPI FHIR ë™ê¸°í™” ì§€ì—°** (ìµœëŒ€ 16ë¶„) | ë°ì´í„° ì¼ê´€ì„± ë¬¸ì œ | Read Replica ë˜ëŠ” ìºì‹œ ì •ì±… |
| 4 | **FastAPI í†µì‹  ë¶ˆëª…í™•** | êµ¬í˜„ ë¶ˆê°€ëŠ¥ | API Gateway ë„ì… ê²€í†  |

---

## ğŸ“ 6. ê¶Œì¥ ì¡°ì¹˜ ì‚¬í•­

### ì¦‰ì‹œ ì¡°ì¹˜ (3ì¼ ì´ë‚´) âš ï¸

#### 1. ì•„í‚¤í…ì²˜ ë²„ì „ í†µì¼
```bash
# ì‘ì—… ëª©ë¡
1. v3.0 Unified React êµ¬í˜„ ìƒíƒœ í™•ì¸
2. êµ¬í˜„ ì™„ë£Œ ì‹œ: 06, 08 ë¬¸ì„œë¥¼ v3.0ìœ¼ë¡œ ì—…ë°ì´íŠ¸
3. ë¯¸êµ¬í˜„ ì‹œ: 07 ë¬¸ì„œë¥¼ v2.1ë¡œ ë¡¤ë°± ë˜ëŠ” "ê³„íš" ì„¹ì…˜ìœ¼ë¡œ ì´ë™
4. Nginx ì„¤ì • íŒŒì¼ ì‹¤ì œ ë²„ì „ í™•ì¸ (nginx.conf)
```

#### 2. Secure Proxy ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ ì‘ì„±
```markdown
# ì‘ì„± í•„ìš” ë¬¸ì„œ
- DICOM_ë·°ì‰_ì‹œí€€ìŠ¤_ë‹¤ì´ì–´ê·¸ë¨.md
  - OHIF â†’ Django â†’ Nginx â†’ Orthanc íë¦„
  - X-Accel-Redirect ë™ì‘ ì›ë¦¬
  - JWT URL vs Proxy URL ëª…í™•í™”
```

#### 3. FastAPI API ëª…ì„¸ì„œ ì‘ì„±
```yaml
# FastAPI OpenAPI Spec (ì˜ˆì‹œ)
openapi: 3.0.0
info:
  title: NeuroNova AI Inference API
  version: 1.0.0

paths:
  /inference:
    post:
      summary: AI ì¶”ë¡  ìš”ì²­
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                instance_id:
                  type: string
                model_type:
                  type: string
                  enum: [stroke_risk, tumor_detection]
      responses:
        '200':
          description: ì¶”ë¡  ê²°ê³¼
          content:
            application/json:
              schema:
                type: object
                properties:
                  risk_score:
                    type: number
                  segmentation:
                    type: string
                    format: base64
```

---

### ë‹¨ê¸° ì¡°ì¹˜ (2ì£¼ ì´ë‚´) ğŸ”´

#### 4. HTJ2K ë³€í™˜ êµ¬í˜„ í™•ì¸
```python
# ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸
# ris/tasks.py í™•ì¸
def convert_dicom_to_htj2k(dicom_path):
    """
    Raw DICOM â†’ HTJ2K ë³€í™˜

    TODO:
    - ë³€í™˜ ë„êµ¬: pylibjpeg? openjpeg? Orthanc ìì²´?
    - ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬: 100MB DICOM â†’ ë³€í™˜ ì‹œê°„?
    - ì—ëŸ¬ ì²˜ë¦¬: ë³€í™˜ ì‹¤íŒ¨ ì‹œ Fallback?
    """
    pass
```

#### 5. FHIR êµ¬í˜„ ìƒíƒœ ê²€ì¦
```bash
# ê²€ì¦ ì‘ì—…
1. fhir/converters_extended.py ì½”ë“œ í™•ì¸
2. MedicationRequest, DiagnosticReport ë³€í™˜ ë¡œì§ ê²€ì¦
3. Celery Beat ìŠ¤ì¼€ì¤„ í™•ì¸ (celery.py)
4. HAPI FHIR ì„œë²„ ë™ê¸°í™” í…ŒìŠ¤íŠ¸ ì‹¤í–‰
5. ë¬¸ì„œ ì—…ë°ì´íŠ¸ (âœ… êµ¬í˜„ or âŒ TODO í™•ì •)
```

#### 6. Outbox íŒ¨í„´ ì„±ëŠ¥ ì¸¡ì •
```python
# ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸
def test_outbox_latency():
    """
    ì‹œë‚˜ë¦¬ì˜¤:
    1. í™˜ì 100ëª… ìƒì„±
    2. FHIR ë™ê¸°í™” ì™„ë£Œ ì‹œê°„ ì¸¡ì •
    3. ìµœëŒ€ ì§€ì—° ì‹œê°„ í™•ì¸ (16ë¶„ ì´ë‚´?)
    4. ì‹¤íŒ¨ìœ¨ ì¸¡ì •
    """
    pass
```

---

### ì¤‘ê¸° ì¡°ì¹˜ (1ê°œì›” ì´ë‚´) ğŸŸ¡

#### 7. Circuit Breaker íŒ¨í„´ ë„ì…
```python
# utils/circuit_breaker.py (ì˜ˆì‹œ)
from circuitbreaker import circuit

@circuit(failure_threshold=5, recovery_timeout=60)
def call_openemr_api(endpoint, data):
    """
    OpenEMR API í˜¸ì¶œ with Circuit Breaker

    5íšŒ ì—°ì† ì‹¤íŒ¨ ì‹œ 60ì´ˆ ë™ì•ˆ íšŒë¡œ ì°¨ë‹¨
    â†’ DjangoëŠ” ìºì‹œ ë°ì´í„°ë§Œ ì‚¬ìš© (Degraded Mode)
    """
    response = requests.post(f"{OPENEMR_URL}/{endpoint}", json=data)
    response.raise_for_status()
    return response.json()
```

#### 8. API Gateway ë„ì… ê²€í† 
```yaml
# API Gateway í›„ë³´
- Kong Gateway
- AWS API Gateway
- Tyk

ì¥ì :
- ì„œë¹„ìŠ¤ ê°„ í†µì‹  í‘œì¤€í™”
- ì¸ì¦/ì¸ê°€ ì¤‘ì•™ ê´€ë¦¬
- Rate Limiting
- ë¡œê¹…/ëª¨ë‹ˆí„°ë§ í†µí•©
```

---

## ğŸ“š 7. ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ì¦‰ì‹œ ì—…ë°ì´íŠ¸ í•„ìš” ë¬¸ì„œ

- [ ] **06_ì‹œìŠ¤í…œ_ì•„í‚¤í…ì²˜_v2.md**
  - v2.1 â†’ v3.0 ì—…ê·¸ë ˆì´ë“œ (v3.0 êµ¬í˜„ ì™„ë£Œ ì‹œ)
  - OHIF í†µí•© ì „ëµ ëª…í™•í™” (Multi-SPA vs Unified React)
  - Secure Proxy ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ ì¶”ê°€

- [ ] **07_ì„œë¹„ìŠ¤_êµ¬ì¡°_ìš”ì•½.md**
  - Nginx ë¼ìš°íŒ… ê·œì¹™ ì¬ê²€ì¦
  - v3.0 êµ¬í˜„ ì™„ë£Œ ì—¬ë¶€ í‘œì‹œ

- [ ] **08_ë°°í¬_ì™€_ìš´ì˜_ìš”ì•½.md**
  - v2.1 â†’ v3.0 ë°°í¬ ê°€ì´ë“œ ì—…ë°ì´íŠ¸
  - HTJ2K ë³€í™˜ ì„±ëŠ¥ ì§€í‘œ ì¶”ê°€

- [ ] **18_Orthanc_JWT_URL_ê´€ë¦¬.md**
  - JWT URLê³¼ Secure Proxyì˜ ê´€ê³„ ëª…í™•í™”
  - ì‹¤ì œ êµ¬í˜„ ì½”ë“œ ì˜ˆì‹œ ì¶”ê°€

- [ ] **31_FHIR_í†µí•©_ê°€ì´ë“œ.md**
  - êµ¬í˜„ ìƒíƒœ ì¬ê²€ì¦ (âœ… vs âŒ)
  - Outbox íŒ¨í„´ ì„±ëŠ¥ ì§€í‘œ ì¶”ê°€

- [ ] **32_Redis_Celery_í†µí•©_ê°€ì´ë“œ.md**
  - FastAPI í†µì‹  ë°©ì‹ ì¶”ê°€
  - Celery â†’ FastAPI API ëª…ì„¸ì„œ ë§í¬

### ì‹ ê·œ ì‘ì„± í•„ìš” ë¬¸ì„œ

- [ ] **45_DICOM_ë·°ì‰_ì‹œí€€ìŠ¤_ë‹¤ì´ì–´ê·¸ë¨.md**
  - OHIF â†’ Django â†’ Nginx â†’ Orthanc ìƒì„¸ íë¦„
  - X-Accel-Redirect ë™ì‘ ì›ë¦¬
  - JWT URL ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤

- [ ] **46_FastAPI_AI_ì„œë²„_ëª…ì„¸ì„œ.md**
  - API ì—”ë“œí¬ì¸íŠ¸ ì •ì˜ (OpenAPI)
  - Celery í†µì‹  í”„ë¡œí† ì½œ
  - ë°°í¬ ìœ„ì¹˜ ë° í™˜ê²½ ì„¤ì •

- [ ] **47_HTJ2K_ë³€í™˜_ê°€ì´ë“œ.md**
  - ë³€í™˜ ë„êµ¬ ì„ ì • (pylibjpeg vs Orthanc í”ŒëŸ¬ê·¸ì¸)
  - ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬ (ìš©ëŸ‰ë³„ ë³€í™˜ ì‹œê°„)
  - ì—ëŸ¬ ì²˜ë¦¬ ë° Fallback

- [ ] **48_ì„±ëŠ¥_SLA_ì •ì˜ì„œ.md**
  - API ì‘ë‹µ ì‹œê°„ ëª©í‘œ (99 percentile)
  - HTJ2K ë³€í™˜ ì‹œê°„ ëª©í‘œ
  - FHIR ë™ê¸°í™” ì§€ì—° í—ˆìš© í•œê³„
  - ê°€ìš©ì„± ëª©í‘œ (99.9%)

---

## ğŸ¯ 8. ê²°ë¡  ë° ìµœì¢… ê¶Œì¥ì‚¬í•­

### í˜„ì¬ ìƒíƒœ í‰ê°€

**ê°•ì ** âœ…:
- ì²´ê³„ì ì¸ MSA ì•„í‚¤í…ì²˜ ì„¤ê³„
- Secure Proxy íŒ¨í„´ ë„ì… (ë³´ì•ˆ ê°•í™”)
- Outbox íŒ¨í„´ ë„ì… (ë°ì´í„° ì¼ê´€ì„±)
- í’ë¶€í•œ ê¸°ìˆ  ë¬¸ì„œ (44ê°œ)

**ì•½ì ** âš ï¸:
- ë¬¸ì„œ ë²„ì „ ë¶ˆì¼ì¹˜ (v2.1 vs v3.0)
- í•µì‹¬ í†µì‹  ë°©ì‹ ë¯¸ëª…ì‹œ (FastAPI, OHIF)
- êµ¬í˜„ ìƒíƒœ ë¶ˆëª…í™• (FHIR, HTJ2K)
- ì„±ëŠ¥ ì§€í‘œ ë¶€ì¬

### ìµœìš°ì„  ì¡°ì¹˜ (Critical Path)

```mermaid
gantt
    title NeuroNova ì•„í‚¤í…ì²˜ ê°œì„  ë¡œë“œë§µ
    dateFormat  YYYY-MM-DD
    section Critical
    ì•„í‚¤í…ì²˜ ë²„ì „ í†µì¼           :crit, a1, 2026-01-03, 1d
    Secure Proxy ë‹¤ì´ì–´ê·¸ë¨      :crit, a2, after a1, 1d
    FastAPI ëª…ì„¸ì„œ ì‘ì„±          :crit, a3, after a1, 2d

    section High
    HTJ2K êµ¬í˜„ í™•ì¸             :high, b1, 2026-01-06, 3d
    FHIR êµ¬í˜„ ê²€ì¦              :high, b2, 2026-01-06, 3d
    Outbox ì„±ëŠ¥ ì¸¡ì •            :high, b3, 2026-01-09, 2d

    section Medium
    Circuit Breaker ë„ì…        :med, c1, 2026-01-13, 5d
    API Gateway ê²€í†             :med, c2, 2026-01-13, 5d
    SLA ë¬¸ì„œ ì‘ì„±               :med, c3, 2026-01-20, 3d
```

### ì˜ˆìƒ íš¨ê³¼

**ì¦‰ì‹œ ì¡°ì¹˜ ì™„ë£Œ ì‹œ**:
- âœ… ë°°í¬ ì‹¤íŒ¨ ìœ„í—˜ ì œê±°
- âœ… ë³´ì•ˆ êµ¬ë© ì°¨ë‹¨
- âœ… FastAPI êµ¬í˜„ ê°€ëŠ¥

**ë‹¨ê¸° ì¡°ì¹˜ ì™„ë£Œ ì‹œ**:
- âœ… HTJ2K ë³€í™˜ ì„±ëŠ¥ ìµœì í™”
- âœ… FHIR ë™ê¸°í™” ì•ˆì •í™”
- âœ… ë°ì´í„° ì¼ê´€ì„± í–¥ìƒ

**ì¤‘ê¸° ì¡°ì¹˜ ì™„ë£Œ ì‹œ**:
- âœ… ì„œë¹„ìŠ¤ ì¥ì•  ê²©ë¦¬ (Circuit Breaker)
- âœ… ìš´ì˜ ì•ˆì •ì„± í–¥ìƒ
- âœ… SLA ë‹¬ì„± ê°€ëŠ¥

---

## ğŸ“ ë¶€ë¡

### A. ë¬¸ì„œ ë²„ì „ ê´€ë¦¬ ê¶Œì¥ì‚¬í•­

```markdown
# ê° ë¬¸ì„œ í—¤ë”ì— ì¶”ê°€
---
title: ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜
version: v3.0
last_updated: 2026-01-03
status: âœ… êµ¬í˜„ ì™„ë£Œ / â³ êµ¬í˜„ ì¤‘ / ğŸ“‹ ê³„íš
author: NeuroNova Team
---

## Changelog

### v3.0 (2026-01-03)
- OHIF Unified React í†µí•© ì™„ë£Œ
- Nginx ë¼ìš°íŒ… ë‹¨ìˆœí™”
- Multi-SPA íê¸°

### v2.1 (2025-12-30)
- Secure Proxy íŒ¨í„´ ë„ì…
- X-Accel-Redirect ì ìš©
```

### B. ì‹œí€€ìŠ¤ ë‹¤ì´ì–´ê·¸ë¨ í…œí”Œë¦¿

```mermaid
sequenceDiagram
    participant A as Actor A
    participant B as System B
    participant C as System C

    A->>B: 1. Request
    Note over A,B: ì„¤ëª…
    B->>B: 2. Internal Processing
    B->>C: 3. External Call
    C-->>B: 4. Response
    B-->>A: 5. Final Response

    rect rgb(255, 235, 59)
        Note over A,C: âš ï¸ ì£¼ì˜ì‚¬í•­
    end
```

---

**ì‘ì„±**: Claude AI (Architecture Review)
**ì‘ì„±ì¼**: 2026-01-02
**ê²€í†  ëŒ€ìƒ**: 01_doc ì „ì²´ ë¬¸ì„œ (44ê°œ)
**ë‹¤ìŒ ë¦¬ë·° ê¶Œì¥**: 2ì£¼ í›„ (2026-01-16)
