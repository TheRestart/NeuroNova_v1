# ~~14. 데이터 시딩 가이드~~ [DEPRECATED]

**⚠️ 본 문서는 폐기되었습니다.**

**폐기일**: 2026-01-01
**대체 문서**: [초기_데이터_시딩_가이드.md](초기_데이터_시딩_가이드.md)

**폐기 사유**:
- 레거시 환경 (로컬 Django + 개별 Docker)용 가이드
- 최신 데이터 아키텍처 (43, 44번 문서)를 준수하지 않음
- Outbox 패턴 미반영
- 환자 ID 형식 불일치 (`P-2025-001` vs `P20250001`)

**신규 가이드 참조**: [초기_데이터_시딩_가이드.md](초기_데이터_시딩_가이드.md)

---

**원본 문서 (참고용)**

---

**문서 작성일**: 2025-12-23
**작성자**: Antigravity AI
**버전**: 1.0 (Deprecated)

---

## 📋 개요

본 문서는 개발 및 테스트 환경 구축을 위해 CDSS(Django) 및 OpenEMR(MySQL) 데이터베이스에 초기 데이터를 자동으로 생성(Seeding)하는 방법을 설명합니다. 두 시스템 간의 데이터 정합성(특히 환자 ID 매핑)을 유지하며 대량의 테스트 데이터를 생성할 수 있습니다.

## 🛠️ 시딩 스크립트 목록

| 스크립트명 | 대상 DB | 설명 |
|---|---|---|
| `populate_cdss_db.py` | **cdss_db** (Django) | 7개 역할별 사용자, 환자(Cache), 진료기록, 처방 생성 |
| `populate_openemr_db.py` | **openemr** (Legacy) | Raw SQL을 사용하여 OpenEMR 테이블에 직접 데이터 주입 |

**위치**: `NeuroNova_02_back_end/01_django_server/scripts/`

---

## 🚀 실행 방법

두 스크립트는 독립적으로 실행 가능하도록 Django 환경 설정이 포함되어 있습니다.

### 1. 전제 조건
*   Docker 서비스(OpenEMR, DB 등)가 실행 중이어야 합니다.
*   가상환경(venv)이 활성화되어 있어야 합니다.

### 2. CDSS DB 시딩 (사용자 & 임상 데이터)

```bash
cd NeuroNova_02_back_end/01_django_server
python scripts/populate_cdss_db.py
```

**생성되는 데이터:**
*   **사용자 (Users)**: 7개 역할별 3명씩 **총 21명**
    *   `admin1~3`, `doctor1~3`, `nurse1~3`, `patient1~3` 등
    *   비밀번호: `{role}123!` (예: `doctor123!`)
*   **환자 (Patients)**: 30명
    *   ID: `P-2025-001` ~ `P-2025-030`
    *   OpenEMR 매핑 ID: `PID_1` ~ `PID_30`
*   **임상 데이터**: 환자당 1~3건의 진료기록(Encounter) 및 처방(Order)

### 3. OpenEMR DB 시딩 (Raw Data)

```bash
python scripts/populate_openemr_db.py
```

**생성되는 데이터:**
*   **환자 (patient_data)**: CDSS와 동일한 `PID_X`(`pubpid`)를 가진 환자 30+명
*   **진료기록 (form_encounter)**: CDSS와 매핑 가능한 진료 내역
*   **처방 (prescriptions)**: 필수 필드(`date`, `drug` 등)가 포함된 처방 내역
*   **주의**: `pid` 0번 중복 오류 방지를 위해 수동 증가 로직이 적용되어 있습니다.

---

## 📊 데이터 정합성 규칙

두 시스템은 다음과 같은 규칙으로 연결됩니다:

1.  **환자 ID 매핑**
    *   **CDSS**: `PatientCache.openemr_patient_id = "PID_10"`
    *   **OpenEMR**: `patient_data.pubpid = "PID_10"`
    *   이 매핑을 통해 FHIR 또는 프록시 조회 시 동일 인물로 식별합니다.

2.  **데이터 무결성**
    *   스크립트는 중복 실행 시 기존 데이터(Username 또는 PubPID 기준)가 있으면 건너뜁니다(Skip).
    *   OpenEMR의 경우 `pid` Auto Increment 문제로 인해 스크립트가 현재 Max PID를 조회하여 +1씩 수동 할당합니다.

## ✅ 문제 해결 (Troubleshooting)

**Q: OpenEMR 시딩 중 "Duplicate entry '0' for key 'primary'" 오류 발생**
A: OpenEMR 레거시 DB의 `id` 또는 `pid` 컬럼에 Auto Increment 속성이 누락된 경우 발생합니다. 최신 스크립트(v4)는 이를 해결하기 위해 `pid`를 수동으로 계산하여 주입하므로 스크립트를 최신 상태로 유지하세요.

**Q: 처방(Order) 데이터가 생성되지 않음**
A: `prescriptions` 테이블에 필수 필드(`usage_category_title` 등)가 누락되면 Insert가 실패합니다. 최신 스크립트는 이를 반영하여 더미 값을 채워 넣습니다.
