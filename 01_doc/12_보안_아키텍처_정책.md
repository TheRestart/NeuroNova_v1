# CDSS ë³´ì•ˆ ì•„í‚¤í…ì²˜ ì •ì±…

**í”„ë¡œì íŠ¸**: Clinical Decision Support System (CDSS)
**ì •ì±… ìˆ˜ë¦½ì¼**: 2025-12-22
**ì •ì±… ë²„ì „**: 1.0

---

## ğŸ”’ í•µì‹¬ ë³´ì•ˆ ì›ì¹™

### âš ï¸ í•„ìˆ˜ ì¤€ìˆ˜ ì‚¬í•­

**ëª¨ë“  ì™¸ë¶€ ì‹œìŠ¤í…œ(OpenEMR, Orthanc, HAPI FHIR) ì ‘ê·¼ì€ ë°˜ë“œì‹œ Djangoë¥¼ ê²½ìœ í•´ì•¼ í•©ë‹ˆë‹¤.**

---

## 1. Django ì¤‘ì•™ ì¸ì¦ ì •ì±…

### 1.1 ì˜ëª»ëœ ì•„í‚¤í…ì²˜ (ê¸ˆì§€) âŒ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ HTTP Request
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Nginx     â”‚
â””â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”˜
   â”‚      â”‚
   â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚                        â”‚
â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Django     â”‚    â”‚  HAPI FHIR       â”‚
â”‚  API        â”‚    â”‚  (ì§ì ‘ ë…¸ì¶œ)      â”‚  â† âŒ ê¸ˆì§€!
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ë¬¸ì œì :**
- ì¸ì¦/ê¶Œí•œ ê²€ì¦ ìš°íšŒ ê°€ëŠ¥
- ê°ì‚¬ ë¡œê·¸ ëˆ„ë½
- ë³´ì•ˆ ì •ì±… ì¼ê´€ì„± ê²°ì—¬

---

### 1.2 ì˜¬ë°”ë¥¸ ì•„í‚¤í…ì²˜ (í•„ìˆ˜) âœ…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ Authorization: Token <token>
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Nginx     â”‚ â† Django APIë§Œ ë…¸ì¶œ
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ /api/*
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Django REST API                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ 1. Token ì¸ì¦ í™•ì¸           â”‚ â”‚
â”‚  â”‚ 2. ì—­í•  ê¶Œí•œ ê²€ì¦ (RBAC)     â”‚ â”‚
â”‚  â”‚ 3. ê°ì‚¬ ë¡œê·¸ ê¸°ë¡            â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚           â”‚          â”‚
     â”‚ Internal  â”‚ Internal â”‚ Internal
     â”‚ Network   â”‚ Network  â”‚ Network
â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â” â”Œâ”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ OpenEMR  â”‚ â”‚Orthancâ”‚ â”‚ HAPI FHIR   â”‚
â”‚ (EMR)    â”‚ â”‚(PACS) â”‚ â”‚ (HL7)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
  â†‘               â†‘           â†‘
  ì™¸ë¶€ ë…¸ì¶œ ê¸ˆì§€   ì™¸ë¶€ ë…¸ì¶œ ê¸ˆì§€  ì™¸ë¶€ ë…¸ì¶œ ê¸ˆì§€
```

---

## 2. êµ¬í˜„ ìš”êµ¬ì‚¬í•­

### 2.1 Nginx ì„¤ì •

**í—ˆìš©:**
```nginx
# âœ… Django APIë§Œ ë…¸ì¶œ
location /api/ {
    proxy_pass http://django-api:8000;
    # ì¸ì¦/ê¶Œí•œ ê²€ì¦ì€ Djangoì—ì„œ ìˆ˜í–‰
}

location /ws/ {
    proxy_pass http://django-channels:8001;
}
```

**ê¸ˆì§€:**
```nginx
# âŒ ì™¸ë¶€ ì‹œìŠ¤í…œ ì§ì ‘ ë…¸ì¶œ ê¸ˆì§€
# location /fhir/ {
#     proxy_pass http://hapi-fhir:8080/fhir/;  # ì ˆëŒ€ ê¸ˆì§€!
# }

# âŒ OpenEMR ì§ì ‘ ë…¸ì¶œ ê¸ˆì§€
# location /emr/ {
#     proxy_pass http://openemr:8080/;  # ì ˆëŒ€ ê¸ˆì§€!
# }

# âŒ Orthanc ì§ì ‘ ë…¸ì¶œ ê¸ˆì§€
# location /orthanc/ {
#     proxy_pass http://orthanc:8042/;  # ì ˆëŒ€ ê¸ˆì§€!
# }
```

---

### 2.2 Django API êµ¬í˜„ íŒ¨í„´

**ëª¨ë“  ì™¸ë¶€ ì‹œìŠ¤í…œ ì ‘ê·¼ì€ ë‹¤ìŒ íŒ¨í„´ì„ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤:**

```python
from rest_framework.decorators import api_view, permission_classes
from acct.permissions import IsDoctorOrRIB, IsStaffRole
from audit.client import AuditClient
from .clients.external_client import ExternalSystemClient

@api_view(['GET', 'POST'])
@permission_classes([IsDoctorOrRIB])  # â† 1. ê¶Œí•œ ê²€ì¦ í•„ìˆ˜
def external_api_endpoint(request):
    """
    ì™¸ë¶€ ì‹œìŠ¤í…œ ì ‘ê·¼ API
    ëª¨ë“  ìš”ì²­ì€ Djangoë¥¼ í†µí•´ ì¸ì¦/ê¶Œí•œ ê²€ì¦
    """
    # 2. ê°ì‚¬ ë¡œê·¸ ê¸°ë¡ í•„ìˆ˜
    AuditClient.log_event(
        user=request.user,
        action='READ',  # or CREATE, UPDATE, DELETE
        resource_type='ExternalResource',
        resource_id=request.GET.get('id'),
        request=request
    )

    # 3. Client í´ë˜ìŠ¤ë¥¼ í†µí•´ ì™¸ë¶€ ì‹œìŠ¤í…œ í˜¸ì¶œ
    client = ExternalSystemClient()
    result = client.call_external_api(...)

    return Response(result)
```

---

### 2.3 Client í´ë˜ìŠ¤ êµ¬í˜„

**ê° ì™¸ë¶€ ì‹œìŠ¤í…œë§ˆë‹¤ ì „ìš© Client í´ë˜ìŠ¤ í•„ìˆ˜:**

```python
# emr/clients/openemr_client.py
import requests
from django.conf import settings

class OpenEMRClient:
    """OpenEMR API í´ë¼ì´ì–¸íŠ¸ (Django ë‚´ë¶€ì—ì„œë§Œ ì‚¬ìš©)"""

    def __init__(self):
        # ë‚´ë¶€ Docker ë„¤íŠ¸ì›Œí¬ URL ì‚¬ìš©
        self.base_url = settings.OPENEMR_BASE_URL  # http://openemr:8080
        self.token = settings.OPENEMR_API_TOKEN

    def get_patient(self, patient_id):
        """í™˜ì ì •ë³´ ì¡°íšŒ"""
        response = requests.get(
            f'{self.base_url}/api/patient/{patient_id}',
            headers={'Authorization': f'Bearer {self.token}'}
        )
        return response.json()
```

**Client í´ë˜ìŠ¤ ìœ„ì¹˜:**
- `emr/clients/openemr_client.py` - OpenEMR ì „ìš©
- `radiology/clients/orthanc_client.py` - Orthanc ì „ìš©
- `fhir/clients/hapi_client.py` - HAPI FHIR ì „ìš©

---

### 2.4 Docker Network ê²©ë¦¬

```yaml
# docker-compose.yml

services:
  django-api:
    networks:
      - cdss-network  # â† Djangoë§Œ ì™¸ë¶€ ì‹œìŠ¤í…œ ì ‘ê·¼ ê°€ëŠ¥
    ports:
      - "8000:8000"  # âœ… ì™¸ë¶€ ë…¸ì¶œ OK

  hapi-fhir:
    networks:
      - cdss-network  # â† ë‚´ë¶€ ë„¤íŠ¸ì›Œí¬ë§Œ
    # ports:  # â† âŒ ì™¸ë¶€ í¬íŠ¸ ë…¸ì¶œ ê¸ˆì§€!
    #   - "8080:8080"  # ì ˆëŒ€ ê¸ˆì§€!

  orthanc:
    networks:
      - cdss-network
    # ports:  # â† âŒ ì™¸ë¶€ í¬íŠ¸ ë…¸ì¶œ ê¸ˆì§€!
    #   - "8042:8042"  # ì ˆëŒ€ ê¸ˆì§€!

  openemr:
    networks:
      - cdss-network
    # ports:  # â† âŒ ì™¸ë¶€ í¬íŠ¸ ë…¸ì¶œ ê¸ˆì§€!
    #   - "8080:8080"  # ì ˆëŒ€ ê¸ˆì§€!

networks:
  cdss-network:
    driver: bridge
    internal: false  # Djangoê°€ ì™¸ë¶€ì™€ í†µì‹  ê°€ëŠ¥
```

---

## 3. ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸

### 3.1 ê°œë°œì ì²´í¬ë¦¬ìŠ¤íŠ¸

ìƒˆë¡œìš´ ì™¸ë¶€ ì‹œìŠ¤í…œ ì—°ë™ ì‹œ ë°˜ë“œì‹œ í™•ì¸:

- [ ] **Nginxì—ì„œ ì§ì ‘ ë…¸ì¶œí•˜ì§€ ì•Šì•˜ëŠ”ê°€?**
  - `location /external-system/` ë¸”ë¡ì´ ì—†ì–´ì•¼ í•¨

- [ ] **Django API ì—”ë“œí¬ì¸íŠ¸ë¥¼ ë§Œë“¤ì—ˆëŠ”ê°€?**
  - `/api/<uc>/` í˜•ì‹ì˜ ì—”ë“œí¬ì¸íŠ¸ í•„ìˆ˜

- [ ] **ê¶Œí•œ ê²€ì¦ì„ ì¶”ê°€í–ˆëŠ”ê°€?**
  - `@permission_classes([...])`ë¡œ ì—­í•  ê¸°ë°˜ ê¶Œí•œ ì„¤ì •

- [ ] **ê°ì‚¬ ë¡œê·¸ë¥¼ ê¸°ë¡í•˜ëŠ”ê°€?**
  - `AuditClient.log_event()` í˜¸ì¶œ í•„ìˆ˜

- [ ] **Client í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì—ˆëŠ”ê°€?**
  - `<app>/clients/<system>_client.py` êµ¬ì¡°

- [ ] **Docker í¬íŠ¸ë¥¼ ì™¸ë¶€ì— ë…¸ì¶œí•˜ì§€ ì•Šì•˜ëŠ”ê°€?**
  - `docker-compose.yml`ì—ì„œ `ports` ì„¹ì…˜ ì œê±°

---

### 3.2 ì½”ë“œ ë¦¬ë·° ì²´í¬ë¦¬ìŠ¤íŠ¸

Pull Request ë¦¬ë·° ì‹œ ë°˜ë“œì‹œ í™•ì¸:

```markdown
## ë³´ì•ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸

- [ ] Nginx ì„¤ì •ì—ì„œ ì™¸ë¶€ ì‹œìŠ¤í…œ ì§ì ‘ ë…¸ì¶œ ì—†ìŒ
- [ ] Django APIì—ì„œ `@permission_classes` ì ìš©
- [ ] `AuditClient.log_event()` í˜¸ì¶œ í™•ì¸
- [ ] Client í´ë˜ìŠ¤ë¥¼ í†µí•œ ì™¸ë¶€ í˜¸ì¶œ í™•ì¸
- [ ] Docker í¬íŠ¸ ì™¸ë¶€ ë…¸ì¶œ ì—†ìŒ
- [ ] í…ŒìŠ¤íŠ¸ ì½”ë“œì—ì„œ ê¶Œí•œ ê²€ì¦ í™•ì¸
```

---

## 4. ë³´ì•ˆ ìœ„ë°˜ ì‚¬ë¡€

### 4.1 ì˜ëª»ëœ ì˜ˆì‹œ âŒ

**ì¼€ì´ìŠ¤ 1: Nginxì—ì„œ FHIR ì§ì ‘ ë…¸ì¶œ**
```nginx
# nginx.conf (ì˜ëª»ëœ ì˜ˆì‹œ)
location /fhir/ {
    proxy_pass http://hapi-fhir:8080/fhir/;  # âŒ ê¸ˆì§€!
}
```

**ë¬¸ì œ:**
- Django ì¸ì¦ ìš°íšŒ ê°€ëŠ¥
- ê°ì‚¬ ë¡œê·¸ ëˆ„ë½
- ì—­í•  ê¸°ë°˜ ê¶Œí•œ ì ìš© ë¶ˆê°€

---

**ì¼€ì´ìŠ¤ 2: Viewì—ì„œ ê¶Œí•œ ê²€ì¦ ëˆ„ë½**
```python
# views.py (ì˜ëª»ëœ ì˜ˆì‹œ)
@api_view(['GET'])
# @permission_classes([...])  # âŒ ê¶Œí•œ ê²€ì¦ ëˆ„ë½!
def get_patient(request, patient_id):
    client = OpenEMRClient()
    return Response(client.get_patient(patient_id))
```

**ë¬¸ì œ:**
- ëª¨ë“  ì¸ì¦ëœ ì‚¬ìš©ìê°€ ì ‘ê·¼ ê°€ëŠ¥
- Patientê°€ íƒ€ì¸ ì •ë³´ ì¡°íšŒ ê°€ëŠ¥

---

**ì¼€ì´ìŠ¤ 3: ê°ì‚¬ ë¡œê·¸ ëˆ„ë½**
```python
# views.py (ì˜ëª»ëœ ì˜ˆì‹œ)
@api_view(['GET'])
@permission_classes([IsDoctor])
def get_patient(request, patient_id):
    client = OpenEMRClient()
    # AuditClient.log_event(...)  # âŒ ê°ì‚¬ ë¡œê·¸ ëˆ„ë½!
    return Response(client.get_patient(patient_id))
```

**ë¬¸ì œ:**
- ëˆ„ê°€, ì–¸ì œ, ì–´ë–¤ ë°ì´í„°ì— ì ‘ê·¼í–ˆëŠ”ì§€ ì¶”ì  ë¶ˆê°€
- ë³´ì•ˆ ê°ì‚¬ ì‹¤íŒ¨

---

### 4.2 ì˜¬ë°”ë¥¸ ì˜ˆì‹œ âœ…

```python
# emr/views.py (ì˜¬ë°”ë¥¸ ì˜ˆì‹œ)
from rest_framework.decorators import api_view, permission_classes
from acct.permissions import IsDoctorOrNurse
from audit.client import AuditClient
from .clients.openemr_client import OpenEMRClient

@api_view(['GET'])
@permission_classes([IsDoctorOrNurse])  # âœ… ê¶Œí•œ ê²€ì¦
def get_patient(request, patient_id):
    """í™˜ì ì •ë³´ ì¡°íšŒ (OpenEMR í”„ë¡ì‹œ)"""

    # âœ… ê°ì‚¬ ë¡œê·¸
    AuditClient.log_event(
        user=request.user,
        action='READ',
        resource_type='Patient',
        resource_id=patient_id,
        request=request
    )

    # âœ… Client í´ë˜ìŠ¤ ì‚¬ìš©
    client = OpenEMRClient()
    data = client.get_patient(patient_id)

    return Response(data)
```

---

## 5. ì˜ˆì™¸ ìƒí™©

### 5.1 ê°œë°œ/í…ŒìŠ¤íŠ¸ í™˜ê²½

ê°œë°œ í™˜ê²½ì—ì„œëŠ” **ì„ì‹œë¡œ** ì™¸ë¶€ ì‹œìŠ¤í…œ í¬íŠ¸ë¥¼ ë…¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```yaml
# docker-compose.dev.yml (ê°œë°œ ì „ìš©)
services:
  hapi-fhir:
    ports:
      - "8080:8080"  # âš ï¸ ê°œë°œ í™˜ê²½ì—ì„œë§Œ í—ˆìš©
```

**ì£¼ì˜:**
- í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” ì ˆëŒ€ ê¸ˆì§€
- `.env` íŒŒì¼ë¡œ í™˜ê²½ ë¶„ë¦¬ í•„ìˆ˜
- Gitì— ê°œë°œ ì„¤ì • ì»¤ë°‹ ê¸ˆì§€

---

### 5.2 ê´€ë¦¬ì ì ‘ê·¼

ì‹œìŠ¤í…œ ê´€ë¦¬ìê°€ ë””ë²„ê¹… ëª©ì ìœ¼ë¡œ ì§ì ‘ ì ‘ê·¼ì´ í•„ìš”í•œ ê²½ìš°:

**í—ˆìš© ë°©ë²•:**
1. VPN ì—°ê²° í•„ìˆ˜
2. IP í™”ì´íŠ¸ë¦¬ìŠ¤íŠ¸ ì„¤ì •
3. ì„ì‹œ SSH í„°ë„ ì‚¬ìš©

```bash
# SSH í„°ë„ ì˜ˆì‹œ (ë¡œì»¬ì—ì„œë§Œ ì ‘ê·¼)
ssh -L 8080:localhost:8080 admin@server
```

---

## 6. ëª¨ë‹ˆí„°ë§ ë° ê°ì‚¬

### 6.1 ê°ì‚¬ ë¡œê·¸ í•„ìˆ˜ í•­ëª©

ëª¨ë“  ì™¸ë¶€ ì‹œìŠ¤í…œ ì ‘ê·¼ ì‹œ ê¸°ë¡:

```python
AuditClient.log_event(
    user=request.user,           # ëˆ„ê°€
    action='READ',                # ë¬´ì—‡ì„ (CREATE, READ, UPDATE, DELETE)
    resource_type='Patient',      # ì–´ë–¤ ë¦¬ì†ŒìŠ¤ë¥¼
    resource_id=patient_id,       # ì–´ë–¤ IDë¡œ
    request=request,              # ì–´ë””ì„œ (IP, User-Agent)
    details={'source': 'OpenEMR'} # ì¶”ê°€ ì •ë³´
)
```

---

### 6.2 ë³´ì•ˆ ëª¨ë‹ˆí„°ë§

**Prometheus ë©”íŠ¸ë¦­:**
- ì™¸ë¶€ ì‹œìŠ¤í…œ í˜¸ì¶œ íšŸìˆ˜
- ì¸ì¦ ì‹¤íŒ¨ íšŸìˆ˜
- ê¶Œí•œ ê±°ë¶€ íšŸìˆ˜

**Grafana ì•Œë¦¼:**
- ì§§ì€ ì‹œê°„ ë‚´ ëŒ€ëŸ‰ API í˜¸ì¶œ ê°ì§€
- ê¶Œí•œ ê±°ë¶€ ì´ë²¤íŠ¸ ê¸‰ì¦ ê°ì§€

---

## 7. ê´€ë ¨ ë¬¸ì„œ

- [02_ì„¸ë¶€ ê³„íšì„œ.md](02_ì„¸ë¶€ ê³„íšì„œ.md) - ì¸í”„ë¼ ì•„í‚¤í…ì²˜ ìƒì„¸
- [cdss-backend/README.md](cdss-backend/README.md) - Django ë°±ì—”ë“œ ê°€ì´ë“œ
- [WEEK1_ì‘ì—…ì™„ë£Œ.md](WEEK1_ì‘ì—…ì™„ë£Œ.md) - Week 1 êµ¬í˜„ ìƒì„¸

---

## ë³€ê²½ ì´ë ¥

| ë‚ ì§œ | ë²„ì „ | ë³€ê²½ ë‚´ìš© |
|------|------|-----------|
| 2025-12-22 | 1.0 | ì´ˆê¸° ì •ì±… ìˆ˜ë¦½ |

---

**ì´ ì •ì±…ì€ ëª¨ë“  ê°œë°œìê°€ ë°˜ë“œì‹œ ì¤€ìˆ˜í•´ì•¼ í•©ë‹ˆë‹¤.**
**ë³´ì•ˆ ì •ì±… ìœ„ë°˜ ì‹œ ì½”ë“œ ë¦¬ë·°ì—ì„œ ë°˜ë ¤ë©ë‹ˆë‹¤.**
