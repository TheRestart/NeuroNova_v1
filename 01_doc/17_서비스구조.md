CDSS (Clinical Decision Support System) System Architecture

## 1. 개요 (Overview)
본 문서는 뇌종양 분석 및 임상 의사결정 지원 시스템(CDSS)의 전체 아키텍처를 정의한다. 
시스템은 **OpenEMR을 마스터 데이터(Source of Truth)**로 사용하며, Django CDSS 서버가 이를 캐싱 및 오케스트레이션하는 구조이다. HAPI FHIR 서버는 의료 데이터 교환을 위한 허브 역할을 수행한다.

* **범례 (Legend)**
    * **실선 (Solid Line):** 동기 통신 (Synchronous)
    * **점선 (Dashed Line):** 비동기 통신 (Asynchronous) 또는 메트릭 수집

---

## 2. 계층별 구성 요소 (Components by Layer)

### A. User Interface Layer (사용자 인터페이스)
사용자가 시스템에 접근하는 접점.
* **Flutter Mobile App:** 의료진용 모바일 클라이언트.
* **React Web Dashboard:** 웹 기반 관리 및 조회 대시보드 (역할별 접근 제어).

### B. Security & Gateway (보안 및 게이트웨이)
외부 트래픽 처리 및 보안 담당.
* **Cloudflare CDN/WAF:** 콘텐츠 전송 네트워크 및 웹 방화벽.
* **Nginx Reverse Proxy:** 리버스 프록시 및 SSL 종료.

### C. Core Business Logic (핵심 비즈니스 로직)
시스템의 중심 컨트롤러 및 중계자.
* **Django CDSS Main Server:**
    * **API Gateway & Business Logic:** REST API 제공.
    * **Write-Behind Cache Manager:** OpenEMR 데이터를 캐싱.
    * **FHIR Adapter:** HAPI FHIR 서버와의 통신 어댑터.

### D. AI & Analytics Engine (AI 및 분석 엔진)
의료 데이터 분석 및 추론 수행.
* **Flask AI Server:** AI 모델 서빙 및 추론 API (Django와 REST 통신).
* **RabbitMQ:** 비동기 작업 큐 (AI Job 관리).
* **MONAI framework:** 의료 AI 분석 프레임워크.

### E. Data Persistence (데이터 영속성)
메인 데이터 저장소.
* **MySQL (CDSS Primary DB):** Django용 캐시 및 어플리케이션 DB (Read Cache).

### F. Medical Infrastructure (의료 인프라 - Source of Truth)
병원 시스템 및 의료 데이터 표준 연동.
* **OpenEMR (Master DB):** 환자, 진료, 처방 데이터의 원본(Source of Truth).
* **HAPI FHIR Server (JPA):** 표준 FHIR R4 데이터 교환 서버 (Port 8080).
* **Orthanc Server:** DICOM PACS 서버 (의료 영상).

### G. DevOps & Monitoring (데브옵스 및 모니터링)
시스템 상태 감시 및 운영.
* **Prometheus:** 메트릭 수집.
* **Grafana:** 모니터링 시각화.
* **Alertmanager:** 알림 관리.
* **Docker Engine:** 컨테이너 런타임 환경.

---

## 3. 데이터 흐름 및 상호작용 (Data Flow & Interactions)

### 3.1 사용자 요청 흐름 (User Request Flow) [Sync]
1.  **UI Layer (Flutter/React)** $\rightarrow$ **Cloudflare**
2.  **Cloudflare** $\rightarrow$ **Nginx Reverse Proxy**
3.  **Nginx** $\rightarrow$ **Django CDSS Main Server** (HTTP/REST)
4.  **UI Layer** $\leftrightarrow$ **Django Channels (Daphne):** WebSocket Connection (Real-time Notifications).

### 3.2 핵심 데이터 흐름: OpenEMR First (Data Consistency) [Sync]
**"OpenEMR이 Master, Django는 Cache"**
1.  **쓰기(Write):** Django $\rightarrow$ **OpenEMR DB (Insert)** (선행) $\rightarrow$ 성공 시 **Django MySQL (Cache)** (후행).
2.  **읽기(Read):** Django MySQL(Cache) 우선 조회 $\rightarrow$ Miss 시 OpenEMR 조회 및 캐싱 (Read-Through/Cache-Aside).

### 3.3 AI 분석 파이프라인 (AI Inference Pipeline) [Async]
1.  **Django** $\rightarrow$ **RabbitMQ / AI Server:** 분석 요청.
2.  **AI Server** $\rightarrow$ **MONAI:** 추론 실행.
3.  **AI Server** $\rightarrow$ **Django:** 결과 반환 (Webhook 또는 Polling).
4.  **Django** $\rightarrow$ **HAPI FHIR:** 진단 결과(DiagnosticReport) 동기화.

### 3.4 의료 데이터 연동 (Medical Connectivity)
*   **Django** $\leftrightarrow$ **HAPI FHIR:** 환자 동기화 (Patient Sync), AI 결과 표준화 저장.
*   **Django** $\leftrightarrow$ **Orthanc Server:** DICOM 메타데이터 조회 및 뷰어 연동.
*   **OpenEMR** $\leftrightarrow$ **Orthanc Server:** (선택적) 직접 연동.

### 3.5 모니터링 파이프라인 (Monitoring Pipeline) [Async]
*   **Prometheus** $\dashrightarrow$ **All Layers:** Metrics Collection.
*   **Grafana:** 데이터 시각화 대시보드.
