# 개발 모드 설정 완료 ✅

**날짜**: 2025-12-22
**작업**: 보안/권한 토글 기능 추가

---

## 📋 작업 요약

개발 편의성을 위해 **보안/권한 기능을 선택적으로 활성화/비활성화**할 수 있도록 설정했습니다.

---

## 🔓 개발 모드 (기본값)

### 현재 설정 상태

```env
# .env 파일
ENABLE_SECURITY=False  ← 기본값 (개발 모드)
```

### 효과

```
✅ 인증 없이 모든 API 접근 가능
✅ 권한 검증 우회 (IsAdmin, IsDoctor 등 무시)
✅ 빠른 테스트 및 디버깅
⚠️  감사 로그는 LOGIN/LOGOUT만 기록
```

### 사용 예시

**토큰 없이 API 호출:**
```bash
# 인증 없이 바로 접근!
curl http://localhost:8000/api/acct/me/
curl http://localhost:8000/api/acct/users/
curl http://localhost:8000/api/emr/patients/
```

---

## 🔒 프로덕션 모드

### 설정 방법

```bash
# .env 파일 수정
ENABLE_SECURITY=True
```

### 효과

```
🔒 Token 인증 필수
🔒 역할 기반 권한 검증 (RBAC)
🔒 전체 감사 로그 기록
⚠️  프로덕션 배포 시 반드시 활성화!
```

---

## 📁 생성/수정된 파일

### 1. 핵심 파일

| 파일 | 설명 | 상태 |
|------|------|------|
| `cdss_backend/settings.py` | 보안 토글 로직 추가 | ✅ 수정 |
| `cdss_backend/settings_security.py` | 보안 헬퍼 함수 | ⭐ 신규 |
| `.env.example` | `ENABLE_SECURITY` 추가 | ✅ 수정 |
| `.env` | `ENABLE_SECURITY=False` 설정 | ✅ 수정 |

### 2. 문서

| 파일 | 설명 | 상태 |
|------|------|------|
| `개발모드_가이드.md` | 상세 사용 가이드 | ⭐ 신규 |
| `README.md` | 보안 모드 섹션 추가 | ✅ 수정 |
| `개발모드_설정완료.md` | 이 문서 | ⭐ 신규 |

---

## 🔄 모드 전환 방법

### 개발 모드 → 프로덕션 모드

```bash
# 1. .env 파일 수정
# ENABLE_SECURITY=False → True

# 2. Django 재시작
python manage.py runserver

# 3. 로그 확인
# 🔒 SECURITY MODE: ENABLED
```

### 프로덕션 모드 → 개발 모드

```bash
# 1. .env 파일 수정
# ENABLE_SECURITY=True → False

# 2. Django 재시작
python manage.py runserver

# 3. 로그 확인
# ⚠️  SECURITY MODE: DISABLED (DEVELOPMENT)
```

---

## 🚀 실전 사용 시나리오

### 시나리오 1: API 개발 시작

```bash
# .env 확인
cat .env | grep ENABLE_SECURITY
# ENABLE_SECURITY=False  ← 개발 모드

# Django 실행
cd cdss-backend
python manage.py runserver

# 브라우저/Postman에서 바로 테스트
# http://localhost:8000/api/acct/me/  ✅ 토큰 없이 접근!
```

### 시나리오 2: React 프론트엔드 연동

**개발 모드 (간편):**
```javascript
// 토큰 없이 바로 API 호출
axios.get('http://localhost:8000/api/acct/me/')
  .then(res => console.log(res.data));
```

**프로덕션 모드 (실전):**
```javascript
// 토큰 필수
const token = localStorage.getItem('token');
axios.get('http://localhost:8000/api/acct/me/', {
  headers: { 'Authorization': `Token ${token}` }
}).then(res => console.log(res.data));
```

### 시나리오 3: 권한 로직 테스트

```python
# views.py
@api_view(['GET'])
@permission_classes([IsAdmin])  # Admin만 접근
def admin_view(request):
    return Response({"message": "Admin only"})

# 개발 모드 (ENABLE_SECURITY=False)
# → 모든 사용자 접근 가능 (테스트 용이)

# 프로덕션 모드 (ENABLE_SECURITY=True)
# → Admin이 아니면 403 Forbidden
```

---

## 📊 모드별 비교표

| 항목 | 개발 모드 | 프로덕션 모드 |
|------|----------|---------------|
| **인증** | 불필요 ✅ | 필수 🔒 |
| **권한** | 우회 ✅ | 검증 🔒 |
| **감사 로그** | 부분 (LOGIN/LOGOUT) | 전체 🔒 |
| **API 접근** | 자유 ✅ | 제한 🔒 |
| **토큰 만료** | 24시간 | 1시간 |
| **용도** | 개발/테스트 | 프로덕션 |

---

## ⚠️ 주의사항

### 1. 프로덕션 배포 체크리스트

```bash
# ❌ 절대 금지!
# 프로덕션에서 ENABLE_SECURITY=False는 심각한 보안 위험!

# ✅ 프로덕션 .env 설정 필수
ENABLE_SECURITY=True
DEBUG=False
SECRET_KEY=<강력한_시크릿_키>
```

### 2. Git 관리

```bash
# .env는 절대 커밋 금지!
echo ".env" >> .gitignore

# .env.example은 템플릿으로 커밋
git add .env.example
git commit -m "docs: add ENABLE_SECURITY toggle"
```

### 3. 팀원 공유

```bash
# 각 팀원은 .env.example 복사
cp .env.example .env

# 로컬 환경에 맞게 수정
vi .env
```

---

## 🧪 테스트 가이드

### 1. 개발 모드 테스트

```bash
# .env: ENABLE_SECURITY=False

# 서버 시작
python manage.py runserver

# 토큰 없이 API 테스트
curl http://localhost:8000/api/acct/me/
# ✅ 정상 응답 (인증 우회)

curl http://localhost:8000/api/acct/users/
# ✅ 모든 사용자 목록 반환 (권한 우회)
```

### 2. 프로덕션 모드 테스트

```bash
# .env: ENABLE_SECURITY=True

# 서버 재시작
python manage.py runserver

# 토큰 없이 API 테스트
curl http://localhost:8000/api/acct/me/
# ❌ 401 Unauthorized

# 로그인 후 테스트
TOKEN=$(curl -X POST http://localhost:8000/api/acct/login/ \
  -H "Content-Type: application/json" \
  -d '{"username":"admin1","password":"admin123"}' \
  | jq -r '.token')

curl -H "Authorization: Token $TOKEN" \
  http://localhost:8000/api/acct/me/
# ✅ 정상 응답 (인증 성공)
```

---

## 📚 관련 문서

- **[개발모드_가이드.md](cdss-backend/개발모드_가이드.md)** - 상세 사용 가이드
- **[README.md](cdss-backend/README.md)** - 백엔드 설치 가이드
- **[보안_아키텍처_정책.md](보안_아키텍처_정책.md)** - 프로덕션 보안 정책

---

## 📝 코드 예시

### settings.py 핵심 로직

```python
# 보안 설정 토글
ENABLE_SECURITY = os.getenv('ENABLE_SECURITY', 'False').lower() == 'true'

# REST Framework 권한 설정
if ENABLE_SECURITY:
    # 프로덕션: 인증 필수
    DEFAULT_PERMISSION_CLASSES = ["rest_framework.permissions.IsAuthenticated"]
else:
    # 개발: 인증 우회
    DEFAULT_PERMISSION_CLASSES = ["rest_framework.permissions.AllowAny"]

REST_FRAMEWORK = {
    "DEFAULT_PERMISSION_CLASSES": DEFAULT_PERMISSION_CLASSES,
    # ...
}
```

### views.py에서 조건부 처리

```python
from django.conf import settings

@api_view(['GET'])
def my_view(request):
    if settings.ENABLE_SECURITY:
        # 프로덕션: 엄격한 검증
        if not request.user.is_admin:
            return Response({'error': 'Forbidden'}, status=403)
    else:
        # 개발: 경고만
        print("⚠️ 개발 모드: 권한 검증 우회")

    return Response({"status": "ok"})
```

---

## ✨ 장점

### 1. 개발 속도 향상

- 토큰 발급 없이 즉시 API 테스트
- 권한 로직 작성 후에도 기능 우선 개발 가능

### 2. 유연한 전환

- `.env` 파일 한 줄만 수정하면 즉시 전환
- 코드 변경 없이 모드 전환

### 3. 보안 정책 유지

- 프로덕션에서는 강력한 보안 유지
- 개발과 프로덕션 코드 일치

---

## 🎯 다음 단계

1. ✅ **현재**: 개발 모드로 Week 2-3 작업 진행
   - UC02 (EMR) - OpenEMR 프록시
   - UC07 (ALERT) - 알림 시스템
   - React 프론트엔드

2. 🔜 **Week 4**: 보안 테스트
   - `ENABLE_SECURITY=True`로 전환
   - 역할별 권한 테스트
   - 감사 로그 확인

3. 🚀 **배포 전**: 프로덕션 모드 활성화
   - `.env`: `ENABLE_SECURITY=True`
   - Docker: `environment: ENABLE_SECURITY=true`
   - 보안 체크리스트 완료

---

## ❓ FAQ

**Q1. 개발 모드에서 로그인은 동작하나요?**
A: 네, 로그인/회원가입 API는 정상 동작합니다. 단, 로그인 없이도 다른 API를 호출할 수 있습니다.

**Q2. 감사 로그는 어떻게 되나요?**
A: 개발 모드에서는 LOGIN/LOGOUT만 기록됩니다. 프로덕션 모드에서는 모든 액션이 기록됩니다.

**Q3. 권한 코드는 작성해야 하나요?**
A: 네, `@permission_classes([IsAdmin])` 등의 권한 코드는 작성하세요. 개발 모드에서는 무시되지만, 프로덕션에서 자동 적용됩니다.

**Q4. Docker에서는 어떻게 설정하나요?**
A: `docker-compose.yml`의 `environment` 섹션에 `ENABLE_SECURITY: "true"` 추가.

---

**개발 모드 설정이 완료되었습니다!** 🎉

이제 보안/권한 걱정 없이 빠르게 개발하고, 배포 시 한 번에 활성화할 수 있습니다.

**프로덕션 배포 시 반드시 `ENABLE_SECURITY=True`로 설정하세요!** 🔒
