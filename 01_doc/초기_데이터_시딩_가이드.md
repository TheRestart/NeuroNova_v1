# NeuroNova CDSS - ì´ˆê¸° ë°ì´í„° ì‹œë”© ê°€ì´ë“œ

**ìµœì¢… ìˆ˜ì •ì¼**: 2026-01-05
**ë²„ì „**: 3.0
**ëª©ì **: Direct DB Access ë° Outbox Patternì´ ì ìš©ëœ í™˜ê²½ì—ì„œ ì´ˆê¸° ë°ì´í„°ë¥¼ ì•ˆì •ì ìœ¼ë¡œ ì‹œë”©í•˜ëŠ” ë°©ë²• ê°€ì´ë“œ

---

## ğŸ“‹ ëª©ì°¨

1. [ê°œìš” ë° ì•„í‚¤í…ì²˜ ë³€ê²½](#ê°œìš”-ë°-ì•„í‚¤í…ì²˜-ë³€ê²½)
2. [ë°ì´í„° ì €ì¥ì†Œ êµ¬ì¡° (v3.0)](#ë°ì´í„°-ì €ì¥ì†Œ-êµ¬ì¡°-v30)
3. [ë¹ ë¥¸ ì‹œì‘ (Step-by-Step)](#ë¹ ë¥¸-ì‹œì‘-step-by-step)
4. [ë°ì´í„° ì‹œë”© ìƒì„¸](#ë°ì´í„°-ì‹œë”©-ìƒì„¸)
5. [ê²€ì¦ ë° í™•ì¸](#ê²€ì¦-ë°-í™•ì¸)
6. [íŠ¸ëŸ¬ë¸”ìŠˆíŒ…](#íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)

---

## ğŸ¯ ê°œìš” ë° ì•„í‚¤í…ì²˜ ë³€ê²½

**v3.0 (2026-01-05)** ì—ì„œëŠ” ê¸°ì¡´ API ê¸°ë°˜ ë™ê¸°í™” ëŒ€ì‹  **Direct Database Access**ì™€ **Outbox Pattern**ì„ ë„ì…í–ˆìŠµë‹ˆë‹¤.
ì´ì— ë”°ë¼ ë°ì´í„° ì‹œë”© í”„ë¡œì„¸ìŠ¤ë„ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.

**ì£¼ìš” ë³€ê²½ ì‚¬í•­**:
1. **API í˜¸ì¶œ ì œê±°**: OpenEMR APIë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šê³  `openemr` DBì— ì§ì ‘ ì ‘ì†í•˜ì—¬ ë°ì´í„°ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
2. **ë¹„ë™ê¸° í•„ìˆ˜**: ì‹œë”© ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì§í›„ì—ëŠ” OpenEMR IDê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©°, ë°±ê·¸ë¼ìš´ë“œ Celery Workerê°€ `SyncOutbox`ë¥¼ ì²˜ë¦¬í•œ í›„ ìƒì„±ë©ë‹ˆë‹¤.
3. **Service Layer ì‚¬ìš©**: ìŠ¤í¬ë¦½íŠ¸ê°€ ì§ì ‘ ëª¨ë¸(`PatientCache`)ì„ ìƒì„±í•˜ì§€ ì•Šê³ , `PatientService`ë¥¼ í†µí•´ Outbox ì´ë²¤íŠ¸ë¥¼ íŠ¸ë¦¬ê±°í•©ë‹ˆë‹¤.

---

## ğŸ—ï¸ ë°ì´í„° ì €ì¥ì†Œ êµ¬ì¡° (v3.0)

### 1. Django MySQL (Cache + Ops)
- **`PatientCache`**: ë¡œì»¬ í™˜ì ì •ë³´. `openemr_patient_id` í•„ë“œëŠ” ë™ê¸°í™” ì™„ë£Œ ì „ê¹Œì§€ `NULL` ë˜ëŠ” ëŒ€ê¸° ìƒíƒœì…ë‹ˆë‹¤.
- **`SyncOutbox`**: ì™¸ë¶€ ì‹œìŠ¤í…œ(OpenEMR, FHIR)ìœ¼ë¡œ ë³´ë‚¼ ë°ì´í„° ë³€ê²½ ì´ë²¤íŠ¸ë¥¼ ì €ì¥í•©ë‹ˆë‹¤.

### 2. OpenEMR Database (Direct Access)
- **`patient_data`**: Djangoì˜ `OpenEMRRouter`ë¥¼ í†µí•´ ì§ì ‘ Insert/Update ë©ë‹ˆë‹¤.
- **ID ì²´ê³„**: OpenEMRì˜ Auto Increment ID (Integer)ë¥¼ ë”°ë¦…ë‹ˆë‹¤. (ì˜ˆ: `456`, `457`)

---

## ğŸš€ ë¹ ë¥¸ ì‹œì‘ (Step-by-Step)

### ì „ì œ ì¡°ê±´
- Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì¤‘ (`openemr-db` í¬í•¨)
- Celery Worker ì‹¤í–‰ ì¤‘ (ë¹„ë™ê¸° ì²˜ë¦¬ë¥¼ ìœ„í•´ í•„ìˆ˜)

### Step 1: í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì ìƒì„±
```powershell
docker-compose -f docker-compose.dev.yml exec django python manage.py create_test_users
```

### Step 2: ì´ˆê¸° ë°ì´í„° ì‹œë”© (v3.0 Refactored)
ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” `PatientService`ë¥¼ ì‚¬ìš©í•˜ì—¬ í™˜ìë¥¼ ìƒì„±í•˜ê³  Outboxì— ë™ê¸°í™” ì´ë²¤íŠ¸ë¥¼ ë°œí–‰í•©ë‹ˆë‹¤.

```powershell
docker-compose -f docker-compose.dev.yml exec django python manage.py seed_initial_data
```

**ì¶œë ¥ ì˜ˆì‹œ**:
```
[START] Initial Data Seeding
============================================================
[STEP 1/4] Creating Users...
   [OK] User created: admin (admin)
   ...

[STEP 2/4] Creating Patients (Django MySQL)...
   [OK] Patient created: P-2025-001 - Kim MinJun
   [INFO] OpenEMR Sync: Pending (Async Task Queued)
   [OK] Patient created: P-2025-002 - Lee SeoYun
   [INFO] OpenEMR Sync: Pending (Async Task Queued)
   ...

[STEP 3/4] Syncing to OpenEMR (Outbox pattern)...
   [INFO] 5 patients queued for OpenEMR sync
   [INFO] Celery worker will process in background
```

### Step 3: ë™ê¸°í™” ëŒ€ê¸° ë° í™•ì¸
Celery Workerê°€ Outboxë¥¼ ì²˜ë¦¬í•  ë•Œê¹Œì§€ ì•½ 5~10ì´ˆ ëŒ€ê¸° í›„ ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤.

```powershell
docker-compose -f docker-compose.dev.yml exec django python manage.py check_sync_status
```

**ì„±ê³µ ì‹œ ì¶œë ¥**:
```
[Outbox Status]
   Pending: 0
   Done: 5

[Recent Syncs]
   P-2025-001: Synced (ID: 456)
   P-2025-002: Synced (ID: 457)
```

---

## ğŸ“¦ ë°ì´í„° ì‹œë”© ìƒì„¸

### ì‹œë”© ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ (`seed_initial_data.py`)

1. **PatientService.create_patient(data)** í˜¸ì¶œ
2. **Transaction Start**
    - `PatientCache` INSERT (ë¡œì»¬ DB)
    - `SyncOutbox` INSERT (status='pending')
3. **Transaction Commit**
4. **Celery Task Trigger** (`process_sync_outbox`)

### ì£¼ì˜ì‚¬í•­
- ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì§í›„ `openemr_patient_id`ë¥¼ ì¡°íšŒí•˜ë©´ ê°’ì´ ì—†ê±°ë‚˜ ì´ì „ ìƒíƒœì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
- ë°˜ë“œì‹œ `SyncOutbox`ì˜ ìƒíƒœê°€ `done`ìœ¼ë¡œ ë³€ê²½ëœ ê²ƒì„ í™•ì¸í•´ì•¼ í•©ë‹ˆë‹¤.

---

## ğŸ”§ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### 1. ë™ê¸°í™”ê°€ 'Pending'ì—ì„œ ë©ˆì¶˜ ê²½ìš°
- **ì›ì¸**: Celery Workerê°€ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ê±°ë‚˜ íê°€ ë§‰í˜.
- **í•´ê²°**:
  ```powershell
  docker-compose -f docker-compose.dev.yml logs celery-worker
  docker-compose -f docker-compose.dev.yml restart celery-worker
  ```

### 2. 'Failed' ìƒíƒœ ë°œìƒ
- **ì›ì¸**: OpenEMR DB ì—°ê²° ì‹¤íŒ¨ (Direct DB Access ì˜¤ë¥˜).
- **í•´ê²°**: `error_message` í•„ë“œ í™•ì¸. (ì˜ˆ: `Can't connect to MySQL server on 'openemr-db'`)
  - `.env` íŒŒì¼ì˜ `OPENEMR_DB_HOST`, `PORT` í™•ì¸.
  - OpenEMR DB ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸.

### 3. ID ë§¤í•‘ ì˜¤ë¥˜
- **ì¦ìƒ**: OpenEMRì—ëŠ” ìƒì„±ë˜ì—ˆëŠ”ë° Djangoì— IDê°€ ì—…ë°ì´íŠ¸ë˜ì§€ ì•ŠìŒ.
- **í•´ê²°**: Outbox Taskê°€ ë§ˆì§€ë§‰ ë‹¨ê³„(ë¡œì»¬ ì—…ë°ì´íŠ¸)ì—ì„œ ì‹¤íŒ¨í–ˆì„ ìˆ˜ ìˆìŒ. `retry_failed_outbox` ëª…ë ¹ì–´ë¡œ ì¬ì‹œë„.
