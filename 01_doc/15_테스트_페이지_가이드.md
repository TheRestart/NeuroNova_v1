# 15. 테스트 페이지 사용 가이드

**문서 작성일**: 2025-12-23
**작성자**: Antigravity AI
**버전**: 2.0
**최종 수정일**: 2025-12-23 (종합 테스트 대시보드 추가)

---

## 📋 개요

본 문서는 CDSS 시스템의 API 및 데이터 기능을 시각적으로 검증하기 위해 제공되는 **테스트 페이지(UI)**의 사용 방법을 설명합니다. 개발자는 복잡한 API 도구(Postman, curl 등) 없이 브라우저에서 버튼 클릭만으로 주요 시나리오를 테스트할 수 있습니다.

## 🖥️ 테스트 페이지 목록

| 구분 | 파일/경로 | 설명 | 실행 방법 |
|---|---|---|---|
| **종합 테스트 대시보드** (⭐ 추천) | `/api/emr/comprehensive-test/` | Django 서버 내장 뷰. **모든 EMR CRUD, OpenEMR 연동, Write-Through 패턴**을 하나의 페이지에서 통합 테스트. 6개 탭으로 구성된 최신 종합 테스트 도구. | 브라우저 접속 (서버 실행 필요) |
| **통합 대시보드** | `/api/emr/test-dashboard/` | Django 서버 내장 뷰. **환자/처방/상세항목 CRUD 전체 시나리오**를 순차적으로 테스트 가능. | 브라우저 접속 (서버 실행 필요) |
| ~~**상세 CRUD 테스트**~~ | `_legacy_test_files/emr_crud_test.html` | ⚠️ Deprecated. 종합 테스트 대시보드로 대체됨. | - |
| ~~**기존 UI 테스트**~~ | `_legacy_test_files/emr-test-ui.html` | ⚠️ Deprecated. 종합 테스트 대시보드로 대체됨. | - |

---

## 🚀 사용 방법 상세

### 0. 종합 테스트 대시보드 (⭐ 최신 추천)
모든 EMR 테스트 기능을 통합한 최신 테스트 도구입니다. **Write-Through 패턴**을 포함한 전체 시나리오를 하나의 페이지에서 테스트할 수 있습니다.

1.  **Django 서버 실행**:
    가상환경을 먼저 활성화해주세요.
    ```bash
    # Windows (PowerShell)
    .\venv\Scripts\Activate

    # 서버 실행
    python manage.py runserver 0.0.0.0:8000
    ```
2.  **브라우저 접속**: `http://localhost:8000/api/emr/comprehensive-test/`
3.  **6개 탭 구성**:
    *   **📊 Overview**: 시스템 상태 및 테스트 통계 대시보드
    *   **🔗 OpenEMR Integration**: OpenEMR 연동 테스트 (Health Check, Auth, FHIR API)
    *   **👤 Patient CRUD**: 환자 생성, 조회, 검색, 수정, 삭제
    *   **📋 Encounter CRUD**: 진료 기록 CRUD 테스트
    *   **💊 Order/OCS**: 처방 및 처방 항목 CRUD, Write-Through 패턴
    *   **🔄 Write-Through**: 환자 프로필 수정 Write-Through 패턴 전용 테스트
4.  **주요 기능**:
    *   ✅ 예제 데이터 자동 채우기 버튼 (Auto-fill)
    *   ✅ 실시간 API 응답 표시 (JSON 포맷)
    *   ✅ 색상별 성공/실패 메시지
    *   ✅ 테스트 실행 통계 추적
    *   ✅ 반응형 디자인 (모바일 지원)

### 1. 통합 대시보드
순차적 시나리오 테스트용 대시보드입니다.

1.  **Django 서버 실행**:
    가상환경을 먼저 활성화해주세요.
    ```bash
    # Windows (PowerShell)
    .\venv\Scripts\Activate

    # 서버 실행
    python manage.py runserver 0.0.0.0:8000
    ```
2.  **브라우저 접속**: `http://localhost:8000/api/emr/test-dashboard/`
3.  **기능 확인**:
    *   **Step 1: 환자 생성** - 버튼 클릭 시 랜덤 데이터로 환자 생성 및 ID 확보
    *   **Step 2: 처방 생성** - 확보된 환자 ID로 타겟 약품 처방 내리기
    *   **Step 3: 항목 수정** - 처방 약품의 투여량(Dosage) 변경 테스트 (PATCH)
    *   **Step 4: 항목 삭제** - 처방 약품 삭제 테스트 (DELETE)

### 2. ~~Standalone HTML 파일~~ (⚠️ Deprecated)

**레거시 파일들이 `_legacy_test_files/` 폴더로 이동되었습니다:**
- `_legacy_test_files/emr_crud_test.html` - 상세 CRUD 테스트 (더 이상 사용 안 함)
- `_legacy_test_files/emr-test-ui.html` - 기존 UI 테스트 (더 이상 사용 안 함)

**권장사항:**
- ✅ 모든 테스트는 **종합 테스트 대시보드**(`/api/emr/comprehensive-test/`)를 사용하세요
- ✅ 레거시 파일은 참고용으로만 보관되며, 필요시 완전히 삭제 가능합니다

---

## 🔄 Write-Through 패턴 테스트

종합 테스트 대시보드의 **Write-Through 탭**에서는 환자 프로필 수정 시 FHIR 서버와 Django DB 간의 데이터 일관성을 검증할 수 있습니다.

### 테스트 시나리오

#### 시나리오 1: 정상 업데이트 (200 OK)
1. 환자 ID 입력 (예: `P-2025-000001`)
2. 전화번호, 이메일, 주소 수정
3. "Update Patient (Write-Through)" 버튼 클릭
4. **예상 결과**:
   - FHIR 서버 업데이트 성공 → Django DB 업데이트 성공
   - 200 OK 응답
   - 응답창에 업데이트된 환자 정보 표시

#### 시나리오 2: FHIR 서버 거절 (400 Bad Request)
1. 환자 ID 입력
2. 잘못된 형식의 전화번호 입력 (예: `invalid-phone`)
3. "Simulate FHIR Rejection" 버튼 클릭
4. **예상 결과**:
   - FHIR 서버가 유효성 검사 실패로 거절
   - Django DB 수정 없음 (기존 데이터 유지)
   - 400 Bad Request 응답
   - 에러 메시지 표시

#### 시나리오 3: FHIR 서버 장애 (503 Service Unavailable)
1. 환자 ID 입력
2. "Simulate FHIR Timeout" 버튼 클릭
3. **예상 결과**:
   - FHIR 서버 통신 실패
   - Django DB 수정 없음
   - 503 Service Unavailable 응답
   - 재시도 안내 메시지 표시

### 검증 포인트

- ✅ FHIR 서버 성공 시에만 Django DB 업데이트
- ✅ FHIR 서버 실패 시 Django DB 롤백 (변경 없음)
- ✅ 적절한 HTTP 상태 코드 반환 (200, 400, 503)
- ✅ 에러 메시지 명확성
- ✅ `last_synced_at` 타임스탬프 갱신

자세한 내용은 [16_Write_Through_패턴_가이드.md](16_Write_Through_패턴_가이드.md)를 참고하세요.

---

## 📊 테스트 통계 모니터링

종합 테스트 대시보드의 **Overview 탭**에서는 실시간 테스트 통계를 확인할 수 있습니다:

- **Total Tests**: 전체 실행된 테스트 수
- **Passed**: 성공한 테스트 수 (200, 201 응답)
- **Failed**: 실패한 테스트 수 (4xx, 5xx 응답)
- **Success Rate**: 성공률 (%)

각 테스트 실행 후 통계가 자동으로 업데이트되며, 로컬 스토리지에 저장되어 페이지 새로고침 후에도 유지됩니다.

---

## ✅ 트러블슈팅

**Q: HTML 파일에서 Fetch API 호출 시 CORS 에러 발생**
*   **원인**: 로컬 파일(`file://`)에서 `localhost` 서버로 요청을 보낼 때 브라우저 보안 정책에 의해 차단될 수 있습니다.
*   **해결**: `django-cors-headers`가 서버에 설정되어 있는지 확인하거나, **통합 대시보드**(`test-dashboard`)를 사용하세요 (같은 도메인이므로 CORS 문제 없음).

**Q: 401 Unauthorized 에러**
*   **원인**: 인증이 필요한 API를 호출했습니다.
*   **해결**: 현재 테스트용 API는 개발 모드(`AllowAny`)로 열려 있으나, 만약 인증이 필요해진다면 `Authorization` 헤더를 추가해야 합니다.
