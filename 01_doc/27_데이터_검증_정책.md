# ë°ì´í„° ê²€ì¦ ì •ì±… (Data Validation Policy)

**ìµœì¢… ìˆ˜ì •ì¼**: 2025-12-28
**ëª©ì **: API ì…ë ¥ ë°ì´í„° ê²€ì¦ ê·œì¹™ ë° ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥ ì •ì±… ì •ì˜

---

## ğŸ“‹ ëª©ì°¨

1. [ë°ì´í„° ê²€ì¦ ì›ì¹™](#1-ë°ì´í„°-ê²€ì¦-ì›ì¹™)
2. [Serializer ê²€ì¦ ê·œì¹™](#2-serializer-ê²€ì¦-ê·œì¹™)
3. [ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê²€ì¦](#3-ë¹„ì¦ˆë‹ˆìŠ¤-ë¡œì§-ê²€ì¦)
4. [ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥](#4-ë°ì´í„°-ë¬´ê²°ì„±-ë³´ì¥)
5. [ì™¸ë¶€ ì‹œìŠ¤í…œ ì—°ë™ ê²€ì¦](#5-ì™¸ë¶€-ì‹œìŠ¤í…œ-ì—°ë™-ê²€ì¦)
6. [ê²€ì¦ ì‹¤íŒ¨ ì²˜ë¦¬](#6-ê²€ì¦-ì‹¤íŒ¨-ì²˜ë¦¬)

---

## 1. ë°ì´í„° ê²€ì¦ ì›ì¹™

### 1.1 Defensive Programming

**"ì ˆëŒ€ ì‚¬ìš©ì ì…ë ¥ì„ ì‹ ë¢°í•˜ì§€ ë§ˆë¼"**

- ëª¨ë“  ì™¸ë¶€ ì…ë ¥(API Request Body, Query Params, Path Params)ì€ ë°˜ë“œì‹œ ê²€ì¦
- í”„ë¡ íŠ¸ì—”ë“œ ê²€ì¦ì€ UX ê°œì„ ìš©, ë°±ì—”ë“œ ê²€ì¦ì€ ë³´ì•ˆ ë° ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥
- "Fail Fast" ì›ì¹™: ì˜ëª»ëœ ë°ì´í„°ëŠ” ê°€ëŠ¥í•œ ë¹¨ë¦¬ ê±°ë¶€

### 1.2 ê²€ì¦ ê³„ì¸µ (Validation Layers)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. Serializer ê²€ì¦                         â”‚
â”‚     - ë°ì´í„° íƒ€ì…, í˜•ì‹, í•„ìˆ˜ê°’              â”‚
â”‚     - Django REST Framework ê¸°ë³¸ ê²€ì¦        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. ì»¤ìŠ¤í…€ í•„ë“œ ê²€ì¦                         â”‚
â”‚     - validate_<field_name>() ë©”ì„œë“œ         â”‚
â”‚     - ë³µì¡í•œ í˜•ì‹ ê²€ì¦ (ì •ê·œí‘œí˜„ì‹ ë“±)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. ê°ì²´ ìˆ˜ì¤€ ê²€ì¦                           â”‚
â”‚     - validate() ë©”ì„œë“œ                      â”‚
â”‚     - ì—¬ëŸ¬ í•„ë“œ ê°„ ê´€ê³„ ê²€ì¦                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê²€ì¦                       â”‚
â”‚     - Service Layerì—ì„œ ìˆ˜í–‰                 â”‚
â”‚     - ì—…ë¬´ ê·œì¹™, DB ìƒíƒœ í™•ì¸                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 ê²€ì¦ vs ë³€í™˜ (Validation vs Transformation)

| ê²€ì¦ (Validation) | ë³€í™˜ (Transformation) |
|-------------------|----------------------|
| ë°ì´í„°ê°€ ê·œì¹™ì— ë§ëŠ”ì§€ í™•ì¸ | ë°ì´í„°ë¥¼ ì›í•˜ëŠ” í˜•ì‹ìœ¼ë¡œ ë³€ê²½ |
| ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë°œìƒ | ìë™ ì²˜ë¦¬ (ì˜ˆ: trim, lowercase) |
| ì˜ˆ: ì´ë©”ì¼ í˜•ì‹ ì²´í¬ | ì˜ˆ: ê³µë°± ì œê±°, ëŒ€ë¬¸ì ë³€í™˜ |

**ì›ì¹™**: ë³€í™˜ì€ ìµœì†Œí™”í•˜ê³ , ê²€ì¦ì„ ìš°ì„ ì‹œí•˜ë¼.

---

## 2. Serializer ê²€ì¦ ê·œì¹™

### 2.1 ê¸°ë³¸ í•„ë“œ ê²€ì¦

#### í•„ìˆ˜ í•„ë“œ (required)
```python
from rest_framework import serializers

class PatientSerializer(serializers.ModelSerializer):
    name = serializers.CharField(
        required=True,  # í•„ìˆ˜ í•„ë“œ
        max_length=100,
        error_messages={
            'required': 'í™˜ì ì´ë¦„ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.',
            'max_length': 'í™˜ì ì´ë¦„ì€ 100ìë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
        }
    )

    ssn = serializers.CharField(
        required=True,
        max_length=13,
        min_length=13,
        error_messages={
            'required': 'ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.',
            'max_length': 'ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ëŠ” 13ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.',
            'min_length': 'ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ëŠ” 13ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.',
        }
    )

    phone = serializers.CharField(
        required=False,  # ì„ íƒ í•„ë“œ
        allow_blank=True,
        max_length=20,
    )
```

#### ë°ì´í„° íƒ€ì… ê²€ì¦
```python
class EncounterSerializer(serializers.ModelSerializer):
    patient_id = serializers.IntegerField(
        min_value=1,
        error_messages={
            'invalid': 'í™˜ì IDëŠ” ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.',
            'min_value': 'í™˜ì IDëŠ” 1 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.',
        }
    )

    encounter_date = serializers.DateTimeField(
        format='%Y-%m-%dT%H:%M:%S',
        error_messages={
            'invalid': 'ë‚ ì§œ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (YYYY-MM-DDTHH:MM:SS)',
        }
    )

    temperature = serializers.DecimalField(
        max_digits=4,
        decimal_places=1,
        min_value=35.0,
        max_value=45.0,
        error_messages={
            'invalid': 'ì²´ì˜¨ì€ ì†Œìˆ˜ì  1ìë¦¬ê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.',
            'min_value': 'ì²´ì˜¨ì€ 35.0ë„ ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.',
            'max_value': 'ì²´ì˜¨ì€ 45.0ë„ ì´í•˜ì—¬ì•¼ í•©ë‹ˆë‹¤.',
        }
    )
```

#### ì„ íƒ ì œì•½ (Choices)
```python
class PatientSerializer(serializers.ModelSerializer):
    GENDER_CHOICES = [
        ('M', 'Male'),
        ('F', 'Female'),
        ('O', 'Other'),
    ]

    gender = serializers.ChoiceField(
        choices=GENDER_CHOICES,
        error_messages={
            'invalid_choice': 'ì„±ë³„ì€ M, F, O ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•©ë‹ˆë‹¤.',
        }
    )
```

### 2.2 ì»¤ìŠ¤í…€ í•„ë“œ ê²€ì¦ (validate_<field_name>)

```python
import re
from rest_framework import serializers
from utils.exceptions import ValidationException

class PatientSerializer(serializers.ModelSerializer):

    def validate_ssn(self, value):
        """ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ ê²€ì¦"""
        # 1. ê¸¸ì´ ì²´í¬ (ì´ë¯¸ max_lengthë¡œ ì²´í¬ë¨, ì¶”ê°€ ì•ˆì „ì¥ì¹˜)
        if len(value) != 13:
            raise serializers.ValidationError('ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ëŠ” 13ìë¦¬ì—¬ì•¼ í•©ë‹ˆë‹¤.')

        # 2. ìˆ«ìë§Œ í—ˆìš©
        if not value.isdigit():
            raise serializers.ValidationError('ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ëŠ” ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.')

        # 3. ìœ íš¨ì„± ê²€ì¦ (ê°„ë‹¨í•œ ì•Œê³ ë¦¬ì¦˜)
        # ì£¼ë¯¼ë²ˆí˜¸ 7ë²ˆì§¸ ìë¦¬ ì²´í¬ (1, 2, 3, 4ë§Œ í—ˆìš©)
        if value[6] not in ['1', '2', '3', '4']:
            raise serializers.ValidationError('ìœ íš¨í•˜ì§€ ì•Šì€ ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ì…ë‹ˆë‹¤.')

        # 4. ì¤‘ë³µ ì²´í¬ (DB ì¡°íšŒ)
        if self.instance is None:  # ìƒì„± ì‹œì—ë§Œ
            if Patient.objects.filter(ssn=value).exists():
                raise serializers.ValidationError('ì´ë¯¸ ë“±ë¡ëœ ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ì…ë‹ˆë‹¤.')

        return value

    def validate_phone(self, value):
        """ì „í™”ë²ˆí˜¸ ê²€ì¦"""
        if not value:  # ì„ íƒ í•„ë“œì´ë¯€ë¡œ ë¹ˆ ê°’ í—ˆìš©
            return value

        # ì •ê·œí‘œí˜„ì‹: 010-1234-5678 ë˜ëŠ” 01012345678
        pattern = r'^01[0-9]-?\d{3,4}-?\d{4}$'
        if not re.match(pattern, value):
            raise serializers.ValidationError('ì „í™”ë²ˆí˜¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (ì˜ˆ: 010-1234-5678)')

        return value

    def validate_email(self, value):
        """ì´ë©”ì¼ ê²€ì¦"""
        if not value:
            return value

        # Djangoì˜ EmailValidator ì‚¬ìš©
        from django.core.validators import EmailValidator
        validator = EmailValidator(message='ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.')
        try:
            validator(value)
        except Exception:
            raise serializers.ValidationError('ì´ë©”ì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.')

        return value

    def validate_birth_date(self, value):
        """ìƒë…„ì›”ì¼ ê²€ì¦"""
        from datetime import date

        # 1. ë¯¸ë˜ ë‚ ì§œ ë¶ˆê°€
        if value > date.today():
            raise serializers.ValidationError('ìƒë…„ì›”ì¼ì€ ë¯¸ë˜ ë‚ ì§œì¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')

        # 2. 150ì„¸ ì´ìƒ ë¶ˆê°€ (ìƒì‹ì  ë²”ìœ„)
        if (date.today() - value).days > 150 * 365:
            raise serializers.ValidationError('ìƒë…„ì›”ì¼ì´ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.')

        return value
```

### 2.3 ê°ì²´ ìˆ˜ì¤€ ê²€ì¦ (validate)

```python
class OrderSerializer(serializers.ModelSerializer):

    def validate(self, attrs):
        """ì—¬ëŸ¬ í•„ë“œ ê°„ ê´€ê³„ ê²€ì¦"""
        patient_id = attrs.get('patient_id')
        doctor_id = attrs.get('doctor_id')
        order_date = attrs.get('order_date')
        items = attrs.get('items', [])

        # 1. í™˜ìì™€ ì˜ì‚¬ê°€ ê°™ì€ ë³‘ì› ì†Œì†ì¸ì§€ í™•ì¸
        # (ì‹¤ì œë¡œëŠ” ë” ë³µì¡í•œ ë¡œì§)
        if not self.is_same_hospital(patient_id, doctor_id):
            raise serializers.ValidationError({
                'doctor_id': 'í•´ë‹¹ ì˜ì‚¬ëŠ” í™˜ìì˜ ë‹´ë‹¹ ì˜ì‚¬ê°€ ì•„ë‹™ë‹ˆë‹¤.'
            })

        # 2. ì²˜ë°© í•­ëª©ì´ ë¹„ì–´ìˆì§€ ì•Šì€ì§€
        if not items or len(items) == 0:
            raise serializers.ValidationError({
                'items': 'ì²˜ë°© í•­ëª©ì´ ìµœì†Œ 1ê°œ ì´ìƒ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.'
            })

        # 3. ê³¼ê±° ë‚ ì§œë¡œ ì²˜ë°© ë¶ˆê°€
        from datetime import datetime
        if order_date < datetime.now():
            raise serializers.ValidationError({
                'order_date': 'ì²˜ë°© ë‚ ì§œëŠ” í˜„ì¬ ë˜ëŠ” ë¯¸ë˜ì—¬ì•¼ í•©ë‹ˆë‹¤.'
            })

        return attrs

    def is_same_hospital(self, patient_id, doctor_id):
        """ë³‘ì› ì†Œì† í™•ì¸ (ì˜ˆì‹œ)"""
        # ì‹¤ì œ êµ¬í˜„ ë¡œì§
        return True
```

---

## 3. ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ê²€ì¦

### 3.1 Service Layer ê²€ì¦

SerializerëŠ” **í˜•ì‹ ê²€ì¦**ë§Œ ë‹´ë‹¹í•˜ê³ , **ì—…ë¬´ ê·œì¹™ ê²€ì¦**ì€ Service Layerì—ì„œ ìˆ˜í–‰í•©ë‹ˆë‹¤.

```python
# services/emr_service.py
from utils.exceptions import BusinessLogicException, ResourceNotFoundException

class EMRService:

    def create_encounter(self, patient_id, doctor_id, encounter_date):
        """ì§„ë£Œ ê¸°ë¡ ìƒì„±"""

        # 1. í™˜ì ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        try:
            patient = Patient.objects.get(pk=patient_id)
        except Patient.DoesNotExist:
            raise ResourceNotFoundException(
                code='ERR_201',
                message='ìš”ì²­í•œ í™˜ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                detail=f'Patient ID: {patient_id}'
            )

        # 2. ì˜ì‚¬ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
        try:
            doctor = User.objects.get(pk=doctor_id, role__in=['Doctor', 'RIB'])
        except User.DoesNotExist:
            raise ResourceNotFoundException(
                code='ERR_202',
                message='ìš”ì²­í•œ ì˜ì‚¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                detail=f'Doctor ID: {doctor_id}'
            )

        # 3. ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™: í™˜ìê°€ ì´ë¯¸ ì§„ë£Œ ì¤‘ì¸ì§€ í™•ì¸
        active_encounter = Encounter.objects.filter(
            patient_id=patient_id,
            status='IN_PROGRESS'
        ).first()

        if active_encounter:
            raise BusinessLogicException(
                code='ERR_401',
                message='í™˜ìê°€ ì´ë¯¸ ì§„ë£Œ ì¤‘ì…ë‹ˆë‹¤.',
                detail=f'Active Encounter ID: {active_encounter.id}, Doctor: {active_encounter.doctor.username}'
            )

        # 4. ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™: ì˜ì‚¬ì˜ í•˜ë£¨ ì§„ë£Œ í™˜ì ìˆ˜ ì œí•œ (ì˜ˆ: 50ëª…)
        from datetime import datetime, timedelta
        today_start = datetime.combine(encounter_date.date(), datetime.min.time())
        today_end = today_start + timedelta(days=1)

        today_encounters = Encounter.objects.filter(
            doctor_id=doctor_id,
            encounter_date__gte=today_start,
            encounter_date__lt=today_end
        ).count()

        if today_encounters >= 50:
            raise BusinessLogicException(
                code='ERR_402',
                message='ì˜ì‚¬ì˜ í•˜ë£¨ ì§„ë£Œ í™˜ì ìˆ˜ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤.',
                detail=f'Doctor: {doctor.username}, Today encounters: {today_encounters}'
            )

        # 5. ì§„ë£Œ ê¸°ë¡ ìƒì„± (OpenEMR + Django DB ë³‘ë ¬)
        encounter = self._create_encounter_dual_write(patient, doctor, encounter_date)

        return encounter
```

### 3.2 Repository Layer ê²€ì¦

```python
# repositories/patient_repository.py
from utils.exceptions import ConflictException

class PatientRepository:

    def create(self, patient_data):
        """í™˜ì ìƒì„± (ì¤‘ë³µ ì²´í¬ í¬í•¨)"""

        # ë‚™ê´€ì  ë½ ì¶©ëŒ ê°ì§€
        try:
            patient = Patient.objects.create(**patient_data)
        except IntegrityError as e:
            if 'unique constraint' in str(e).lower():
                raise ConflictException(
                    code='ERR_301',
                    message='ì´ë¯¸ ì¡´ì¬í•˜ëŠ” í™˜ìì…ë‹ˆë‹¤.',
                    detail=str(e)
                )
            raise

        return patient

    def update(self, patient_id, patient_data, expected_version):
        """í™˜ì ì •ë³´ ìˆ˜ì • (ë‚™ê´€ì  ë½)"""

        # version í•„ë“œë¥¼ ì‚¬ìš©í•œ ë‚™ê´€ì  ë½
        updated = Patient.objects.filter(
            pk=patient_id,
            version=expected_version
        ).update(
            **patient_data,
            version=expected_version + 1
        )

        if updated == 0:
            # version ë¶ˆì¼ì¹˜ = ë‹¤ë¥¸ ì‚¬ìš©ìê°€ ì´ë¯¸ ìˆ˜ì •í•¨
            raise ConflictException(
                code='ERR_302',
                message='ë°ì´í„°ê°€ ë‹¤ë¥¸ ì‚¬ìš©ìì— ì˜í•´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
                detail=f'Patient ID: {patient_id}, Expected version: {expected_version}'
            )

        return Patient.objects.get(pk=patient_id)
```

---

## 4. ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥

### 4.1 ë°ì´í„°ë² ì´ìŠ¤ ì œì•½ì¡°ê±´ (DB Constraints)

#### ëª¨ë¸ ì •ì˜
```python
from django.db import models
from django.core.validators import MinValueValidator, MaxValueValidator

class Patient(models.Model):
    """í™˜ì ëª¨ë¸"""

    name = models.CharField(
        max_length=100,
        null=False,  # NOT NULL
        blank=False,
    )

    ssn = models.CharField(
        max_length=13,
        unique=True,  # UNIQUE ì œì•½
        db_index=True,  # ì¸ë±ìŠ¤ ìƒì„±
    )

    birth_date = models.DateField(
        validators=[
            # 1900-01-01 ì´í›„ë§Œ í—ˆìš©
            MinValueValidator(limit_value=date(1900, 1, 1)),
        ]
    )

    gender = models.CharField(
        max_length=1,
        choices=[('M', 'Male'), ('F', 'Female'), ('O', 'Other')],
    )

    version = models.IntegerField(
        default=0,
        help_text='ë‚™ê´€ì  ë½ ë²„ì „'
    )

    class Meta:
        db_table = 'patient'
        indexes = [
            models.Index(fields=['name']),
            models.Index(fields=['birth_date']),
        ]
        constraints = [
            models.CheckConstraint(
                check=models.Q(gender__in=['M', 'F', 'O']),
                name='patient_gender_valid'
            ),
        ]
```

#### ì™¸ë˜ í‚¤ ì œì•½ (Foreign Key)
```python
class Encounter(models.Model):
    """ì§„ë£Œ ê¸°ë¡ ëª¨ë¸"""

    patient = models.ForeignKey(
        Patient,
        on_delete=models.PROTECT,  # í™˜ì ì‚­ì œ ë°©ì§€ (ì§„ë£Œ ê¸°ë¡ì´ ìˆìœ¼ë©´)
        related_name='encounters',
    )

    doctor = models.ForeignKey(
        User,
        on_delete=models.PROTECT,
        related_name='doctor_encounters',
        limit_choices_to={'role__in': ['Doctor', 'RIB']},  # ì˜ì‚¬ë§Œ í—ˆìš©
    )

    status = models.CharField(
        max_length=20,
        choices=[
            ('SCHEDULED', 'Scheduled'),
            ('IN_PROGRESS', 'In Progress'),
            ('COMPLETED', 'Completed'),
            ('CANCELLED', 'Cancelled'),
        ],
        default='SCHEDULED',
    )

    class Meta:
        constraints = [
            # í•œ í™˜ìëŠ” ë™ì‹œì— í•˜ë‚˜ì˜ ì§„ë£Œë§Œ ì§„í–‰ ê°€ëŠ¥
            models.UniqueConstraint(
                fields=['patient'],
                condition=models.Q(status='IN_PROGRESS'),
                name='unique_active_encounter_per_patient'
            ),
        ]
```

### 4.2 íŠ¸ëœì­ì…˜ ê´€ë¦¬ (Transaction Management)

```python
from django.db import transaction
from utils.exceptions import ExternalSystemException

class EMRService:

    @transaction.atomic
    def create_encounter_with_vitals(self, encounter_data, vitals_data):
        """ì§„ë£Œ ê¸°ë¡ + ë°”ì´íƒˆ ì‚¬ì¸ ìƒì„± (ì›ìì„± ë³´ì¥)"""

        # 1. ì§„ë£Œ ê¸°ë¡ ìƒì„±
        encounter = Encounter.objects.create(**encounter_data)

        # 2. ë°”ì´íƒˆ ì‚¬ì¸ ìƒì„±
        try:
            vitals = VitalSign.objects.create(
                encounter=encounter,
                **vitals_data
            )
        except Exception as e:
            # ì—ëŸ¬ ë°œìƒ ì‹œ ìë™ ë¡¤ë°± (encounterë„ í•¨ê»˜ ì·¨ì†Œ)
            raise

        # 3. OpenEMR ë™ê¸°í™” (ì‹¤íŒ¨ ì‹œ ë¡¤ë°±)
        try:
            self.openemr_client.sync_encounter(encounter)
        except Exception as e:
            raise ExternalSystemException(
                code='ERR_501',
                message='OpenEMR ì—°ë™ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
                detail=str(e)
            )

        return encounter
```

### 4.3 ë³‘ë ¬ ë°ì´í„° ì „ë‹¬ (Parallel Dual-Write) ë¬´ê²°ì„±

```python
from utils.exceptions import ExternalSystemException

class PatientService:

    def create_patient(self, patient_data):
        """í™˜ì ìƒì„± (Django DB + OpenEMR ë³‘ë ¬)"""

        django_success = False
        openemr_success = False
        django_patient = None
        openemr_patient_id = None

        try:
            # 1. Django DB ì €ì¥
            django_patient = Patient.objects.create(**patient_data)
            django_success = True

        except Exception as e:
            django_success = False
            raise ValidationException(
                code='ERR_101',
                message='í™˜ì ì •ë³´ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
                detail=str(e)
            )

        try:
            # 2. OpenEMR ì €ì¥ (ë³‘ë ¬)
            openemr_patient_id = self.openemr_client.create_patient(patient_data)
            openemr_success = True

        except Exception as e:
            openemr_success = False
            # OpenEMR ì‹¤íŒ¨ëŠ” ê²½ê³ ë§Œ (Django DBëŠ” ìœ ì§€)
            logger.warning(f'OpenEMR sync failed for Patient {django_patient.id}: {str(e)}')

        # 3. ì‘ë‹µì— persistence_status í¬í•¨
        return {
            'patient': django_patient,
            'persistence_status': {
                'django_db': 'SUCCESS' if django_success else 'FAILURE',
                'openemr': 'SUCCESS' if openemr_success else 'FAILURE',
                'openemr_id': openemr_patient_id,
            }
        }
```

---

## 5. ì™¸ë¶€ ì‹œìŠ¤í…œ ì—°ë™ ê²€ì¦

### 5.1 OpenEMR ë°ì´í„° ê²€ì¦

```python
class OpenEMRClient:

    def create_patient(self, patient_data):
        """OpenEMR í™˜ì ìƒì„± (ì‘ë‹µ ê²€ì¦)"""

        # 1. ìš”ì²­ ì „ì†¡
        response = requests.post(
            f'{self.base_url}/apis/default/api/patient',
            json=patient_data,
            headers=self.headers,
            timeout=10  # íƒ€ì„ì•„ì›ƒ ì„¤ì •
        )

        # 2. HTTP ìƒíƒœ ì½”ë“œ ê²€ì¦
        if response.status_code != 200:
            raise ExternalSystemException(
                code='ERR_501',
                message='OpenEMR í™˜ì ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
                detail=f'Status: {response.status_code}, Response: {response.text}'
            )

        # 3. ì‘ë‹µ ë°ì´í„° ê²€ì¦
        try:
            data = response.json()
        except Exception:
            raise ExternalSystemException(
                code='ERR_501',
                message='OpenEMR ì‘ë‹µ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
                detail=response.text
            )

        # 4. í•„ìˆ˜ í•„ë“œ ê²€ì¦
        if 'pid' not in data or not data['pid']:
            raise ExternalSystemException(
                code='ERR_501',
                message='OpenEMR í™˜ì IDë¥¼ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.',
                detail=str(data)
            )

        return data['pid']
```

### 5.2 Orthanc PACS ë°ì´í„° ê²€ì¦

```python
class OrthancClient:

    def upload_dicom(self, dicom_file):
        """DICOM íŒŒì¼ ì—…ë¡œë“œ (ê²€ì¦ í¬í•¨)"""

        # 1. íŒŒì¼ í¬ê¸° ê²€ì¦ (ì˜ˆ: 100MB ì œí•œ)
        max_size = 100 * 1024 * 1024  # 100MB
        if dicom_file.size > max_size:
            raise ValidationException(
                code='ERR_105',
                message='íŒŒì¼ í¬ê¸°ê°€ ë„ˆë¬´ í½ë‹ˆë‹¤. (ìµœëŒ€ 100MB)',
                detail=f'File size: {dicom_file.size} bytes'
            )

        # 2. DICOM íŒŒì¼ í˜•ì‹ ê²€ì¦
        if not dicom_file.name.endswith('.dcm'):
            raise ValidationException(
                code='ERR_104',
                message='DICOM íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤. (.dcm)',
                field='dicom_file'
            )

        # 3. Orthanc ì—…ë¡œë“œ
        response = requests.post(
            f'{self.base_url}/instances',
            files={'file': dicom_file},
            timeout=60  # DICOM íŒŒì¼ì€ í¬ë¯€ë¡œ íƒ€ì„ì•„ì›ƒ ê¸¸ê²Œ
        )

        # 4. ì‘ë‹µ ê²€ì¦
        if response.status_code != 200:
            raise ExternalSystemException(
                code='ERR_502',
                message='Orthanc PACS ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
                detail=response.text
            )

        data = response.json()
        return data.get('ID')
```

### 5.3 RabbitMQ ë©”ì‹œì§€ ê²€ì¦

```python
class AIQueueService:

    def send_analysis_request(self, aijob_id, study_id, priority='NORMAL'):
        """AI ë¶„ì„ ìš”ì²­ (ë©”ì‹œì§€ ê²€ì¦)"""

        # 1. ìš°ì„ ìˆœìœ„ ê²€ì¦
        valid_priorities = ['LOW', 'NORMAL', 'HIGH', 'URGENT']
        if priority not in valid_priorities:
            raise ValidationException(
                code='ERR_101',
                message=f'ìš°ì„ ìˆœìœ„ëŠ” {", ".join(valid_priorities)} ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•©ë‹ˆë‹¤.',
                field='priority'
            )

        # 2. Study ID ì¡´ì¬ ì—¬ë¶€ í™•ì¸ (Orthanc)
        study_exists = self.orthanc_client.check_study_exists(study_id)
        if not study_exists:
            raise ResourceNotFoundException(
                code='ERR_205',
                message='ìš”ì²­í•œ ì˜ìƒ ìë£Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                detail=f'Study ID: {study_id}'
            )

        # 3. ë©”ì‹œì§€ ì „ì†¡
        message = {
            'aijob_id': aijob_id,
            'study_id': study_id,
            'priority': priority,
            'timestamp': datetime.utcnow().isoformat()
        }

        try:
            self.channel.basic_publish(
                exchange='ai_analysis',
                routing_key=priority.lower(),
                body=json.dumps(message),
                properties=pika.BasicProperties(
                    delivery_mode=2,  # ë©”ì‹œì§€ ì˜ì†í™”
                )
            )
        except Exception as e:
            raise ExternalSystemException(
                code='ERR_503',
                message='RabbitMQ ë©”ì‹œì§€ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.',
                detail=str(e)
            )

        return True
```

---

## 6. ê²€ì¦ ì‹¤íŒ¨ ì²˜ë¦¬

### 6.1 ì—ëŸ¬ ì‘ë‹µ í˜•ì‹

ê²€ì¦ ì‹¤íŒ¨ ì‹œ í‘œì¤€ ì—ëŸ¬ ì‘ë‹µ í˜•ì‹ì„ ì‚¬ìš©í•©ë‹ˆë‹¤ ([25_ì—ëŸ¬_í•¸ë“¤ë§_ê°€ì´ë“œ.md](25_ì—ëŸ¬_í•¸ë“¤ë§_ê°€ì´ë“œ.md) ì°¸ì¡°):

```json
{
  "error": {
    "code": "ERR_101",
    "message": "ì…ë ¥ê°’ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.",
    "field": "ssn",
    "detail": "ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ëŠ” 13ìë¦¬ ìˆ«ìì—¬ì•¼ í•©ë‹ˆë‹¤.",
    "timestamp": "2025-12-28T10:30:00Z"
  }
}
```

### 6.2 ë‹¤ì¤‘ í•„ë“œ ê²€ì¦ ì‹¤íŒ¨

```python
from rest_framework import serializers

class PatientSerializer(serializers.ModelSerializer):

    def validate(self, attrs):
        errors = {}

        # ì—¬ëŸ¬ í•„ë“œ ê²€ì¦
        if not attrs.get('name'):
            errors['name'] = 'í™˜ì ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤.'

        if not attrs.get('ssn'):
            errors['ssn'] = 'ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤.'

        if errors:
            # ì—¬ëŸ¬ í•„ë“œ ì—ëŸ¬ë¥¼ í•œë²ˆì— ë°˜í™˜
            raise serializers.ValidationError(errors)

        return attrs
```

ì‘ë‹µ ì˜ˆì‹œ:
```json
{
  "name": ["í™˜ì ì´ë¦„ì€ í•„ìˆ˜ì…ë‹ˆë‹¤."],
  "ssn": ["ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤."]
}
```

### 6.3 ë¡œê¹… ë° ëª¨ë‹ˆí„°ë§

```python
import logging
logger = logging.getLogger(__name__)

class PatientSerializer(serializers.ModelSerializer):

    def validate_ssn(self, value):
        try:
            # ê²€ì¦ ë¡œì§
            if not self.is_valid_ssn(value):
                raise serializers.ValidationError('ìœ íš¨í•˜ì§€ ì•Šì€ ì£¼ë¯¼ë“±ë¡ë²ˆí˜¸ì…ë‹ˆë‹¤.')
        except serializers.ValidationError as e:
            # ê²€ì¦ ì‹¤íŒ¨ ë¡œê¹…
            logger.info(
                f'SSN validation failed: {value}',
                extra={
                    'field': 'ssn',
                    'value': value[:6] + '******',  # ë¯¼ê° ì •ë³´ ë§ˆìŠ¤í‚¹
                    'error': str(e)
                }
            )
            raise

        return value
```

---

## ğŸ“š ê²€ì¦ ì²´í¬ë¦¬ìŠ¤íŠ¸

### API ê°œë°œ ì‹œ ì²´í¬ë¦¬ìŠ¤íŠ¸

#### Serializer ê²€ì¦
- [ ] í•„ìˆ˜ í•„ë“œì— `required=True` ì„¤ì •
- [ ] ë¬¸ìì—´ í•„ë“œì— `max_length` ì„¤ì •
- [ ] ìˆ«ì í•„ë“œì— `min_value`, `max_value` ì„¤ì •
- [ ] Choices í•„ë“œì— `choices` ì„¤ì •
- [ ] ì»¤ìŠ¤í…€ `error_messages` ì‘ì„±
- [ ] `validate_<field_name>()` ë©”ì„œë“œ êµ¬í˜„ (ë³µì¡í•œ ê²€ì¦)
- [ ] `validate()` ë©”ì„œë“œ êµ¬í˜„ (ê°ì²´ ìˆ˜ì¤€ ê²€ì¦)

#### Service Layer ê²€ì¦
- [ ] ë¦¬ì†ŒìŠ¤ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ (get_object_or_404)
- [ ] ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ ê²€ì¦ (í™˜ì ì§„ë£Œ ì¤‘, ì¬ê³  ë¶€ì¡± ë“±)
- [ ] ê¶Œí•œ í™•ì¸ (ìì‹ ì˜ ë°ì´í„°ì¸ì§€, ì—­í•  ì œí•œ ë“±)
- [ ] íŠ¸ëœì­ì…˜ ê´€ë¦¬ (`@transaction.atomic`)

#### ë°ì´í„° ë¬´ê²°ì„±
- [ ] ëª¨ë¸ì— `unique=True` ì„¤ì • (ì¤‘ë³µ ë°©ì§€)
- [ ] ì™¸ë˜ í‚¤ì— `on_delete=models.PROTECT` ì„¤ì •
- [ ] DB Constraint ì •ì˜ (CheckConstraint, UniqueConstraint)
- [ ] ë‚™ê´€ì  ë½ ì ìš© (`version` í•„ë“œ)

#### ì™¸ë¶€ ì‹œìŠ¤í…œ ì—°ë™
- [ ] HTTP ìƒíƒœ ì½”ë“œ ê²€ì¦
- [ ] ì‘ë‹µ ë°ì´í„° í˜•ì‹ ê²€ì¦ (JSON íŒŒì‹±)
- [ ] í•„ìˆ˜ í•„ë“œ ì¡´ì¬ ì—¬ë¶€ í™•ì¸
- [ ] íƒ€ì„ì•„ì›ƒ ì„¤ì •
- [ ] ì¬ì‹œë„ ë¡œì§ (í•„ìš”ì‹œ)

---

## ğŸ“š ì°¸ê³  ë¬¸ì„œ

- **[25_ì—ëŸ¬_í•¸ë“¤ë§_ê°€ì´ë“œ.md](25_ì—ëŸ¬_í•¸ë“¤ë§_ê°€ì´ë“œ.md)** - ì—ëŸ¬ ì‘ë‹µ í˜•ì‹
- **[21_ë½í‚¹_ë©±ë“±ì„±_ê°œë°œ_ê°€ì´ë“œ.md](21_ë½í‚¹_ë©±ë“±ì„±_ê°œë°œ_ê°€ì´ë“œ.md)** - ë™ì‹œì„± ì œì–´
- **[16_Write_Through_íŒ¨í„´_ê°€ì´ë“œ.md](16_Write_Through_íŒ¨í„´_ê°€ì´ë“œ.md)** - ì™¸ë¶€ ì‹œìŠ¤í…œ ì—°ë™
- **[REF_CLAUDE_CONTEXT.md](REF_CLAUDE_CONTEXT.md)** - ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

---

**ë¬¸ì„œ ë²„ì „**: 1.0
**ì‘ì„±ì¼**: 2025-12-28
**ëŒ€ìƒ ë…ì**: Backend ê°œë°œì
