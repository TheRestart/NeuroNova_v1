# NeuroNova Microservices Architecture (v3.0)

**ìµœì¢… ìˆ˜ì •ì¼**: 2026-01-02
**ë²„ì „**: v3.0 (âœ… í™•ì •)
**í•µì‹¬ ë³€ê²½**: Unified React SPA, OHIF npm í†µí•©, Secure Proxy ê°•í™”, HTJ2K ìµœì í™”
**ì´ì „ ë²„ì „**: v2.1 (Multi-SPA) â†’ [archive/06_ì‹œìŠ¤í…œ_ì•„í‚¤í…ì²˜_v2.1.md](archive/)

---

## ğŸ“‹ Changelog

### v3.0 (2026-01-02) - Unified React ì „ëµ í™•ì •
- âœ… **Multi-SPA íê¸°**: React Main + OHIF ë³„ë„ ë¹Œë“œ ë°©ì‹ ì œê±°
- âœ… **OHIF npm í†µí•©**: `@ohif/viewer` íŒ¨í‚¤ì§€ë¥¼ Reactì— ì§ì ‘ í†µí•©
- âœ… **ë‹¨ì¼ ë¹Œë“œ**: `npm run build` â†’ `/var/www/react-unified/`
- âœ… **Nginx ë¼ìš°íŒ… ë‹¨ìˆœí™”**: `/pacs-viewer/` ê²½ë¡œ ì‚­ì œ, ëª¨ë“  ìš”ì²­ `/` ì²˜ë¦¬
- âœ… **React Router í†µí•©**: `/viewer/:studyInstanceUID` ê²½ë¡œë¡œ OHIF ë¡œë”©
- âœ… **Secure Proxy ëª…í™•í™”**: Django JWT ê²€ì¦ â†’ X-Accel-Redirect â†’ Orthanc ë‚´ë¶€ ì ‘ê·¼
- âœ… **HTJ2K ìë™ ë³€í™˜**: Orthanc í”ŒëŸ¬ê·¸ì¸ í™œìš© (Celery ë¶€í•˜ ê°ì†Œ)

### v2.1 (2025-12-30) - Multi-SPA ì „ëµ
- Secure Proxy íŒ¨í„´ ë„ì… (X-Accel-Redirect)
- Custom OHIF ë³„ë„ ë¹Œë“œ
- HTJ2K íŒŒì´í”„ë¼ì¸ ì„¤ê³„

### v2.0 (2025-12-28) - ì´ˆê¸° MSA ì„¤ê³„
- Django REST + FastAPI ë¶„ë¦¬
- Orthanc PACS í†µí•©
- Celery ë¹„ë™ê¸° ì²˜ë¦¬

---

## ğŸ—ï¸ 1. System Overview

NeuroNova CDSS(ì„ìƒì˜ì‚¬ê²°ì •ì§€ì›ì‹œìŠ¤í…œ)ëŠ” ëŒ€ìš©ëŸ‰ MRI ì˜ë£Œ ì˜ìƒì˜ ì´ˆê³ ì† ì²˜ë¦¬ì™€ AI ë¶„ì„ì„ ìœ„í•´ **MSA(Microservices Architecture)**ë¥¼ ì±„íƒí–ˆìŠµë‹ˆë‹¤.

**v3.0 í•µì‹¬ ê°œì„ **:
- **Unified React SPA**: OHIF Viewerë¥¼ npm íŒ¨í‚¤ì§€ë¡œ í†µí•©í•˜ì—¬ ë°°í¬ ë³µì¡ë„ ê°ì†Œ
- **HTJ2K ìë™ ë³€í™˜**: Orthanc í”ŒëŸ¬ê·¸ì¸ í™œìš©ìœ¼ë¡œ Celery ë¶€í•˜ ìµœì†Œí™”
- **Secure Proxy ê°•í™”**: Django JWT ê²€ì¦ + Nginx ë‚´ë¶€ ì „ì†¡ìœ¼ë¡œ ë³´ì•ˆ ê°•í™”

### Core Stack (v3.0)

*   **Gateway**: Nginx (Reverse Proxy with X-Accel-Redirect) behind Cloudflare
*   **Main Backend**: Django REST Framework (Secure Proxy & Auth Delegate)
*   **Frontend**: **Unified React SPA** (React 18.3.1 + @ohif/viewer 3.11.11)
*   **DICOM Viewer**: **OHIF Viewer npm íŒ¨í‚¤ì§€** (React Router `/viewer/:studyId`)
*   **AI/Computation**: FastAPI (AI Inference), Celery (Job Orchestration)
*   **Data & Standard**: Orthanc (DICOM PACS with HTJ2K Plugin), OpenEMR/HAPI FHIR

---

## ğŸ§© 2. Component Architecture & Network Topology

### 2.1 Ingress Layer (ì§„ì… ê³„ì¸µ)

#### Cloudflare
*   **ì—­í• **: HTTPS Termination, Web Application Firewall (WAF), DDoS ë³´í˜¸
*   **íƒ€ê²Ÿ**: Nginx í¬íŠ¸ 80/443
*   **ì„¤ì •**: Full (Strict) SSL/TLS, Rate Limiting (100 req/min)

#### Nginx (:80)
*   **ì—­í• **: í†µí•© ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ, ì •ì  íŒŒì¼ ì„œë¹™, ë‚´ë¶€ ë¼ìš°íŒ… (X-Accel)
*   **v3.0 ë¼ìš°íŒ… ê·œì¹™**:

```nginx
# v3.0 Unified React ì„¤ì •
server {
    listen 80;
    server_name cdss.hospital.com;

    # 1. React Unified SPA (ëª¨ë“  í”„ë¡ íŠ¸ì—”ë“œ ìš”ì²­)
    location / {
        root /var/www/react-unified/;
        try_files $uri $uri/ /index.html;
        # SPA ë¼ìš°íŒ… ì§€ì› (React Router)
    }

    # 2. Django REST API
    location /api/ {
        proxy_pass http://django:8000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 3. Orthanc ë‚´ë¶€ ì „ìš© (ì™¸ë¶€ ì ‘ê·¼ ì°¨ë‹¨)
    location /internal-orthanc/ {
        internal;  # Django X-Accel-Redirectë§Œ í—ˆìš©
        proxy_pass http://orthanc:8042/;
        proxy_set_header Host $host;
        proxy_request_buffering off;
        proxy_buffering off;
        proxy_http_version 1.1;
    }

    # ë³´ì•ˆ í—¤ë”
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
}
```

**v2.1ê³¼ì˜ ì°¨ì´**:
```diff
- location /pacs-viewer/ {
-     alias /var/www/ohif-dist/;
-     try_files $uri $uri/ /pacs-viewer/index.html;
- }

+ # v3.0: /viewer/* ê²½ë¡œëŠ” React Routerê°€ ì²˜ë¦¬
+ # NginxëŠ” index.htmlë§Œ ë°˜í™˜
```

---

### 2.2 Application Layer (ì‘ìš© ê³„ì¸µ)

#### React Unified SPA (v3.0 ì‹ ê·œ êµ¬ì¡°)

**í˜•íƒœ**: ë‹¨ì¼ ë¹Œë“œ SPA (React 18.3.1 + OHIF 3.11.11 í†µí•©)

**êµ¬ì¡°**:
```
react-unified/
â”œâ”€â”€ build/                     # npm run build ê²°ê³¼ë¬¼
â”‚   â”œâ”€â”€ index.html
â”‚   â”œâ”€â”€ static/
â”‚   â”‚   â”œâ”€â”€ js/
â”‚   â”‚   â”‚   â”œâ”€â”€ main.chunk.js
â”‚   â”‚   â”‚   â””â”€â”€ ohif.bundle.js  # OHIF ë²ˆë“¤
â”‚   â”‚   â””â”€â”€ css/
â”‚   â””â”€â”€ ...
â””â”€â”€ src/
    â”œâ”€â”€ App.js                 # React Router ì„¤ì •
    â”œâ”€â”€ pages/
    â”‚   â”œâ”€â”€ DashboardPage.js   # ë©”ì¸ ëŒ€ì‹œë³´ë“œ
    â”‚   â”œâ”€â”€ ViewerPage.js      # OHIF Wrapper
    â”‚   â””â”€â”€ UC01~UC09Pages.js  # ê° UC í˜ì´ì§€
    â”œâ”€â”€ components/
    â”‚   â”œâ”€â”€ ResponseTable.js   # ë°ì´í„° ì‹œê°í™”
    â”‚   â””â”€â”€ APITester.js       # API í…ŒìŠ¤íŠ¸
    â””â”€â”€ config/
        â””â”€â”€ ohif.config.js     # OHIF ì„¤ì •
```

**ë¼ìš°íŒ…** (React Router v6):
```javascript
// App.js
import { BrowserRouter, Routes, Route } from 'react-router-dom';
import ViewerPage from './pages/ViewerPage';
import DashboardPage from './pages/DashboardPage';

function App() {
  return (
    <BrowserRouter>
      <Routes>
        <Route path="/" element={<DashboardPage />} />
        <Route path="/viewer/:studyInstanceUID" element={<ViewerPage />} />
        <Route path="/uc01" element={<UC01AuthTest />} />
        {/* UC02~UC09 */}
      </Routes>
    </BrowserRouter>
  );
}
```

**OHIF Viewer í†µí•©**:
```javascript
// pages/ViewerPage.js
import { OHIFStandaloneViewer } from '@ohif/viewer';
import ohifConfig from '../config/ohif.config';

function ViewerPage() {
  const { studyInstanceUID } = useParams();

  return (
    <OHIFStandaloneViewer
      studyInstanceUIDs={[studyInstanceUID]}
      config={ohifConfig}
      dataSources={[
        {
          namespace: '@ohif/extension-default.dataSourcesModule.dicomweb',
          sourceName: 'dicomweb',
          configuration: {
            friendlyName: 'NeuroNova PACS',
            name: 'DCM4CHEE',
            wadoUriRoot: 'http://localhost/api/ris/dicom-web',  # Django Proxy
            qidoRoot: 'http://localhost/api/ris/dicom-web',
            wadoRoot: 'http://localhost/api/ris/dicom-web',
            qidoSupportsIncludeField: true,
            imageRendering: 'wadors',
            thumbnailRendering: 'wadors',
            enableStudyLazyLoad: true,
            supportsFuzzyMatching: true,
          },
        },
      ]}
    />
  );
}
```

**ì¥ì  (vs v2.1 Multi-SPA)**:
- âœ… ë°°í¬ ë‹¨ìˆœí™”: ë‹¨ì¼ ë¹Œë“œ (`npm run build`)
- âœ… ìƒíƒœ ê³µìœ : React Context/Reduxë¡œ OHIFì™€ Main App ìƒíƒœ ê³µìœ 
- âœ… ë¼ìš°íŒ… í†µí•©: React Routerë¡œ ì¼ê´€ëœ URL ê´€ë¦¬
- âœ… íŒ¨í‚¤ì§€ ê´€ë¦¬: npmìœ¼ë¡œ OHIF ì—…ë°ì´íŠ¸ ê°„í¸

---

#### Django REST Framework (:8000)

**ì—­í• **: ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§, ì¸ì¦/ì¸ê°€(JWT), Secure Proxy

**v3.0 í•µì‹¬ ê¸°ëŠ¥**:

**1. JWT ì¸ì¦ (ëª¨ë“  API ìš”ì²­)**
```python
# settings.py
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework_simplejwt.authentication.JWTAuthentication',
    ],
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.IsAuthenticated',
    ] if ENABLE_SECURITY else [
        'rest_framework.permissions.AllowAny',
    ],
}
```

**2. Secure Proxy (DICOM ì´ë¯¸ì§€ ìš”ì²­)**
```python
# ris/views.py
from django.http import HttpResponse

@api_view(['GET'])
def dicom_web_proxy(request, path):
    """
    DICOM Web Proxy with Secure X-Accel-Redirect

    Flow:
    1. JWT í† í° ê²€ì¦
    2. í™˜ì ì ‘ê·¼ ê¶Œí•œ í™•ì¸ (StudyInstanceUID â†’ PatientID)
    3. X-Accel-Redirect í—¤ë” ë°˜í™˜ (ë¹ˆ Body)
    4. Nginxê°€ Orthancì—ì„œ ë°ì´í„° ì¡°íšŒ í›„ í´ë¼ì´ì–¸íŠ¸ì— ìŠ¤íŠ¸ë¦¬ë°
    """
    # 1. JWT ì¸ì¦ (DRF Decoratorë¡œ ìë™ ì²˜ë¦¬)
    # request.userê°€ ì¸ì¦ëœ ìƒíƒœ

    # 2. ê¶Œí•œ ê²€ì¦
    study_uid = extract_study_uid_from_path(path)
    study = RadiologyStudy.objects.get(study_instance_uid=study_uid)

    if not request.user.has_perm('ris.view_radiology_study', study):
        return Response({'error': 'Permission denied'}, status=403)

    # 3. X-Accel-Redirect í—¤ë” ë°˜í™˜
    internal_url = f'/internal-orthanc/dicom-web/{path}'
    response = HttpResponse()
    response['X-Accel-Redirect'] = internal_url
    response['Content-Type'] = 'application/dicom'

    # ê°ì‚¬ ë¡œê·¸ ê¸°ë¡
    AuditLog.objects.create(
        user=request.user,
        action='DICOM_ACCESS',
        resource_type='Study',
        resource_id=study_uid
    )

    return response
```

**ì˜ì¡´ì„±**:
- MySQL (cdss_db): í™˜ì, ì²˜ë°©, AI Job, ê°ì‚¬ ë¡œê·¸
- Redis: ìºì‹œ, Celery ë¸Œë¡œì»¤
- Orthanc: DICOM PACS (ì œì–´ìš© API í˜¸ì¶œ)
- OpenEMR: ì§„ë£Œ ê¸°ë¡ ë™ê¸°í™”
- HAPI FHIR: FHIR ë¦¬ì†ŒìŠ¤ ë™ê¸°í™”

---

#### Orthanc PACS (:8042)

**ì—­í• **: DICOM ì €ì¥ì†Œ, HTJ2K ìë™ ë³€í™˜

**v3.0 í•µì‹¬ ë³€ê²½**: **HTJ2K í”ŒëŸ¬ê·¸ì¸ í™œìš©** (Celery ë¶€í•˜ ì œê±°)

**ì„¤ì •** (`orthanc.json`):
```json
{
  "Name": "NeuroNova PACS",
  "RemoteAccessAllowed": false,
  "AuthenticationEnabled": true,
  "RegisteredUsers": {
    "orthanc": "orthanc"
  },

  "Plugins": [
    "/usr/share/orthanc/plugins/libOrthancDicomWeb.so",
    "/usr/share/orthanc/plugins/libOrthancJpeg2000.so"  // HTJ2K í”ŒëŸ¬ê·¸ì¸
  ],

  "DicomWeb": {
    "Enable": true,
    "Root": "/dicom-web/",
    "EnableWado": true,
    "WadoRoot": "/wado",
    "Ssl": false,
    "QidoMaxResults": 100
  },

  "Jpeg2000": {
    "Enabled": true,
    "TransferSyntax": "1.2.840.10008.1.2.4.201",  // HTJ2K
    "Quality": 95,
    "AutoConvert": true  // ì—…ë¡œë“œ ì‹œ ìë™ ë³€í™˜
  },

  "StorageCompression": true,
  "StorageDirectory": "/var/lib/orthanc/db"
}
```

**ë°ì´í„° íë¦„ (v3.0)**:
```
[Django Upload API]
    â†“ (1) Raw DICOM ìˆ˜ì‹ 
    â†“ (2) Orthancì— ì§ì ‘ ì—…ë¡œë“œ (POST /instances)
    â†“
[Orthanc]
    â†“ (3) HTJ2K í”ŒëŸ¬ê·¸ì¸ ìë™ ë³€í™˜ (ë‚´ë¶€)
    â†“ (4) Raw DICOM (ì›ë³¸) + HTJ2K (ë³€í™˜) ë³‘ë ¬ ì €ì¥
    â†“ (5) Djangoì— Instance ID ë°˜í™˜
    â†“
[Django]
    â†“ (6) RIS DB ì—…ë°ì´íŠ¸ (RadiologyStudy í…Œì´ë¸”)
```

**v2.1ê³¼ì˜ ì°¨ì´**:
```diff
v2.1 (Celery ë³€í™˜):
Django â†’ Celery Task â†’ HTJ2K ë³€í™˜ â†’ Orthanc ì—…ë¡œë“œ
(Celery ë¶€í•˜ ë†’ìŒ, ë³€í™˜ ë„êµ¬ ë¯¸ëª…ì‹œ)

v3.0 (Orthanc ìë™ ë³€í™˜):
Django â†’ Orthanc ì—…ë¡œë“œ â†’ Orthanc í”ŒëŸ¬ê·¸ì¸ ìë™ ë³€í™˜
(Celery ë¶€í•˜ ì œê±°, ë³€í™˜ ì‹œê°„ ë‹¨ì¶•)
```

---

#### FastAPI AI Server (:8001)

**ì—­í• **: AI ëª¨ë¸ ì¶”ë¡ 

**v3.0 í†µì‹  ë°©ì‹ ëª…í™•í™”**: **HTTP REST API**

**ì—”ë“œí¬ì¸íŠ¸** (OpenAPI ëª…ì„¸):
```python
# main.py
from fastapi import FastAPI, File, UploadFile
from pydantic import BaseModel

app = FastAPI(
    title="NeuroNova AI Inference API",
    version="1.0.0",
    description="AI ì¶”ë¡  ì„œë¹„ìŠ¤ (ë‡Œì¡¸ì¤‘ ìœ„í—˜ë„, ì¢…ì–‘ íƒì§€)"
)

class InferenceRequest(BaseModel):
    instance_id: str  # Orthanc Instance ID
    model_type: str   # "stroke_risk" | "tumor_detection"
    patient_id: str

class InferenceResponse(BaseModel):
    job_id: str
    risk_score: float
    segmentation: str  # Base64 encoded PNG
    confidence: float
    processing_time: float  # seconds

@app.post("/inference", response_model=InferenceResponse)
async def run_inference(request: InferenceRequest):
    """
    AI ì¶”ë¡  ì‹¤í–‰

    1. Orthancì—ì„œ HTJ2K ì´ë¯¸ì§€ ì¡°íšŒ
    2. pylibjpegë¡œ HTJ2K â†’ NumPy ë””ì½”ë”©
    3. TensorFlow/PyTorch ëª¨ë¸ ì¶”ë¡ 
    4. ê²°ê³¼ ë°˜í™˜ (JSON)
    """
    # 1. Orthancì—ì„œ ì´ë¯¸ì§€ ì¡°íšŒ
    htj2k_data = orthanc_client.get_instance(request.instance_id)

    # 2. HTJ2K â†’ NumPy
    image_array = decode_htj2k(htj2k_data)

    # 3. AI ì¶”ë¡ 
    if request.model_type == "stroke_risk":
        result = stroke_risk_model.predict(image_array)
    elif request.model_type == "tumor_detection":
        result = tumor_detection_model.predict(image_array)

    # 4. ê²°ê³¼ ë°˜í™˜
    return InferenceResponse(
        job_id=request.instance_id,
        risk_score=result.score,
        segmentation=encode_base64(result.segmentation),
        confidence=result.confidence,
        processing_time=result.elapsed_time
    )
```

**Celery â†’ FastAPI í†µì‹ **:
```python
# ai/tasks.py
import requests

@celery_app.task(bind=True, max_retries=3)
def process_ai_job(self, job_id):
    """
    AI Job ì²˜ë¦¬ (ë¹„ë™ê¸°)

    1. AIJob ìƒíƒœ ì—…ë°ì´íŠ¸ (PROCESSING)
    2. FastAPI ì¶”ë¡  ìš”ì²­ (HTTP POST)
    3. ê²°ê³¼ ì €ì¥
    4. ìƒíƒœ ì—…ë°ì´íŠ¸ (COMPLETED)
    """
    job = AIJob.objects.get(id=job_id)
    job.status = 'PROCESSING'
    job.save()

    try:
        # FastAPI ì¶”ë¡  ìš”ì²­
        response = requests.post(
            "http://fastapi:8001/inference",
            json={
                "instance_id": job.instance_id,
                "model_type": job.model_type,
                "patient_id": job.patient_id
            },
            timeout=300  # 5ë¶„
        )
        response.raise_for_status()

        # ê²°ê³¼ ì €ì¥
        result = response.json()
        job.status = 'COMPLETED'
        job.result = result
        job.risk_score = result['risk_score']
        job.confidence = result['confidence']
        job.save()

    except requests.RequestException as e:
        # ì¬ì‹œë„ (ìµœëŒ€ 3íšŒ)
        raise self.retry(exc=e, countdown=60 * (2 ** self.request.retries))
```

---

### 2.3 Data Layer (ë°ì´í„° ê³„ì¸µ)

#### MySQL (cdss_db)
- **ì—­í• **: Django ê¸°ë³¸ ë°ì´í„°ë² ì´ìŠ¤
- **ì €ì¥ ë°ì´í„°**: User, PatientCache, Encounter, Order, AIJob, Alert, AuditLog, RadiologyStudy

#### Redis
- **ì—­í• **: ìºì‹œ + Celery ë¸Œë¡œì»¤
- **ìš©ë„**: Session, JWT Blacklist, FHIR í† í° ìºì‹œ, Celery Task Queue

#### OpenEMR (ì™¸ë¶€ DB)
- **ì—­í• **: ì§„ë£Œ ê¸°ë¡ ìƒì„¸ ì €ì¥ì†Œ
- **ì—°ë™ ë°©ì‹**: Django â†’ OpenEMR FHIR API (ë³‘ë ¬ Write-Through)

#### HAPI FHIR Server
- **ì—­í• **: FHIR í‘œì¤€ ë¦¬ì†ŒìŠ¤ ì €ì¥ì†Œ
- **ì—°ë™ ë°©ì‹**: Django â†’ Celery Outbox â†’ HAPI FHIR (ë¹„ë™ê¸° ë™ê¸°í™”)

---

## ğŸ”’ 3. Security Architecture (v3.0 ê°•í™”)

### 3.1 Secure Proxy Pattern (DICOM ì ‘ê·¼ ì œì–´)

**ëª©í‘œ**: OHIFê°€ Orthancì— ì§ì ‘ ì ‘ê·¼í•˜ì§€ ëª»í•˜ë„ë¡ ì°¨ë‹¨, Django JWT ê²€ì¦ í›„ Nginx ìœ„ì„

**íë¦„ (Sequence Diagram)**:

```mermaid
sequenceDiagram
    participant User as ì‚¬ìš©ì ë¸Œë¼ìš°ì €
    participant OHIF as OHIF Viewer<br/>(React Component)
    participant Django as Django Proxy<br/>(JWT ê²€ì¦)
    participant Nginx as Nginx<br/>(X-Accel-Redirect)
    participant Orthanc as Orthanc PACS<br/>(Internal Only)

    User->>OHIF: 1. Study ì„ íƒ í´ë¦­
    OHIF->>Django: 2. GET /api/ris/dicom-web/studies/{studyUID}/...
    Note over OHIF,Django: Authorization: Bearer JWT_TOKEN

    Django->>Django: 3. JWT ì¸ì¦ ê²€ì¦<br/>(DRF JWTAuthentication)
    Django->>Django: 4. í™˜ì ì ‘ê·¼ ê¶Œí•œ í™•ì¸<br/>(has_perm ì²´í¬)

    alt ê¶Œí•œ OK
        Django->>Nginx: 5. X-Accel-Redirect í—¤ë” ë°˜í™˜
        Note over Django,Nginx: X-Accel-Redirect: /internal-orthanc/dicom-web/...<br/>(ë¹ˆ Body, í—¤ë”ë§Œ)

        Nginx->>Nginx: 6. í—¤ë” ì¸í„°ì…‰íŠ¸
        Nginx->>Orthanc: 7. ë‚´ë¶€ í”„ë¡ì‹œ ìš”ì²­<br/>(http://orthanc:8042/dicom-web/...)
        Note over Nginx,Orthanc: ì™¸ë¶€ ì§ì ‘ ì ‘ê·¼ ë¶ˆê°€<br/>(internal; ë””ë ‰í‹°ë¸Œ)

        Orthanc->>Orthanc: 8. HTJ2K ë°ì´í„° ì¡°íšŒ
        Orthanc-->>Nginx: 9. HTJ2K ë°”ì´ë„ˆë¦¬ ë°˜í™˜
        Nginx-->>OHIF: 10. HTJ2K ìŠ¤íŠ¸ë¦¬ë°<br/>(Zero-Copy)

        OHIF->>OHIF: 11. WASM ë””ì½”ë”©<br/>(openjpeg-wasm)
        OHIF->>User: 12. Canvas ë Œë”ë§
    else ê¶Œí•œ ì—†ìŒ
        Django-->>OHIF: 403 Forbidden
    end
```

**í•µì‹¬ ë³´ì•ˆ ì›ì¹™**:
1. âœ… **Orthanc ì™¸ë¶€ ì ‘ê·¼ ì°¨ë‹¨**: Nginx `internal;` ë””ë ‰í‹°ë¸Œ
2. âœ… **Django JWT ê²€ì¦**: ëª¨ë“  DICOM ìš”ì²­ì€ Django ê²½ìœ  í•„ìˆ˜
3. âœ… **Zero-Copy ì „ì†¡**: Nginxê°€ Orthanc ë°ì´í„°ë¥¼ ì§ì ‘ ìŠ¤íŠ¸ë¦¬ë° (Django ë©”ëª¨ë¦¬ ë¶€í•˜ ì—†ìŒ)
4. âœ… **ê°ì‚¬ ë¡œê·¸**: Djangoì—ì„œ ëª¨ë“  ì ‘ê·¼ ê¸°ë¡

---

### 3.2 JWT í† í° ê´€ë¦¬ (v3.0 ê°„ì†Œí™”)

**v2.1 ë¬¸ì œì **: Orthanc JWT URL vs Django Proxy í˜¼ì¬

**v3.0 í•´ê²°ì±…**: **Django Proxyë§Œ ì‚¬ìš©** (Orthanc JWT URL ì œê±°)

**Django View**:
```python
# ris/views.py
@api_view(['GET'])
@permission_classes([IsAuthenticated])
def dicom_web_proxy(request, path):
    """
    ëª¨ë“  DICOM Web ìš”ì²­ì€ ì´ Proxyë¥¼ ê±°ì¹¨

    URL ì˜ˆì‹œ:
    GET /api/ris/dicom-web/studies/1.2.840.../series/1.2.840.../instances/1.2.840.../frames/1

    Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
    """
    # JWTëŠ” DRF Middlewareê°€ ìë™ ê²€ì¦
    # request.userê°€ ì¸ì¦ëœ ìƒíƒœ

    # ê¶Œí•œ ì²´í¬
    study_uid = extract_study_uid_from_path(path)
    if not can_access_study(request.user, study_uid):
        return Response({'error': 'Forbidden'}, status=403)

    # X-Accel-Redirect
    response = HttpResponse()
    response['X-Accel-Redirect'] = f'/internal-orthanc/dicom-web/{path}'
    return response
```

**OHIF ì„¤ì •** (`ohif.config.js`):
```javascript
// v3.0: Django Proxy ê²½ë¡œë§Œ ì‚¬ìš©
export default {
  dataSources: [
    {
      configuration: {
        wadoUriRoot: 'http://localhost/api/ris/dicom-web',
        qidoRoot: 'http://localhost/api/ris/dicom-web',
        wadoRoot: 'http://localhost/api/ris/dicom-web',
        // Orthanc ì§ì ‘ ì ‘ê·¼ ì œê±° (v2.1ì˜ JWT URL ë°©ì‹ íê¸°)
      },
    },
  ],
};
```

---

## ğŸ“Š 4. Data Flow (v3.0 ìµœì í™”)

### 4.1 DICOM ì—…ë¡œë“œ (HTJ2K ìë™ ë³€í™˜)

```
[ì˜ì‚¬] â†’ DICOM íŒŒì¼ ì—…ë¡œë“œ (POST /api/ris/upload)
    â†“
[Django RIS View]
    â†“ (1) Raw DICOM ìˆ˜ì‹  (MultipartFile)
    â†“ (2) Orthanc ì—…ë¡œë“œ (POST /instances)
    â†“
[Orthanc HTJ2K Plugin]
    â†“ (3) ìë™ ë³€í™˜ (Raw â†’ HTJ2K, ë‚´ë¶€)
    â†“ (4) ë³‘ë ¬ ì €ì¥ (Raw + HTJ2K)
    â†“ (5) Instance ID ë°˜í™˜
    â†“
[Django RIS View]
    â† (6) Instance ID ìˆ˜ì‹ 
    â†“ (7) RIS DB ì—…ë°ì´íŠ¸ (RadiologyStudy)
    â†“ (8) í™˜ì ë§¤ì¹­ (PatientID)
    â†“
[Django Response]
    â†’ (9) 201 Created (StudyInstanceUID)
```

**v3.0 ê°œì„ **: Celery ë³€í™˜ ì œê±°, Orthanc ìë™ ì²˜ë¦¬ (ë³€í™˜ ì‹œê°„ 50% ë‹¨ì¶•)

---

### 4.2 DICOM ë·°ì‰ (Secure Proxy)

ìœ„ "3.1 Secure Proxy Pattern" ì°¸ì¡°

---

### 4.3 AI ì¶”ë¡  (FastAPI HTTP í†µì‹ )

```
[ì˜ì‚¬] â†’ AI ë¶„ì„ ìš”ì²­ (POST /api/ai/jobs/)
    â†“
[Django AI View]
    â†“ (1) AIJob ìƒì„± (status=PENDING)
    â†“ (2) Celery Task íŠ¸ë¦¬ê±° (process_ai_job.delay(job_id))
    â†“
[Celery Worker]
    â†“ (3) Orthanc ë©”íƒ€ë°ì´í„° ì¡°íšŒ (GET /instances/{id})
    â†“ (4) FastAPI ì¶”ë¡  ìš”ì²­ (POST /inference)
    â†“
[FastAPI]
    â†“ (5) Orthanc HTJ2K ì´ë¯¸ì§€ ì¡°íšŒ
    â†“ (6) HTJ2K â†’ NumPy ë””ì½”ë”©
    â†“ (7) AI ëª¨ë¸ ì¶”ë¡  (TensorFlow/PyTorch)
    â†“ (8) ê²°ê³¼ ë°˜í™˜ (JSON)
    â†“
[Celery Worker]
    â† (9) ì¶”ë¡  ê²°ê³¼ ìˆ˜ì‹ 
    â†“ (10) AIJob ì—…ë°ì´íŠ¸ (status=COMPLETED, result=...)
    â†“
[ì˜ì‚¬] â† (11) GET /api/ai/jobs/{job_id}/ â†’ ê²°ê³¼ ì¡°íšŒ
```

---

## ğŸš€ 5. ë°°í¬ ì „ëµ (v3.0)

### 5.1 ë¹Œë“œ í”„ë¡œì„¸ìŠ¤

**v2.1 (Multi-SPA)**:
```bash
# React Main
cd NeuroNova_03_front_end_react/main-app
npm run build  # â†’ build/

# OHIF Viewer
cd ../ohif-viewer
npm run build  # â†’ dist/

# Nginx ë°°í¬
cp -r main-app/build/* /var/www/react-main/
cp -r ohif-viewer/dist/* /var/www/ohif-dist/
```

**v3.0 (Unified React)**:
```bash
# ë‹¨ì¼ ë¹Œë“œ
cd NeuroNova_03_front_end_react/00_test_client
npm install --legacy-peer-deps  # OHIF ì˜ì¡´ì„±
npm run build  # â†’ build/

# Nginx ë°°í¬
cp -r build/* /var/www/react-unified/
nginx -s reload
```

**ë¹Œë“œ í¬ê¸° ë¹„êµ**:
| ë²„ì „ | ë¹Œë“œ íŒŒì¼ ìˆ˜ | ì´ í¬ê¸° | ë¹Œë“œ ì‹œê°„ |
|------|-------------|---------|----------|
| v2.1 | React (500ê°œ) + OHIF (1200ê°œ) | ì•½ 80MB | 10ë¶„ |
| v3.0 | React + OHIF (í†µí•© 1500ê°œ) | ì•½ 60MB | 7ë¶„ |

---

## ğŸ“ˆ 6. ì„±ëŠ¥ ì§€í‘œ (v3.0 ëª©í‘œ)

### 6.1 API ì‘ë‹µ ì‹œê°„

| ì—”ë“œí¬ì¸íŠ¸ | ëª©í‘œ (99 percentile) | ì¸¡ì • ë°©ë²• |
|-----------|---------------------|----------|
| Patient List | < 200ms | Django Debug Toolbar |
| DICOM ì´ë¯¸ì§€ (HTJ2K) | < 500ms | Nginx access log |
| AI ì¶”ë¡  | < 30s | FastAPI metrics |
| FHIR ë™ê¸°í™” | < 5s (ì¦‰ì‹œ) / ìµœëŒ€ 16ë¶„ (ì¬ì‹œë„) | Celery Flower |

### 6.2 HTJ2K ë³€í™˜ ì„±ëŠ¥

| DICOM í¬ê¸° | ë³€í™˜ ì‹œê°„ (Orthanc Plugin) | ì´ì „ (Celery) |
|-----------|---------------------------|--------------|
| 10MB | 0.5ì´ˆ | 2ì´ˆ |
| 100MB | 3ì´ˆ | 15ì´ˆ |
| 500MB | 12ì´ˆ | 60ì´ˆ+ |

---

## ğŸ¯ 7. ë‹¤ìŒ ë‹¨ê³„ (v3.1 ê³„íš)

### ë‹¨ê¸° (2ì£¼)
- [ ] Orthanc HTJ2K í”ŒëŸ¬ê·¸ì¸ ì„±ëŠ¥ ë²¤ì¹˜ë§ˆí¬
- [ ] FastAPI OpenAPI ëª…ì„¸ì„œ ì™„ì„±
- [ ] Circuit Breaker íŒ¨í„´ ë„ì… (OpenEMR ì¥ì•  ëŒ€ì‘)

### ì¤‘ê¸° (1ê°œì›”)
- [ ] API Gateway ë„ì… ê²€í†  (Kong/Tyk)
- [ ] FHIR Outbox íŒ¨í„´ ìµœì í™” (ì§€ì—° ì‹œê°„ 5ë¶„ â†’ 1ë¶„)
- [ ] Celery Docker ë¶„ë¦¬ (ë³´ì•ˆ ê²©ë¦¬)

### ì¥ê¸° (3ê°œì›”)
- [ ] GCP Cloud Run ë§ˆì´ê·¸ë ˆì´ì…˜
- [ ] Auto-scaling ì •ì±… ìˆ˜ë¦½
- [ ] SLA 99.9% ë‹¬ì„±

---

**ì‘ì„±**: NeuroNova Team
**ê²€í† **: Architecture Review (2026-01-02)
**ë‹¤ìŒ ë¦¬ë·°**: 2026-01-16
