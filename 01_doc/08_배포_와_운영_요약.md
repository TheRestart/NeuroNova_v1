# ë°°í¬ ë° ìš´ì˜ ìš”ì•½ (Deployment & Operations v2.1)

**ìµœì¢… ìˆ˜ì •ì¼**: 2025-12-30
**ë²„ì „**: v2.1
**í™˜ê²½**: GCP VM, Docker Compose, Nginx (Secure Gateway), Cloudflare (HTTPS)
**í•µì‹¬ ë³€ê²½**: X-Accel-Redirect, Multi-SPA Build Strategy, Internal Routing

---

## ğŸš€ 1. ë°°í¬ í™˜ê²½ ì•„í‚¤í…ì²˜ (Secure Gateway-Centric)

ëª¨ë“  ì™¸ë¶€ ì ‘ê·¼ì€ **Cloudflare**ì™€ **Nginx**ë¥¼ í†µí•´ì„œë§Œ ì´ë£¨ì–´ì§€ë©°, ë°±ì—”ë“œ ì„œë¹„ìŠ¤(Django, Redis, MySQL, Orthanc ë“±)ëŠ” ì™¸ë¶€ì—ì„œ ê²©ë¦¬ëœ **Docker Network** ë‚´ë¶€ì—ì„œë§Œ í†µì‹ í•©ë‹ˆë‹¤.

### 1.1 ì ‘ì† ë„ì‹ (v2.1 Updated)
```
Internet (User)
   â†“ (HTTPS: 443)
Cloudflare (WAF/DDoS)
   â†“ (Port: 80)
[ GCP VM Instance ]
   â†“
[ Nginx Gateway (v2.1: Secure Proxy) ]
   â”œâ”€ /                â†’ React Main App (Static Build, /var/www/react-main)
   â”œâ”€ /pacs-viewer/    â†’ Custom OHIF Viewer (Static Build, /var/www/ohif-dist)
   â”œâ”€ /api/            â†’ Django API Container (:8000)
   â””â”€ /internal-orthanc/* â†’ Orthanc (:8042, **Internal Only**, X-Accel-Redirect)
         â†“
   [ Docker Network (Internal) ]
   Django â†” MySQL, Redis, Orthanc (HTJ2K), Celery, HAPI FHIR
```

**í•µì‹¬ ë³€ê²½ (v2.1)**:
- `/internal-orthanc/*`: ì™¸ë¶€ ì§ì ‘ ì ‘ì† ì°¨ë‹¨, Django JWT ê²€ì¦ í›„ Nginxê°€ ë‚´ë¶€ì ìœ¼ë¡œ ì ‘ê·¼
- Multi-SPA: React Mainê³¼ OHIF Viewerë¥¼ ë³„ë„ë¡œ ë¹Œë“œí•˜ì—¬ ë…ë¦½ì ìœ¼ë¡œ ë°°í¬

---

## ğŸ› ï¸ 2. ë°°í¬ í•µì‹¬ ë‹¨ê³„ (Deployment Steps)

### 2.1 ì‚¬ì „ ì¤€ë¹„ (GCP VM)
1.  **OS**: Ubuntu 22.04 LTS (ìµœì†Œ n2-standard-4 ê¶Œì¥).
2.  **ë„êµ¬ ì„¤ì¹˜**: Docker, Docker Compose, Git.
3.  **ë°©í™”ë²½**: GCP Firewallì—ì„œ `80`, `443`, `22` í¬íŠ¸ ê°œë°©.

### 2.2 Docker ì»¨í…Œì´ë„ˆ ë°°í¬ (Backend + Data)
1.  `docker-compose.yml`ì´ ìœ„ì¹˜í•œ ë°±ì—”ë“œ ë””ë ‰í† ë¦¬ë¡œ ì´ë™.
2.  `.env` íŒŒì¼ ìƒì„± (í•„ìˆ˜ ë³€ìˆ˜: `DJANGO_SECRET_KEY`, `DB_PASSWORD` ë“± ë³´ì•ˆ ì„¤ì •).
3.  ì„œë¹„ìŠ¤ ì‹¤í–‰:
    ```bash
    docker compose up -d --build
    ```
4.  Django ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰:
    ```bash
    docker compose exec django python manage.py migrate
    ```

### 2.3 í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ (Multi-SPA Strategy v2.1)

NeuroNova v2.1ì€ **Nginxê°€ ì •ì  íŒŒì¼ì„ ì§ì ‘ ì„œë¹™**í•˜ëŠ” êµ¬ì¡°ì´ë©°, React Mainê³¼ OHIF Viewerë¥¼ **ë³„ë„ë¡œ ë¹Œë“œ**í•©ë‹ˆë‹¤.

#### 2.3.1 React Main App ë¹Œë“œ
```bash
cd NeuroNova_03_front_end_react/00_test_client
npm install
npm run build
# ê²°ê³¼ë¬¼: build/ í´ë”
```

#### 2.3.2 Custom OHIF Viewer ë¹Œë“œ
```bash
cd NeuroNova_02_back_end/04_ohif_viewer
yarn install
yarn run build
# ê²°ê³¼ë¬¼: dist/ í´ë” (WASM í¬í•¨, HTJ2K ë””ì½”ë” í¬í•¨)
```

#### 2.3.3 ì •ì  íŒŒì¼ ë°°í¬
```bash
# React Main App
sudo cp -r build/* /var/www/react-main/

# OHIF Viewer
sudo cp -r dist/* /var/www/ohif-dist/

# ê¶Œí•œ ì„¤ì •
sudo chown -R www-data:www-data /var/www/react-main
sudo chown -R www-data:www-data /var/www/ohif-dist
```

### 2.4 Nginx ì„¤ì • (v2.1 Secure Proxy)

```nginx
server {
    listen 80;
    server_name yourdomain.com;

    # React Main App
    location / {
        root /var/www/react-main;
        try_files $uri $uri/ /index.html;
    }

    # OHIF Viewer
    location /pacs-viewer/ {
        alias /var/www/ohif-dist/;
        try_files $uri $uri/ /pacs-viewer/index.html;
    }

    # Django API
    location /api/ {
        proxy_pass http://django:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Orthanc Internal Route (X-Accel-Redirect)
    location /internal-orthanc/ {
        internal;
        proxy_pass http://orthanc:8042/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

**í•µì‹¬ í¬ì¸íŠ¸**:
- `internal;`: `/internal-orthanc/`ëŠ” ì™¸ë¶€ì—ì„œ ì§ì ‘ ì ‘ê·¼ ë¶ˆê°€, Djangoì˜ `X-Accel-Redirect` í—¤ë”ë¥¼ í†µí•´ì„œë§Œ ì ‘ê·¼.
- Djangoê°€ JWT ê²€ì¦ í›„ `X-Accel-Redirect: /internal-orthanc/studies/...` í—¤ë” ë°˜í™˜ â†’ Nginxê°€ Orthancì— ìš”ì²­.

---

## ğŸ›¡ï¸ 3. ìš´ì˜ ë° ë³´ì•ˆ ê´€ë¦¬ (Operations)

### 3.1 í™˜ê²½ ë³€ìˆ˜ ê´€ë¦¬
- **ë³´ì•ˆ ì›ì¹™**: `.env` íŒŒì¼ì€ ì ˆëŒ€ Gitì— ì»¤ë°‹í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
- **ìš´ì˜ íŒ**: í”„ë¡œë•ì…˜ ì„œë²„ì—ëŠ” `.env.example`ì„ ë³µì‚¬í•œ ë’¤, ì‹¤ì œ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì§ì ‘ ì…ë ¥í•˜ì—¬ ì‚¬ìš©í•©ë‹ˆë‹¤.

### 3.2 ë³´ì•ˆ ê°•í™” (v2.1)

#### 3.2.1 Network Segmentation
- **ì™¸ë¶€ ë…¸ì¶œ**: Nginxë§Œ (í¬íŠ¸ 80, 443)
- **ë‚´ë¶€ ì „ìš©**: MySQL, Redis, Orthanc, HAPI FHIR, OpenEMR
  ```yaml
  # docker-compose.yml ì˜ˆì‹œ
  mysql:
    ports:
      - "127.0.0.1:3306:3306"  # localhost ë°”ì¸ë”©

  orthanc:
    expose:
      - "8042"  # ì™¸ë¶€ í¬íŠ¸ ì°¨ë‹¨, Docker ë„¤íŠ¸ì›Œí¬ ë‚´ë¶€ë§Œ
  ```

#### 3.2.2 Secure Proxy Pattern
- OHIFê°€ DICOM ì´ë¯¸ì§€ ìš”ì²­ ì‹œ:
  1. OHIF â†’ Django (`/api/pacs/dicom-web/studies/...`)
  2. Django JWT ê²€ì¦ â†’ `X-Accel-Redirect: /internal-orthanc/studies/...` ë°˜í™˜
  3. Nginx â†’ Orthanc (ë‚´ë¶€) â†’ í´ë¼ì´ì–¸íŠ¸ì— ìŠ¤íŠ¸ë¦¬ë°

### 3.3 ë¡œê·¸ ë° ëª¨ë‹ˆí„°ë§
- **ë¡œê·¸ í™•ì¸**: `docker compose logs -f [service_name]` (ì˜ˆ: `django`, `celery`)
- **ì£¼ìš” ëª¨ë‹ˆí„°ë§ í¬ì¸íŠ¸**:
  - **Celery**: ì´ë¯¸ì§€ ë³€í™˜ í ì²˜ë¦¬ê°€ ì§€ì—°ë˜ì§€ ì•ŠëŠ”ì§€ í™•ì¸ (HTJ2K ë³€í™˜).
  - **Orthanc**: ë””ìŠ¤í¬ ìš©ëŸ‰ (ì´ë¯¸ì§€ ì €ì¥ ê³µê°„) ì£¼ê¸°ì  ì²´í¬.
  - **Django**: JWT ê²€ì¦ ì‹¤íŒ¨ ë¡œê·¸ í™•ì¸ (ë³´ì•ˆ ì´ë²¤íŠ¸).

### 3.4 ë°±ì—… ì „ëµ
- **MySQL**: ë§¤ì¼ ìƒˆë²½ `mysqldump`ë¥¼ í†µí•´ ë°ì´í„° ë°±ì—… ë° GCS(Google Cloud Storage) ì „ì†¡.
- **Orthanc**: `/var/lib/orthanc/db` ë³¼ë¥¨ ì „ì²´ë¥¼ ìŠ¤ëƒ…ìƒ· ë°±ì—….

---

## âš ï¸ 4. ì£¼ìš” íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### 4.1 OHIFê°€ ì´ë¯¸ì§€ë¥¼ ëª» ë¶ˆëŸ¬ì˜¬ ë•Œ
1.  **Django Proxy í™•ì¸**:
    - OHIFê°€ `/api/pacs/dicom-web/...`ë¡œ ìš”ì²­í•˜ëŠ”ì§€ í™•ì¸.
    - Djangoì—ì„œ `X-Accel-Redirect` í—¤ë”ë¥¼ ë°˜í™˜í•˜ëŠ”ì§€ í™•ì¸.
    ```python
    # Django views.py ì˜ˆì‹œ
    response = HttpResponse(status=200)
    response['X-Accel-Redirect'] = f'/internal-orthanc/studies/{study_id}'
    return response
    ```

2.  **Nginx ì„¤ì • í™•ì¸**:
    - `/internal-orthanc/` ë¼ìš°íŠ¸ê°€ `internal;` ë””ë ‰í‹°ë¸Œë¥¼ í¬í•¨í•˜ëŠ”ì§€ í™•ì¸.
    - Orthanc ì»¨í…Œì´ë„ˆê°€ Docker ë„¤íŠ¸ì›Œí¬ì—ì„œ ì ‘ê·¼ ê°€ëŠ¥í•œì§€ í™•ì¸ (`ping orthanc`).

3.  **ë¸Œë¼ìš°ì € ì½˜ì†” ì²´í¬**:
    - CORS ì—ëŸ¬ê°€ ëœ¨ëŠ”ì§€ í™•ì¸.
    - JWT í† í°ì´ ë§Œë£Œë˜ì§€ ì•Šì•˜ëŠ”ì§€ í™•ì¸.

### 4.2 Celery ì‘ì—… ì•ˆ ë¨
1.  Redis ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì—¬ë¶€ í™•ì¸:
    ```bash
    docker ps | grep redis
    ```
2.  Celery Worker ë¡œê·¸ í™•ì¸:
    ```bash
    docker compose logs celery-worker
    ```
3.  HTJ2K ë³€í™˜ ì‘ì—…ì´ íì— ìŒ“ì—¬ ìˆëŠ”ì§€ í™•ì¸ (Flower ëª¨ë‹ˆí„°ë§).

### 4.3 ë°°í¬ í›„ 502 Bad Gateway
1.  Django ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ë–´ëŠ”ì§€ í™•ì¸:
    ```bash
    docker ps
    ```
2.  Djangoê°€ 8000ë²ˆ í¬íŠ¸ë¡œ ë¦¬ìŠ¤ë‹ ì¤‘ì¸ì§€ í™•ì¸:
    ```bash
    docker compose exec django netstat -tuln | grep 8000
    ```
3.  Nginx ì—ëŸ¬ ë¡œê·¸ í™•ì¸:
    ```bash
    sudo tail -f /var/log/nginx/error.log
    ```

### 4.4 Multi-SPA ë¹Œë“œ ì´ìŠˆ
1.  **React Mainê³¼ OHIF Viewerì˜ ë¹Œë“œ ì¶œë ¥ ê²½ë¡œ í™•ì¸**:
    - React: `build/`
    - OHIF: `dist/`
2.  **Nginx alias ê²½ë¡œ í™•ì¸**:
    - React: `/var/www/react-main`
    - OHIF: `/var/www/ohif-dist`
3.  **ì˜ì¡´ì„± ì¶©ëŒ**:
    - ë‘ í”„ë¡œì íŠ¸ê°€ ì„œë¡œ ë‹¤ë¥¸ React ë²„ì „ì´ë‚˜ íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ë³„ë„ `node_modules` ê´€ë¦¬.

---

## ğŸ”„ 5. CI/CD íŒŒì´í”„ë¼ì¸ (ì„ íƒì‚¬í•­)

### 5.1 GitHub Actions ì˜ˆì‹œ
```yaml
name: Deploy to GCP

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Build React Main
        run: |
          cd NeuroNova_03_front_end_react/00_test_client
          npm install
          npm run build

      - name: Build OHIF Viewer
        run: |
          cd NeuroNova_02_back_end/04_ohif_viewer
          yarn install
          yarn run build

      - name: Deploy to GCP VM
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.GCP_HOST }}
          username: ${{ secrets.GCP_USERNAME }}
          key: ${{ secrets.GCP_SSH_KEY }}
          source: "build/,dist/"
          target: "/var/www/"

      - name: Restart Services
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.GCP_HOST }}
          username: ${{ secrets.GCP_USERNAME }}
          key: ${{ secrets.GCP_SSH_KEY }}
          script: |
            cd /opt/NeuroNova_v1/NeuroNova_02_back_end
            docker compose restart django celery-worker
            sudo systemctl reload nginx
```

---

## ğŸ“š 6. ê´€ë ¨ ë¬¸ì„œ

*   **ìƒì„¸ ë°°í¬ ê°€ì´ë“œ**: [12_GCP_ë°°í¬_ê°€ì´ë“œ.md](12_GCP_ë°°í¬_ê°€ì´ë“œ.md)
*   **ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜**: [06_ì‹œìŠ¤í…œ_ì•„í‚¤í…ì²˜_v2.md](06_ì‹œìŠ¤í…œ_ì•„í‚¤í…ì²˜_v2.md)
*   **ì„œë¹„ìŠ¤ êµ¬ì¡°**: [07_ì„œë¹„ìŠ¤_êµ¬ì¡°_ìš”ì•½.md](07_ì„œë¹„ìŠ¤_êµ¬ì¡°_ìš”ì•½.md)
*   **ë³´ì•ˆ ì •ì±…**: [12_ë³´ì•ˆ_ì•„í‚¤í…ì²˜_ì •ì±….md](12_ë³´ì•ˆ_ì•„í‚¤í…ì²˜_ì •ì±….md)

---

## ğŸš€ 7. ì£¼ìš” ë³€ê²½ ì‚¬í•­ ìš”ì•½

### v2.1 (2025-12-30) - Secure Proxy & Multi-SPA

1.  **Secure Proxy Pattern**:
    - Orthanc ì™¸ë¶€ ì§ì ‘ ì ‘ì† ì°¨ë‹¨, Djangoê°€ JWT ê²€ì¦ í›„ Nginxì—ê²Œ ì „ì†¡ ìœ„ì„ (`X-Accel-Redirect`).
    - ë³´ì•ˆ: ëª¨ë“  DICOM ë°ì´í„° ì ‘ê·¼ì´ JWT ì¸ì¦ í†µê³¼.
    - ì„±ëŠ¥: DjangoëŠ” í—¤ë”ë§Œ ë°˜í™˜, Nginxê°€ íŒŒì¼ ì „ì†¡ (Zero-Copy).

2.  **Multi-SPA Build Strategy**:
    - React Main Appê³¼ OHIF Viewerë¥¼ **ë³„ë„ë¡œ ë¹Œë“œ**í•˜ì—¬ ë…ë¦½ì ìœ¼ë¡œ ë°°í¬.
    - ì˜ì¡´ì„± ì¶©ëŒ ë°©ì§€ ë° ìœ ì§€ë³´ìˆ˜ì„± í–¥ìƒ.

3.  **Nginx ë¼ìš°íŒ… êµ¬ì²´í™”**:
    - `/internal-orthanc/*` ë‚´ë¶€ ì „ìš© ë¼ìš°íŠ¸ ì‹ ì„¤.
    - `internal;` ë””ë ‰í‹°ë¸Œë¡œ ì™¸ë¶€ ì§ì ‘ ì ‘ê·¼ ì°¨ë‹¨.

### v2.0 (2025-12-30) - HTJ2K Pipeline

1.  **Celery ì—­í•  í™•ëŒ€**: ì´ë¯¸ì§€ ë³€í™˜ ê³µì¥ (Raw â†’ HTJ2K).
2.  **OHIF ì •ì˜ êµ¬ì²´í™”**: NeuroNova Extension + WASM ë””ì½”ë” í¬í•¨.
3.  **FastAPI ê¸°ëŠ¥ ì¶”ê°€**: HTJ2K ë””ì½”ë”© ì „ì²˜ë¦¬ ë¡œì§ í¬í•¨.

---

**ë¬¸ì„œ ë²„ì „**: v2.1
**ìµœì¢… ìˆ˜ì •**: 2025-12-30
**ì‘ì„±ì**: NeuroNova Development Team
