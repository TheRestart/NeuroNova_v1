# ============================================
# NeuroNova CDSS - Development Environment
# Architecture v2.1 - Secure Proxy & Multi-SPA
# ============================================

networks:
  neuronova_network:
    driver: bridge

volumes:
  # Data Layer Volumes
  cdss_mysql_data:
    driver: local
  openemr_mysql_data:
    driver: local
  redis_data:
    driver: local
  orthanc_data:
    driver: local
  hapi_fhir_data:
    driver: local
  openemr_logs:
    driver: local
  openemr_sites:
    driver: local

services:
  # ============================================
  # 1. Ingress Layer - Nginx (Reverse Proxy)
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: neuronova-nginx-dev
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.dev.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      # Static files (will be created after frontend build)
      - ./static/react-main:/var/www/react-main:ro
      - ./static/ohif-dist:/var/www/ohif-dist:ro
    depends_on:
      django:
        condition: service_healthy
      orthanc:
        condition: service_healthy
    networks:
      - neuronova_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 80 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================
  # 2. Application Layer - Django Backend
  # ============================================
  django:
    build:
      context: ./NeuroNova_02_back_end/02_django_server
      dockerfile: Dockerfile
    container_name: neuronova-django-dev
    command: >
      sh -c "python manage.py migrate --noinput &&
             python manage.py collectstatic --noinput &&
             python manage.py runserver 0.0.0.0:8000"
    volumes:
      # Hot reload - mount source code
      - ./NeuroNova_02_back_end/02_django_server:/app
      - ./static/django-static:/app/staticfiles
    environment:
      # Django Core
      - DJANGO_SETTINGS_MODULE=cdss_backend.settings
      - DEBUG=${DEBUG:-True}
      - ENABLE_SECURITY=${ENABLE_SECURITY:-False}
      - SECRET_KEY=${DJANGO_SECRET_KEY}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-*}

      # Database (CDSS MySQL)
      - DB_ENGINE=${DB_ENGINE}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_HOST=${DB_SERVICE_NAME}
      - DB_PORT=${DB_PORT}

      # Redis & Celery
      - REDIS_HOST=${REDIS_SERVICE_NAME}
      - REDIS_PORT=${REDIS_PORT}
      - CELERY_BROKER_URL=redis://${REDIS_SERVICE_NAME}:${REDIS_PORT}/0
      - CELERY_RESULT_BACKEND=redis://${REDIS_SERVICE_NAME}:${REDIS_PORT}/0

      # External Services
      - ORTHANC_API_URL=http://${ORTHANC_SERVICE_NAME}:${ORTHANC_CONTAINER_PORT_HTTP}
      - ORTHANC_USERNAME=${ORTHANC_USERNAME}
      - ORTHANC_PASSWORD=${ORTHANC_PASSWORD}
      - FHIR_SERVER_URL=http://${FHIR_SERVICE_NAME}:${FHIR_CONTAINER_PORT}/fhir
      - OPENEMR_BASE_URL=http://${OPENEMR_SERVICE_NAME}:${OPENEMR_CONTAINER_PORT_HTTP}

      # JWT Settings
      - JWT_ACCESS_TOKEN_HOURS=${JWT_ACCESS_TOKEN_HOURS:-1}
      - JWT_REFRESH_TOKEN_DAYS=${JWT_REFRESH_TOKEN_DAYS:-7}
    expose:
      - "8000"
    depends_on:
      cdss-mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      orthanc:
        condition: service_healthy
    networks:
      - neuronova_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "python3 -c 'import socket; s=socket.socket(); s.settimeout(1); s.connect((\"127.0.0.1\", 8000))' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ============================================
  # 3. Async Processing Layer - Celery
  # ============================================
  celery-worker:
    build:
      context: ./NeuroNova_02_back_end/02_django_server
      dockerfile: Dockerfile.celery
    container_name: neuronova-celery-worker-dev
    command: celery -A cdss_backend worker -l info --concurrency=4
    volumes:
      - ./NeuroNova_02_back_end/02_django_server:/app
      - ./logs/celery:/app/logs
    environment:
      - DJANGO_SETTINGS_MODULE=cdss_backend.settings
      - DEBUG=${DEBUG:-True}
      - SECRET_KEY=${DJANGO_SECRET_KEY}

      # Database
      - DB_ENGINE=${DB_ENGINE}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_HOST=${DB_SERVICE_NAME}
      - DB_PORT=${DB_PORT}

      # Redis
      - CELERY_BROKER_URL=redis://${REDIS_SERVICE_NAME}:${REDIS_PORT}/0
      - CELERY_RESULT_BACKEND=redis://${REDIS_SERVICE_NAME}:${REDIS_PORT}/0

      # External Services
      - ORTHANC_API_URL=http://${ORTHANC_SERVICE_NAME}:${ORTHANC_CONTAINER_PORT_HTTP}
      - ORTHANC_USERNAME=${ORTHANC_USERNAME}
      - ORTHANC_PASSWORD=${ORTHANC_PASSWORD}
    depends_on:
      redis:
        condition: service_healthy
      cdss-mysql:
        condition: service_healthy
      orthanc:
        condition: service_healthy
    networks:
      - neuronova_network
    restart: unless-stopped

  celery-beat:
    build:
      context: ./NeuroNova_02_back_end/02_django_server
      dockerfile: Dockerfile.celery
    container_name: neuronova-celery-beat-dev
    command: celery -A cdss_backend beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    volumes:
      - ./NeuroNova_02_back_end/02_django_server:/app
      - ./logs/celery:/app/logs
    environment:
      - DJANGO_SETTINGS_MODULE=cdss_backend.settings
      - DEBUG=${DEBUG:-True}
      - SECRET_KEY=${DJANGO_SECRET_KEY}
      - DB_ENGINE=${DB_ENGINE}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_HOST=${DB_SERVICE_NAME}
      - DB_PORT=${DB_PORT}
      - CELERY_BROKER_URL=redis://${REDIS_SERVICE_NAME}:${REDIS_PORT}/0
      - CELERY_RESULT_BACKEND=redis://${REDIS_SERVICE_NAME}:${REDIS_PORT}/0
    depends_on:
      redis:
        condition: service_healthy
      cdss-mysql:
        condition: service_healthy
    networks:
      - neuronova_network
    restart: unless-stopped

  flower:
    build:
      context: ./NeuroNova_02_back_end/02_django_server
      dockerfile: Dockerfile.celery
    container_name: neuronova-flower-dev
    command: celery -A cdss_backend flower --port=5555
    ports:
      - "5555:5555"
    environment:
      - CELERY_BROKER_URL=redis://${REDIS_SERVICE_NAME}:${REDIS_PORT}/0
      - CELERY_RESULT_BACKEND=redis://${REDIS_SERVICE_NAME}:${REDIS_PORT}/0
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - neuronova_network
    restart: unless-stopped

  # ============================================
  # 4. Data Layer - Databases
  # ============================================
  cdss-mysql:
    image: mysql:8.0
    container_name: neuronova-cdss-mysql-dev
    environment:
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
    ports:
      - "${DB_HOST_PORT:-3306}:3306"
    volumes:
      - cdss_mysql_data:/var/lib/mysql
      - ./mysql/init:/docker-entrypoint-initdb.d:ro
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    networks:
      - neuronova_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  redis:
    image: redis:7-alpine
    container_name: neuronova-redis-dev
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    ports:
      - "${REDIS_HOST_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - neuronova_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # 5. Integration Layer - PACS & Medical Data
  # ============================================
  orthanc:
    image: orthancteam/orthanc:latest
    container_name: neuronova-orthanc-dev
    environment:
      - ORTHANC_AUTHENTICATION_ENABLED=${ORTHANC_AUTHENTICATION_ENABLED:-false}
      - ORTHANC_NAME=${ORTHANC_NAME:-NeuroNova Orthanc Dev}
      - ORTHANC__HTTP_VERBOSE=${ORTHANC_HTTP_VERBOSE:-true}
      - ORTHANC__HTTP_CORS_ENABLED=${ORTHANC_HTTP_CORS_ENABLED:-true}
    # Internal only - no external ports in production
    # For development, expose for direct testing
    ports:
      - "${ORTHANC_HOST_PORT_HTTP:-8042}:8042"
      - "${ORTHANC_HOST_PORT_DICOM:-4242}:4242"
    volumes:
      - orthanc_data:/var/lib/orthanc/db
      - ./NeuroNova_02_back_end/05_orthanc_pacs/orthanc.json:/etc/orthanc/orthanc.json:ro
    networks:
      - neuronova_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "python3 -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:8042/system\")' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  openemr-mysql:
    image: mariadb:11.8
    container_name: neuronova-openemr-mysql-dev
    command: ['mariadbd', '--character-set-server=utf8mb4']
    environment:
      MYSQL_ROOT_PASSWORD: ${OPENEMR_DB_ROOT_PASSWORD}
    ports:
      - "${OPENEMR_DB_HOST_PORT:-3307}:3306"
    volumes:
      - openemr_mysql_data:/var/lib/mysql
    networks:
      - neuronova_network
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - /usr/local/bin/healthcheck.sh
        - --su-mysql
        - --connect
        - --innodb_initialized
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 60s

  openemr:
    image: openemr/openemr:7.0.3
    container_name: neuronova-openemr-dev
    ports:
      - "${OPENEMR_HOST_PORT_HTTP:-8081}:80"
      - "${OPENEMR_HOST_PORT_HTTPS:-4443}:443"
    volumes:
      - openemr_logs:/var/log
      - openemr_sites:/var/www/localhost/htdocs/openemr/sites
    environment:
      MYSQL_HOST: ${OPENEMR_DB_SERVICE_NAME}
      MYSQL_ROOT_PASS: ${OPENEMR_DB_ROOT_PASSWORD}
      MYSQL_USER: ${OPENEMR_DB_USER}
      MYSQL_PASS: ${OPENEMR_DB_PASSWORD}
      OE_USER: ${OPENEMR_OE_USER}
      OE_PASS: ${OPENEMR_OE_PASS}
    depends_on:
      openemr-mysql:
        condition: service_healthy
    networks:
      - neuronova_network
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - /usr/bin/curl
        - --fail
        - --insecure
        - --silent
        - https://localhost/
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 180s

  hapi-fhir:
    image: hapiproject/hapi:latest
    container_name: neuronova-hapi-fhir-dev
    environment:
      - hapi.fhir.fhir_version=${FHIR_VERSION:-R4}
      - hapi.fhir.allow_multiple_delete=${FHIR_ALLOW_MULTIPLE_DELETE:-true}
      - hapi.fhir.allow_cascading_deletes=${FHIR_ALLOW_CASCADING_DELETES:-true}
      - hapi.fhir.reuse_cached_search_results_millis=${FHIR_REUSE_CACHED_SEARCH_RESULTS_MILLIS:--1}
    ports:
      - "${FHIR_HOST_PORT:-8080}:8080"
    volumes:
      - hapi_fhir_data:/data/hapi
    networks:
      - neuronova_network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "timeout 5 bash -c '</dev/tcp/localhost/8080' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # ============================================
  # 6. Development Tools (Optional)
  # ============================================
  # Uncomment for database GUI access
  # phpmyadmin:
  #   image: phpmyadmin:latest
  #   container_name: neuronova-phpmyadmin-dev
  #   environment:
  #     PMA_HOSTS: cdss-mysql,openemr-mysql
  #     PMA_PORTS: 3306,3306
  #   ports:
  #     - "8090:80"
  #   depends_on:
  #     - cdss-mysql
  #     - openemr-mysql
  #   networks:
  #     - neuronova_network
  #   restart: unless-stopped
