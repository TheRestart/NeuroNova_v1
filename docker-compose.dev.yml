# ============================================
# NeuroNova CDSS - Development Environment
# Architecture v2.1 - Secure Proxy & Multi-SPA
# ============================================
#
# 최종 업데이트: 2026-01-02
# 버전: 2.1
#
# 시스템 구성:
#   - 총 14개 컨테이너 (Production-ready 아키텍처)
#   - 7개 레이어: Ingress, Application, Async, Data, Integration, Observability, DevTools
#
# 컨테이너 목록:
#   1. nginx (Reverse Proxy & Static Serving)
#   2. django (REST API Server)
#   3. celery-worker (비동기 작업 처리 - AI 추론)
#   4. celery-beat (스케줄러 - FHIR 동기화, 데이터 정리)
#   5. flower (Celery 모니터링 UI)
#   6. cdss-mysql (Django 데이터베이스)
#   7. redis (캐시 & 메시지 브로커)
#   8. orthanc (DICOM PACS - 의료 영상 저장소)
#   9. openemr-mysql (OpenEMR 데이터베이스)
#   10. openemr (EMR 시스템)
#   11. hapi-fhir (FHIR R4 서버)
#   12. prometheus (메트릭 수집)
#   13. grafana (모니터링 대시보드)
#   14. alertmanager (알림 관리)
#
# 빠른 시작:
#   docker-compose -f docker-compose.dev.yml up -d
#   또는 start-all-services.bat 실행 (Windows)
#
# 서비스 확인:
#   docker-compose -f docker-compose.dev.yml ps
#
# 로그 확인:
#   docker-compose -f docker-compose.dev.yml logs -f [service-name]
#
# 서비스 중지:
#   docker-compose -f docker-compose.dev.yml down
#
# 주요 포트:
#   - 80: Nginx (React SPA + Django API)
#   - 3001: React Dev Server (WSL에서 별도 실행)
#   - 3002: Grafana (모니터링 대시보드)
#   - 5555: Flower (Celery 모니터링)
#   - 8042: Orthanc PACS (DICOM)
#   - 8080: HAPI FHIR (FHIR R4)
#   - 8081: OpenEMR (EMR 시스템)
#   - 9090: Prometheus (메트릭)
#   - 9093: Alertmanager (알림)
#
# 보안 참고:
#   - 프로덕션 환경에서는 외부 포트 노출 최소화 필요
#   - .env 파일 필수 (Git에 커밋 금지)
#   - DEBUG=False, ENABLE_SECURITY=True 설정
#
# 관련 문서:
#   - README_자동실행.md: Windows 자동 시작 가이드
#   - 01_doc/12_GCP_배포_가이드.md: 프로덕션 배포 가이드
#   - 01_doc/초기_데이터_시딩_가이드.md: 데이터 초기화 가이드
#
# ============================================

networks:
  neuronova_network:
    driver: bridge

volumes:
  # Data Layer Volumes
  cdss_mysql_data:
    driver: local
  openemr_mysql_data:
    driver: local
  redis_data:
    driver: local
  orthanc_data:
    driver: local
  hapi_fhir_data:
    driver: local
  openemr_logs:
    driver: local
  openemr_sites:
    driver: local

  # Monitoring Layer Volumes
  prometheus_data:
    driver: local
  grafana_data:
    driver: local
  alertmanager_data:
    driver: local

services:
  # ============================================
  # 1. Ingress Layer - Nginx (Reverse Proxy)
  # ============================================
  nginx:
    image: nginx:alpine
    container_name: neuronova-nginx-dev
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.dev.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      # Static files (will be created after frontend build)
      - ./static/react-main:/var/www/react-main:ro
      - ./static/ohif-dist:/var/www/ohif-dist:ro
    depends_on:
      django:
        condition: service_healthy
      orthanc:
        condition: service_healthy
    networks:
      - neuronova_network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "-qO-", "http://localhost/api/acct/login/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ============================================
  # 2. Application Layer - Django Backend
  # ============================================
  django:
    build:
      context: ./NeuroNova_02_back_end/02_django_server
      dockerfile: Dockerfile
    container_name: neuronova-django-dev
    command: >
      sh -c "python manage.py migrate --noinput &&
             python manage.py collectstatic --noinput &&
             python manage.py runserver 0.0.0.0:8000"
    volumes:
      # Hot reload - mount source code
      - ./NeuroNova_02_back_end/02_django_server:/app
      - ./static/django-static:/app/staticfiles
      - ./sample_dicoms:/sample_dicoms
    environment:
      # Django Core
      - DJANGO_SETTINGS_MODULE=cdss_backend.settings
      - DEBUG=${DEBUG:-True}
      - ENABLE_SECURITY=${ENABLE_SECURITY:-False}
      - SECRET_KEY=${DJANGO_SECRET_KEY}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-*}

      # Database (CDSS MySQL)
      - DB_ENGINE=${DB_ENGINE}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_HOST=${DB_SERVICE_NAME}
      - DB_PORT=${DB_PORT}

      # Redis & Celery
      - REDIS_HOST=${REDIS_SERVICE_NAME}
      - REDIS_PORT=${REDIS_PORT}
      - CELERY_BROKER_URL=redis://${REDIS_SERVICE_NAME}:${REDIS_PORT}/0
      - CELERY_RESULT_BACKEND=redis://${REDIS_SERVICE_NAME}:${REDIS_PORT}/0

      # External Services
      - ORTHANC_API_URL=http://${ORTHANC_SERVICE_NAME}:${ORTHANC_CONTAINER_PORT_HTTP}
      - ORTHANC_USERNAME=${ORTHANC_USERNAME:-admin}
      - ORTHANC_PASSWORD=${ORTHANC_PASSWORD:-admin123}
      - FHIR_SERVER_URL=http://${FHIR_SERVICE_NAME}:${FHIR_CONTAINER_PORT}/fhir
      - OPENEMR_BASE_URL=http://${OPENEMR_SERVICE_NAME}:${OPENEMR_CONTAINER_PORT_HTTP}

      # JWT Settings
      - JWT_ACCESS_TOKEN_HOURS=${JWT_ACCESS_TOKEN_HOURS:-1}
      - JWT_REFRESH_TOKEN_DAYS=${JWT_REFRESH_TOKEN_DAYS:-7}
    expose:
      - "8000"
    depends_on:
      cdss-mysql:
        condition: service_healthy
      redis:
        condition: service_healthy
      orthanc:
        condition: service_healthy
    networks:
      - neuronova_network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "python3 -c 'import socket; s=socket.socket(); s.settimeout(1); s.connect((\"127.0.0.1\", 8000))' || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ============================================
  # 3. Async Processing Layer - Celery
  # ============================================
  celery-worker:
    build:
      context: ./NeuroNova_02_back_end/02_django_server
      dockerfile: Dockerfile.celery
    container_name: neuronova-celery-worker-dev
    command: celery -A cdss_backend worker -l info --concurrency=4
    volumes:
      - ./NeuroNova_02_back_end/02_django_server:/app
      - ./logs/celery:/app/logs
    environment:
      - DJANGO_SETTINGS_MODULE=cdss_backend.settings
      - DEBUG=${DEBUG:-True}
      - SECRET_KEY=${DJANGO_SECRET_KEY}

      # Database
      - DB_ENGINE=${DB_ENGINE}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_HOST=${DB_SERVICE_NAME}
      - DB_PORT=${DB_PORT}

      # Redis
      - CELERY_BROKER_URL=redis://${REDIS_SERVICE_NAME}:${REDIS_PORT}/0
      - CELERY_RESULT_BACKEND=redis://${REDIS_SERVICE_NAME}:${REDIS_PORT}/0

      # External Services
      - ORTHANC_API_URL=http://${ORTHANC_SERVICE_NAME}:${ORTHANC_CONTAINER_PORT_HTTP}
      - ORTHANC_USERNAME=${ORTHANC_USERNAME}
      - ORTHANC_PASSWORD=${ORTHANC_PASSWORD}
    depends_on:
      redis:
        condition: service_healthy
      cdss-mysql:
        condition: service_healthy
      orthanc:
        condition: service_healthy
    networks:
      - neuronova_network
    restart: unless-stopped

  celery-beat:
    build:
      context: ./NeuroNova_02_back_end/02_django_server
      dockerfile: Dockerfile.celery
    container_name: neuronova-celery-beat-dev
    command: celery -A cdss_backend beat -l info --scheduler django_celery_beat.schedulers:DatabaseScheduler
    volumes:
      - ./NeuroNova_02_back_end/02_django_server:/app
      - ./logs/celery:/app/logs
    environment:
      - DJANGO_SETTINGS_MODULE=cdss_backend.settings
      - DEBUG=${DEBUG:-True}
      - SECRET_KEY=${DJANGO_SECRET_KEY}
      - DB_ENGINE=${DB_ENGINE}
      - DB_NAME=${DB_NAME}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_HOST=${DB_SERVICE_NAME}
      - DB_PORT=${DB_PORT}
      - CELERY_BROKER_URL=redis://${REDIS_SERVICE_NAME}:${REDIS_PORT}/0
      - CELERY_RESULT_BACKEND=redis://${REDIS_SERVICE_NAME}:${REDIS_PORT}/0
    depends_on:
      redis:
        condition: service_healthy
      cdss-mysql:
        condition: service_healthy
    networks:
      - neuronova_network
    restart: unless-stopped

  flower:
    # Celery Monitoring UI
    # 접속: http://localhost:5555
    # 실시간 작업 상태, Worker 상태, Task 히스토리 확인 가능
    build:
      context: ./NeuroNova_02_back_end/02_django_server
      dockerfile: Dockerfile.celery
    container_name: neuronova-flower-dev
    command: celery -A cdss_backend flower --port=5555
    ports:
      - "5555:5555"
    environment:
      - CELERY_BROKER_URL=redis://${REDIS_SERVICE_NAME}:${REDIS_PORT}/0
      - CELERY_RESULT_BACKEND=redis://${REDIS_SERVICE_NAME}:${REDIS_PORT}/0
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - neuronova_network
    restart: unless-stopped

  # ============================================
  # 4. Data Layer - Databases
  # ============================================
  cdss-mysql:
    # Django 메인 데이터베이스
    # 저장 내용: 환자, 진료 기록, RIS, LIS, AI 분석 결과 등
    # 접속: mysql -h localhost -P 3306 -u cdss_user -p
    image: mysql:8.0
    container_name: neuronova-cdss-mysql-dev
    environment:
      MYSQL_DATABASE: ${DB_NAME}
      MYSQL_USER: ${DB_USER}
      MYSQL_PASSWORD: ${DB_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${DB_ROOT_PASSWORD}
    ports:
      - "${DB_HOST_PORT:-3306}:3306"
    volumes:
      - cdss_mysql_data:/var/lib/mysql
      - ./mysql/init:/docker-entrypoint-initdb.d:ro
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    networks:
      - neuronova_network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p${DB_ROOT_PASSWORD}" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  redis:
    # 캐시 & 메시지 브로커
    # 용도: Django 캐시, Celery Queue, 세션 저장소
    # 접속: redis-cli -h localhost -p 6379
    image: redis:7-alpine
    container_name: neuronova-redis-dev
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    ports:
      - "${REDIS_HOST_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - neuronova_network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "redis-cli", "ping" ]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================
  # 5. Integration Layer - PACS & Medical Data
  # ============================================
  orthanc:
    # DICOM PACS 서버
    # 저장 내용: CT, MRI, X-Ray 등 의료 영상 데이터 (DICOM 포맷)
    # 접속: http://localhost:8042 (Web UI)
    # DICOM 송수신: localhost:4242 (DICOM C-STORE)
    # DICOMweb API: http://localhost:8042/dicom-web
    image: orthancteam/orthanc:latest
    container_name: neuronova-orthanc-dev
    environment:
      - ORTHANC_AUTHENTICATION_ENABLED=${ORTHANC_AUTHENTICATION_ENABLED:-false}
      - ORTHANC_NAME=${ORTHANC_NAME:-NeuroNova Orthanc Dev}
      - ORTHANC__HTTP_VERBOSE=${ORTHANC_HTTP_VERBOSE:-true}
      - ORTHANC__HTTP_CORS_ENABLED=${ORTHANC_HTTP_CORS_ENABLED:-true}
    # 개발 환경: 직접 접근 허용
    # 프로덕션: Django Proxy를 통해서만 접근 (expose로 변경)
    ports:
      - "${ORTHANC_HOST_PORT_HTTP:-8042}:8042"
      - "${ORTHANC_HOST_PORT_DICOM:-4242}:4242"
    volumes:
      - orthanc_data:/var/lib/orthanc/db
      - ./NeuroNova_02_back_end/05_orthanc_pacs/orthanc.json:/etc/orthanc/orthanc.json:ro
    networks:
      - neuronova_network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "python3 -c 'import urllib.request; urllib.request.urlopen(\"http://localhost:8042/system\")' || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  openemr-mysql:
    image: mariadb:11.8
    container_name: neuronova-openemr-mysql-dev
    command: [ 'mariadbd', '--character-set-server=utf8mb4' ]
    environment:
      MYSQL_ROOT_PASSWORD: ${OPENEMR_DB_ROOT_PASSWORD}
    ports:
      - "${OPENEMR_DB_HOST_PORT:-3307}:3306"
    volumes:
      - openemr_mysql_data:/var/lib/mysql
    networks:
      - neuronova_network
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - /usr/local/bin/healthcheck.sh
        - --su-mysql
        - --connect
        - --innodb_initialized
      interval: 30s
      timeout: 5s
      retries: 5
      start_period: 60s

  openemr:
    # OpenEMR - 전자의무기록(EMR) 시스템
    # 접속: http://localhost:8081
    # 로그인: admin / admin123
    # FHIR API: http://localhost:8081/apis/default/fhir
    # 참고: OAuth2 client_credentials 미지원으로 SKIP_OPENEMR_INTEGRATION=True 설정 필요
    image: openemr/openemr:7.0.3
    container_name: neuronova-openemr-dev
    ports:
      - "${OPENEMR_HOST_PORT_HTTP:-8081}:80"
      - "${OPENEMR_HOST_PORT_HTTPS:-4443}:443"
    volumes:
      - openemr_logs:/var/log
      - openemr_sites:/var/www/localhost/htdocs/openemr/sites
    environment:
      MYSQL_HOST: ${OPENEMR_DB_SERVICE_NAME}
      MYSQL_ROOT_PASS: ${OPENEMR_DB_ROOT_PASSWORD}
      MYSQL_USER: ${OPENEMR_DB_USER}
      MYSQL_PASS: ${OPENEMR_DB_PASSWORD}
      OE_USER: ${OPENEMR_OE_USER:-admin}
      OE_PASS: ${OPENEMR_OE_PASS:-admin123}
    depends_on:
      openemr-mysql:
        condition: service_healthy
    networks:
      - neuronova_network
    restart: unless-stopped
    healthcheck:
      test:
        - CMD
        - /usr/bin/curl
        - --fail
        - --insecure
        - --silent
        - https://localhost/
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 180s

  hapi-fhir:
    image: hapiproject/hapi:latest
    container_name: neuronova-hapi-fhir-dev
    environment:
      - hapi.fhir.fhir_version=${FHIR_VERSION:-R4}
      - hapi.fhir.allow_multiple_delete=${FHIR_ALLOW_MULTIPLE_DELETE:-true}
      - hapi.fhir.allow_cascading_deletes=${FHIR_ALLOW_CASCADING_DELETES:-true}
      - hapi.fhir.reuse_cached_search_results_millis=${FHIR_REUSE_CACHED_SEARCH_RESULTS_MILLIS:--1}
    ports:
      - "${FHIR_HOST_PORT:-8080}:8080"
    volumes:
      - hapi_fhir_data:/data/hapi
    networks:
      - neuronova_network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/fhir/metadata" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 90s

  # ============================================
  # 6. Observability Layer - Monitoring & Alerting
  # ============================================
  prometheus:
    image: prom/prometheus:latest
    container_name: neuronova-prometheus-dev
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/usr/share/prometheus/console_libraries'
      - '--web.console.templates=/usr/share/prometheus/consoles'
      - '--web.enable-lifecycle'
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./monitoring/prometheus/alerts:/etc/prometheus/alerts:ro
      - prometheus_data:/prometheus
    networks:
      - neuronova_network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9090/-/healthy" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  grafana:
    image: grafana/grafana:latest
    container_name: neuronova-grafana-dev
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD:-admin123}
      - GF_SERVER_ROOT_URL=http://localhost:3000
      - GF_INSTALL_PLUGINS=redis-datasource,grafana-clock-panel,grafana-simple-json-datasource
    ports:
      - "3002:3000"
    volumes:
      - ./monitoring/grafana/provisioning:/etc/grafana/provisioning:ro
      - ./monitoring/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana_data:/var/lib/grafana
    depends_on:
      prometheus:
        condition: service_healthy
    networks:
      - neuronova_network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD-SHELL", "wget --quiet --tries=1 --spider http://localhost:3000/api/health || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  alertmanager:
    image: prom/alertmanager:latest
    container_name: neuronova-alertmanager-dev
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
    ports:
      - "9093:9093"
    volumes:
      - ./monitoring/alertmanager/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager_data:/alertmanager
    networks:
      - neuronova_network
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:9093/-/healthy" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
  # ============================================
  # 7. Development Tools (Optional)
  # ============================================
  # Uncomment for database GUI access
  # phpmyadmin:
  #   image: phpmyadmin:latest
  #   container_name: neuronova-phpmyadmin-dev
  #   environment:
  #     PMA_HOSTS: cdss-mysql,openemr-mysql
  #     PMA_PORTS: 3306,3306
  #   ports:
  #     - "8090:80"
  #   depends_on:
  #     - cdss-mysql
  #     - openemr-mysql
  #   networks:
  #     - neuronova_network
  #   restart: unless-stopped
